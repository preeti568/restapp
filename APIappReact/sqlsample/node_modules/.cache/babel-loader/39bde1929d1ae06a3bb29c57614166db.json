{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\n\nvar _crypto = _interopRequireDefault(require(\"crypto\"));\n\nvar _os = _interopRequireDefault(require(\"os\"));\n\nvar _constants = _interopRequireDefault(require(\"constants\"));\n\nvar _tls = require(\"tls\");\n\nvar _msRestNodeauth = require(\"@azure/ms-rest-nodeauth\");\n\nvar _bulkLoad = _interopRequireDefault(require(\"./bulk-load\"));\n\nvar _debug = _interopRequireDefault(require(\"./debug\"));\n\nvar _events = require(\"events\");\n\nvar _instanceLookup = require(\"./instance-lookup\");\n\nvar _transientErrorLookup = require(\"./transient-error-lookup\");\n\nvar _packet = require(\"./packet\");\n\nvar _preloginPayload = _interopRequireDefault(require(\"./prelogin-payload\"));\n\nvar _login7Payload = _interopRequireDefault(require(\"./login7-payload\"));\n\nvar _ntlmPayload = _interopRequireDefault(require(\"./ntlm-payload\"));\n\nvar _request = _interopRequireDefault(require(\"./request\"));\n\nvar _rpcrequestPayload = _interopRequireDefault(require(\"./rpcrequest-payload\"));\n\nvar _sqlbatchPayload = _interopRequireDefault(require(\"./sqlbatch-payload\"));\n\nvar _messageIo = _interopRequireDefault(require(\"./message-io\"));\n\nvar _tokenStreamParser = require(\"./token/token-stream-parser\");\n\nvar _transaction = require(\"./transaction\");\n\nvar _errors = require(\"./errors\");\n\nvar _connector = require(\"./connector\");\n\nvar _library = require(\"./library\");\n\nvar _tdsVersions = require(\"./tds-versions\");\n\nvar _ntlm = require(\"./ntlm\");\n\nvar _depd = _interopRequireDefault(require(\"depd\"));\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nconst deprecate = (0, _depd.default)('tedious'); // A rather basic state machine for managing a connection.\n// Implements something approximating s3.2.1.\n\nconst KEEP_ALIVE_INITIAL_DELAY = 30 * 1000;\nconst DEFAULT_CONNECT_TIMEOUT = 15 * 1000;\nconst DEFAULT_CLIENT_REQUEST_TIMEOUT = 15 * 1000;\nconst DEFAULT_CANCEL_TIMEOUT = 5 * 1000;\nconst DEFAULT_CONNECT_RETRY_INTERVAL = 500;\nconst DEFAULT_PACKET_SIZE = 4 * 1024;\nconst DEFAULT_TEXTSIZE = '2147483647';\nconst DEFAULT_DATEFIRST = 7;\nconst DEFAULT_PORT = 1433;\nconst DEFAULT_TDS_VERSION = '7_4';\nconst DEFAULT_LANGUAGE = 'us_english';\nconst DEFAULT_DATEFORMAT = 'mdy';\nconst CLEANUP_TYPE = {\n  NORMAL: 0,\n  REDIRECT: 1,\n  RETRY: 2\n};\n\nclass Connection extends _events.EventEmitter {\n  constructor(config) {\n    super();\n    this.fedAuthRequired = void 0;\n    this.fedAuthInfoToken = void 0;\n    this.config = void 0;\n    this.secureContext = void 0;\n    this.inTransaction = void 0;\n    this.transactionDescriptors = void 0;\n    this.transactionDepth = void 0;\n    this.isSqlBatch = void 0;\n    this.curTransientRetryCount = void 0;\n    this.transientErrorLookup = void 0;\n    this.closed = void 0;\n    this.loggedIn = void 0;\n    this.loginError = void 0;\n    this.debug = void 0;\n    this.tokenStreamParser = void 0;\n    this.ntlmpacket = void 0;\n    this.ntlmpacketBuffer = void 0;\n    this.routingData = void 0;\n    this.state = void 0;\n    this.resetConnectionOnNextRequest = void 0;\n    this.attentionReceived = void 0;\n    this.request = void 0;\n    this.procReturnStatusValue = void 0;\n    this.socket = void 0;\n    this.messageBuffer = void 0;\n    this.connectTimer = void 0;\n    this.cancelTimer = void 0;\n    this.requestTimer = void 0;\n    this.retryTimer = void 0;\n\n    if (typeof config !== 'object' || config === null) {\n      throw new TypeError('The \"config\" argument is required and must be of type Object.');\n    }\n\n    if (typeof config.server !== 'string') {\n      throw new TypeError('The \"config.server\" property is required and must be of type string.');\n    }\n\n    this.fedAuthRequired = false;\n    this.fedAuthInfoToken = undefined;\n    let authentication;\n\n    if (config.authentication !== undefined) {\n      if (typeof config.authentication !== 'object' || config.authentication === null) {\n        throw new TypeError('The \"config.authentication\" property must be of type Object.');\n      }\n\n      const type = config.authentication.type;\n      const options = config.authentication.options === undefined ? {} : config.authentication.options;\n\n      if (typeof type !== 'string') {\n        throw new TypeError('The \"config.authentication.type\" property must be of type string.');\n      }\n\n      if (type !== 'default' && type !== 'ntlm' && type !== 'azure-active-directory-password' && type !== 'azure-active-directory-access-token' && type !== 'azure-active-directory-msi-vm' && type !== 'azure-active-directory-msi-app-service' && type !== 'azure-active-directory-service-principal-secret') {\n        throw new TypeError('The \"type\" property must one of \"default\", \"ntlm\", \"azure-active-directory-password\", \"azure-active-directory-access-token\", \"azure-active-directory-msi-vm\" or \"azure-active-directory-msi-app-service\" or \"azure-active-directory-service-principal-secret\".');\n      }\n\n      if (typeof options !== 'object' || options === null) {\n        throw new TypeError('The \"config.authentication.options\" property must be of type object.');\n      }\n\n      if (type === 'ntlm') {\n        if (typeof options.domain !== 'string') {\n          throw new TypeError('The \"config.authentication.options.domain\" property must be of type string.');\n        }\n\n        if (options.userName !== undefined && typeof options.userName !== 'string') {\n          throw new TypeError('The \"config.authentication.options.userName\" property must be of type string.');\n        }\n\n        if (options.password !== undefined && typeof options.password !== 'string') {\n          throw new TypeError('The \"config.authentication.options.password\" property must be of type string.');\n        }\n\n        authentication = {\n          type: 'ntlm',\n          options: {\n            userName: options.userName,\n            password: options.password,\n            domain: options.domain && options.domain.toUpperCase()\n          }\n        };\n      } else if (type === 'azure-active-directory-password') {\n        if (options.userName !== undefined && typeof options.userName !== 'string') {\n          throw new TypeError('The \"config.authentication.options.userName\" property must be of type string.');\n        }\n\n        if (options.password !== undefined && typeof options.password !== 'string') {\n          throw new TypeError('The \"config.authentication.options.password\" property must be of type string.');\n        }\n\n        authentication = {\n          type: 'azure-active-directory-password',\n          options: {\n            userName: options.userName,\n            password: options.password\n          }\n        };\n      } else if (type === 'azure-active-directory-access-token') {\n        if (typeof options.token !== 'string') {\n          throw new TypeError('The \"config.authentication.options.token\" property must be of type string.');\n        }\n\n        authentication = {\n          type: 'azure-active-directory-access-token',\n          options: {\n            token: options.token\n          }\n        };\n      } else if (type === 'azure-active-directory-msi-vm') {\n        if (options.clientId !== undefined && typeof options.clientId !== 'string') {\n          throw new TypeError('The \"config.authentication.options.clientId\" property must be of type string.');\n        }\n\n        if (options.msiEndpoint !== undefined && typeof options.msiEndpoint !== 'string') {\n          throw new TypeError('The \"config.authentication.options.msiEndpoint\" property must be of type string.');\n        }\n\n        authentication = {\n          type: 'azure-active-directory-msi-vm',\n          options: {\n            clientId: options.clientId,\n            msiEndpoint: options.msiEndpoint\n          }\n        };\n      } else if (type === 'azure-active-directory-msi-app-service') {\n        if (options.clientId !== undefined && typeof options.clientId !== 'string') {\n          throw new TypeError('The \"config.authentication.options.clientId\" property must be of type string.');\n        }\n\n        if (options.msiEndpoint !== undefined && typeof options.msiEndpoint !== 'string') {\n          throw new TypeError('The \"config.authentication.options.msiEndpoint\" property must be of type string.');\n        }\n\n        if (options.msiSecret !== undefined && typeof options.msiSecret !== 'string') {\n          throw new TypeError('The \"config.authentication.options.msiSecret\" property must be of type string.');\n        }\n\n        authentication = {\n          type: 'azure-active-directory-msi-app-service',\n          options: {\n            clientId: options.clientId,\n            msiEndpoint: options.msiEndpoint,\n            msiSecret: options.msiSecret\n          }\n        };\n      } else if (type === 'azure-active-directory-service-principal-secret') {\n        if (typeof options.clientId !== 'string') {\n          throw new TypeError('The \"config.authentication.options.clientId\" property must be of type string.');\n        }\n\n        if (typeof options.clientSecret !== 'string') {\n          throw new TypeError('The \"config.authentication.options.clientSecret\" property must be of type string.');\n        }\n\n        if (typeof options.tenantId !== 'string') {\n          throw new TypeError('The \"config.authentication.options.tenantId\" property must be of type string.');\n        }\n\n        authentication = {\n          type: 'azure-active-directory-service-principal-secret',\n          options: {\n            clientId: options.clientId,\n            clientSecret: options.clientSecret,\n            tenantId: options.tenantId\n          }\n        };\n      } else {\n        if (options.userName !== undefined && typeof options.userName !== 'string') {\n          throw new TypeError('The \"config.authentication.options.userName\" property must be of type string.');\n        }\n\n        if (options.password !== undefined && typeof options.password !== 'string') {\n          throw new TypeError('The \"config.authentication.options.password\" property must be of type string.');\n        }\n\n        authentication = {\n          type: 'default',\n          options: {\n            userName: options.userName,\n            password: options.password\n          }\n        };\n      }\n    } else {\n      authentication = {\n        type: 'default',\n        options: {\n          userName: undefined,\n          password: undefined\n        }\n      };\n    }\n\n    this.config = {\n      server: config.server,\n      authentication: authentication,\n      options: {\n        abortTransactionOnError: false,\n        appName: undefined,\n        camelCaseColumns: false,\n        cancelTimeout: DEFAULT_CANCEL_TIMEOUT,\n        columnNameReplacer: undefined,\n        connectionRetryInterval: DEFAULT_CONNECT_RETRY_INTERVAL,\n        connectTimeout: DEFAULT_CONNECT_TIMEOUT,\n        connectionIsolationLevel: _transaction.ISOLATION_LEVEL.READ_COMMITTED,\n        cryptoCredentialsDetails: {},\n        database: undefined,\n        datefirst: DEFAULT_DATEFIRST,\n        dateFormat: DEFAULT_DATEFORMAT,\n        debug: {\n          data: false,\n          packet: false,\n          payload: false,\n          token: false\n        },\n        enableAnsiNull: true,\n        enableAnsiNullDefault: true,\n        enableAnsiPadding: true,\n        enableAnsiWarnings: true,\n        enableArithAbort: false,\n        enableConcatNullYieldsNull: true,\n        enableCursorCloseOnCommit: null,\n        enableImplicitTransactions: false,\n        enableNumericRoundabort: false,\n        enableQuotedIdentifier: true,\n        encrypt: true,\n        fallbackToDefaultDb: false,\n        instanceName: undefined,\n        isolationLevel: _transaction.ISOLATION_LEVEL.READ_COMMITTED,\n        language: DEFAULT_LANGUAGE,\n        localAddress: undefined,\n        maxRetriesOnTransientErrors: 3,\n        multiSubnetFailover: false,\n        packetSize: DEFAULT_PACKET_SIZE,\n        port: DEFAULT_PORT,\n        readOnlyIntent: false,\n        requestTimeout: DEFAULT_CLIENT_REQUEST_TIMEOUT,\n        rowCollectionOnDone: false,\n        rowCollectionOnRequestCompletion: false,\n        tdsVersion: DEFAULT_TDS_VERSION,\n        textsize: DEFAULT_TEXTSIZE,\n        trustServerCertificate: true,\n        useColumnNames: false,\n        useUTC: true,\n        lowerCaseGuids: false\n      }\n    };\n\n    if (config.options) {\n      if (config.options.port && config.options.instanceName) {\n        throw new Error('Port and instanceName are mutually exclusive, but ' + config.options.port + ' and ' + config.options.instanceName + ' provided');\n      }\n\n      if (config.options.abortTransactionOnError !== undefined) {\n        if (typeof config.options.abortTransactionOnError !== 'boolean' && config.options.abortTransactionOnError !== null) {\n          throw new TypeError('The \"config.options.abortTransactionOnError\" property must be of type string or null.');\n        }\n\n        this.config.options.abortTransactionOnError = config.options.abortTransactionOnError;\n      }\n\n      if (config.options.appName !== undefined) {\n        if (typeof config.options.appName !== 'string') {\n          throw new TypeError('The \"config.options.appName\" property must be of type string.');\n        }\n\n        this.config.options.appName = config.options.appName;\n      }\n\n      if (config.options.camelCaseColumns !== undefined) {\n        if (typeof config.options.camelCaseColumns !== 'boolean') {\n          throw new TypeError('The \"config.options.camelCaseColumns\" property must be of type boolean.');\n        }\n\n        this.config.options.camelCaseColumns = config.options.camelCaseColumns;\n      }\n\n      if (config.options.cancelTimeout !== undefined) {\n        if (typeof config.options.cancelTimeout !== 'number') {\n          throw new TypeError('The \"config.options.cancelTimeout\" property must be of type number.');\n        }\n\n        this.config.options.cancelTimeout = config.options.cancelTimeout;\n      }\n\n      if (config.options.columnNameReplacer) {\n        if (typeof config.options.columnNameReplacer !== 'function') {\n          throw new TypeError('The \"config.options.cancelTimeout\" property must be of type function.');\n        }\n\n        this.config.options.columnNameReplacer = config.options.columnNameReplacer;\n      }\n\n      if (config.options.connectTimeout !== undefined) {\n        if (typeof config.options.connectTimeout !== 'number') {\n          throw new TypeError('The \"config.options.connectTimeout\" property must be of type number.');\n        }\n\n        this.config.options.connectTimeout = config.options.connectTimeout;\n      }\n\n      if (config.options.connectionIsolationLevel !== undefined) {\n        this.config.options.connectionIsolationLevel = config.options.connectionIsolationLevel;\n      }\n\n      if (config.options.connectTimeout !== undefined) {\n        if (typeof config.options.connectTimeout !== 'number') {\n          throw new TypeError('The \"config.options.connectTimeout\" property must be of type number.');\n        }\n\n        this.config.options.connectTimeout = config.options.connectTimeout;\n      }\n\n      if (config.options.cryptoCredentialsDetails !== undefined) {\n        if (typeof config.options.cryptoCredentialsDetails !== 'object' || config.options.cryptoCredentialsDetails === null) {\n          throw new TypeError('The \"config.options.cryptoCredentialsDetails\" property must be of type Object.');\n        }\n\n        this.config.options.cryptoCredentialsDetails = config.options.cryptoCredentialsDetails;\n      }\n\n      if (config.options.database !== undefined) {\n        if (typeof config.options.database !== 'string') {\n          throw new TypeError('The \"config.options.database\" property must be of type string.');\n        }\n\n        this.config.options.database = config.options.database;\n      }\n\n      if (config.options.datefirst !== undefined) {\n        if (typeof config.options.datefirst !== 'number' && config.options.datefirst !== null) {\n          throw new TypeError('The \"config.options.datefirst\" property must be of type number.');\n        }\n\n        if (config.options.datefirst !== null && (config.options.datefirst < 1 || config.options.datefirst > 7)) {\n          throw new RangeError('The \"config.options.datefirst\" property must be >= 1 and <= 7');\n        }\n\n        this.config.options.datefirst = config.options.datefirst;\n      }\n\n      if (config.options.dateFormat !== undefined) {\n        if (typeof config.options.dateFormat !== 'string' && config.options.dateFormat !== null) {\n          throw new TypeError('The \"config.options.dateFormat\" property must be of type string or null.');\n        }\n\n        this.config.options.dateFormat = config.options.dateFormat;\n      }\n\n      if (config.options.debug) {\n        if (config.options.debug.data !== undefined) {\n          if (typeof config.options.debug.data !== 'boolean') {\n            throw new TypeError('The \"config.options.debug.data\" property must be of type boolean.');\n          }\n\n          this.config.options.debug.data = config.options.debug.data;\n        }\n\n        if (config.options.debug.packet !== undefined) {\n          if (typeof config.options.debug.packet !== 'boolean') {\n            throw new TypeError('The \"config.options.debug.packet\" property must be of type boolean.');\n          }\n\n          this.config.options.debug.packet = config.options.debug.packet;\n        }\n\n        if (config.options.debug.payload !== undefined) {\n          if (typeof config.options.debug.payload !== 'boolean') {\n            throw new TypeError('The \"config.options.debug.payload\" property must be of type boolean.');\n          }\n\n          this.config.options.debug.payload = config.options.debug.payload;\n        }\n\n        if (config.options.debug.token !== undefined) {\n          if (typeof config.options.debug.token !== 'boolean') {\n            throw new TypeError('The \"config.options.debug.token\" property must be of type boolean.');\n          }\n\n          this.config.options.debug.token = config.options.debug.token;\n        }\n      }\n\n      if (config.options.enableAnsiNull !== undefined) {\n        if (typeof config.options.enableAnsiNull !== 'boolean' && config.options.enableAnsiNull !== null) {\n          throw new TypeError('The \"config.options.enableAnsiNull\" property must be of type boolean or null.');\n        }\n\n        this.config.options.enableAnsiNull = config.options.enableAnsiNull;\n      }\n\n      if (config.options.enableAnsiNullDefault !== undefined) {\n        if (typeof config.options.enableAnsiNullDefault !== 'boolean' && config.options.enableAnsiNullDefault !== null) {\n          throw new TypeError('The \"config.options.enableAnsiNullDefault\" property must be of type boolean or null.');\n        }\n\n        this.config.options.enableAnsiNullDefault = config.options.enableAnsiNullDefault;\n      }\n\n      if (config.options.enableAnsiPadding !== undefined) {\n        if (typeof config.options.enableAnsiPadding !== 'boolean' && config.options.enableAnsiPadding !== null) {\n          throw new TypeError('The \"config.options.enableAnsiPadding\" property must be of type boolean or null.');\n        }\n\n        this.config.options.enableAnsiPadding = config.options.enableAnsiPadding;\n      }\n\n      if (config.options.enableAnsiWarnings !== undefined) {\n        if (typeof config.options.enableAnsiWarnings !== 'boolean' && config.options.enableAnsiWarnings !== null) {\n          throw new TypeError('The \"config.options.enableAnsiWarnings\" property must be of type boolean or null.');\n        }\n\n        this.config.options.enableAnsiWarnings = config.options.enableAnsiWarnings;\n      }\n\n      if (config.options.enableArithAbort !== undefined) {\n        if (typeof config.options.enableArithAbort !== 'boolean' && config.options.enableArithAbort !== null) {\n          throw new TypeError('The \"config.options.enableArithAbort\" property must be of type boolean or null.');\n        }\n\n        this.config.options.enableArithAbort = config.options.enableArithAbort;\n      } else {\n        deprecate('The default value for `config.options.enableArithAbort` will change from `false` to `true` in the next major version of `tedious`. Set the value to `true` or `false` explicitly to silence this message.');\n      }\n\n      if (config.options.enableConcatNullYieldsNull !== undefined) {\n        if (typeof config.options.enableConcatNullYieldsNull !== 'boolean' && config.options.enableConcatNullYieldsNull !== null) {\n          throw new TypeError('The \"config.options.enableConcatNullYieldsNull\" property must be of type boolean or null.');\n        }\n\n        this.config.options.enableConcatNullYieldsNull = config.options.enableConcatNullYieldsNull;\n      }\n\n      if (config.options.enableCursorCloseOnCommit !== undefined) {\n        if (typeof config.options.enableCursorCloseOnCommit !== 'boolean' && config.options.enableCursorCloseOnCommit !== null) {\n          throw new TypeError('The \"config.options.enableCursorCloseOnCommit\" property must be of type boolean or null.');\n        }\n\n        this.config.options.enableCursorCloseOnCommit = config.options.enableCursorCloseOnCommit;\n      }\n\n      if (config.options.enableImplicitTransactions !== undefined) {\n        if (typeof config.options.enableImplicitTransactions !== 'boolean' && config.options.enableImplicitTransactions !== null) {\n          throw new TypeError('The \"config.options.enableImplicitTransactions\" property must be of type boolean or null.');\n        }\n\n        this.config.options.enableImplicitTransactions = config.options.enableImplicitTransactions;\n      }\n\n      if (config.options.enableNumericRoundabort !== undefined) {\n        if (typeof config.options.enableNumericRoundabort !== 'boolean' && config.options.enableNumericRoundabort !== null) {\n          throw new TypeError('The \"config.options.enableNumericRoundabort\" property must be of type boolean or null.');\n        }\n\n        this.config.options.enableNumericRoundabort = config.options.enableNumericRoundabort;\n      }\n\n      if (config.options.enableQuotedIdentifier !== undefined) {\n        if (typeof config.options.enableQuotedIdentifier !== 'boolean' && config.options.enableQuotedIdentifier !== null) {\n          throw new TypeError('The \"config.options.enableQuotedIdentifier\" property must be of type boolean or null.');\n        }\n\n        this.config.options.enableQuotedIdentifier = config.options.enableQuotedIdentifier;\n      }\n\n      if (config.options.encrypt !== undefined) {\n        if (typeof config.options.encrypt !== 'boolean') {\n          throw new TypeError('The \"config.options.encrypt\" property must be of type boolean.');\n        }\n\n        this.config.options.encrypt = config.options.encrypt;\n      }\n\n      if (config.options.fallbackToDefaultDb !== undefined) {\n        if (typeof config.options.fallbackToDefaultDb !== 'boolean') {\n          throw new TypeError('The \"config.options.fallbackToDefaultDb\" property must be of type boolean.');\n        }\n\n        this.config.options.fallbackToDefaultDb = config.options.fallbackToDefaultDb;\n      }\n\n      if (config.options.instanceName !== undefined) {\n        if (typeof config.options.instanceName !== 'string') {\n          throw new TypeError('The \"config.options.instanceName\" property must be of type string.');\n        }\n\n        this.config.options.instanceName = config.options.instanceName;\n        this.config.options.port = undefined;\n      }\n\n      if (config.options.isolationLevel !== undefined) {\n        if (typeof config.options.isolationLevel !== 'number') {\n          throw new TypeError('The \"config.options.isolationLevel\" property must be of type number.');\n        }\n\n        this.config.options.isolationLevel = config.options.isolationLevel;\n      }\n\n      if (config.options.language !== undefined) {\n        if (typeof config.options.language !== 'string' && config.options.language !== null) {\n          throw new TypeError('The \"config.options.language\" property must be of type string or null.');\n        }\n\n        this.config.options.language = config.options.language;\n      }\n\n      if (config.options.localAddress !== undefined) {\n        if (typeof config.options.localAddress !== 'string') {\n          throw new TypeError('The \"config.options.localAddress\" property must be of type string.');\n        }\n\n        this.config.options.localAddress = config.options.localAddress;\n      }\n\n      if (config.options.multiSubnetFailover !== undefined) {\n        if (typeof config.options.multiSubnetFailover !== 'boolean') {\n          throw new TypeError('The \"config.options.multiSubnetFailover\" property must be of type boolean.');\n        }\n\n        this.config.options.multiSubnetFailover = config.options.multiSubnetFailover;\n      }\n\n      if (config.options.packetSize !== undefined) {\n        if (typeof config.options.packetSize !== 'number') {\n          throw new TypeError('The \"config.options.packetSize\" property must be of type number.');\n        }\n\n        this.config.options.packetSize = config.options.packetSize;\n      }\n\n      if (config.options.port !== undefined) {\n        if (typeof config.options.port !== 'number') {\n          throw new TypeError('The \"config.options.port\" property must be of type number.');\n        }\n\n        if (config.options.port <= 0 || config.options.port >= 65536) {\n          throw new RangeError('The \"config.options.port\" property must be > 0 and < 65536');\n        }\n\n        this.config.options.port = config.options.port;\n        this.config.options.instanceName = undefined;\n      }\n\n      if (config.options.readOnlyIntent !== undefined) {\n        if (typeof config.options.readOnlyIntent !== 'boolean') {\n          throw new TypeError('The \"config.options.readOnlyIntent\" property must be of type boolean.');\n        }\n\n        this.config.options.readOnlyIntent = config.options.readOnlyIntent;\n      }\n\n      if (config.options.requestTimeout !== undefined) {\n        if (typeof config.options.requestTimeout !== 'number') {\n          throw new TypeError('The \"config.options.requestTimeout\" property must be of type number.');\n        }\n\n        this.config.options.requestTimeout = config.options.requestTimeout;\n      }\n\n      if (config.options.maxRetriesOnTransientErrors !== undefined) {\n        if (typeof config.options.maxRetriesOnTransientErrors !== 'number') {\n          throw new TypeError('The \"config.options.maxRetriesOnTransientErrors\" property must be of type number.');\n        }\n\n        if (config.options.maxRetriesOnTransientErrors < 0) {\n          throw new TypeError('The \"config.options.maxRetriesOnTransientErrors\" property must be equal or greater than 0.');\n        }\n\n        this.config.options.maxRetriesOnTransientErrors = config.options.maxRetriesOnTransientErrors;\n      }\n\n      if (config.options.connectionRetryInterval !== undefined) {\n        if (typeof config.options.connectionRetryInterval !== 'number') {\n          throw new TypeError('The \"config.options.connectionRetryInterval\" property must be of type number.');\n        }\n\n        if (config.options.connectionRetryInterval <= 0) {\n          throw new TypeError('The \"config.options.connectionRetryInterval\" property must be greater than 0.');\n        }\n\n        this.config.options.connectionRetryInterval = config.options.connectionRetryInterval;\n      }\n\n      if (config.options.rowCollectionOnDone !== undefined) {\n        if (typeof config.options.rowCollectionOnDone !== 'boolean') {\n          throw new TypeError('The \"config.options.rowCollectionOnDone\" property must be of type boolean.');\n        }\n\n        this.config.options.rowCollectionOnDone = config.options.rowCollectionOnDone;\n      }\n\n      if (config.options.rowCollectionOnRequestCompletion !== undefined) {\n        if (typeof config.options.rowCollectionOnRequestCompletion !== 'boolean') {\n          throw new TypeError('The \"config.options.rowCollectionOnRequestCompletion\" property must be of type boolean.');\n        }\n\n        this.config.options.rowCollectionOnRequestCompletion = config.options.rowCollectionOnRequestCompletion;\n      }\n\n      if (config.options.tdsVersion !== undefined) {\n        if (typeof config.options.tdsVersion !== 'string') {\n          throw new TypeError('The \"config.options.tdsVersion\" property must be of type string.');\n        }\n\n        this.config.options.tdsVersion = config.options.tdsVersion;\n      }\n\n      if (config.options.textsize !== undefined) {\n        if (typeof config.options.textsize !== 'number' && config.options.textsize !== null) {\n          throw new TypeError('The \"config.options.textsize\" property must be of type number or null.');\n        }\n\n        this.config.options.textsize = config.options.textsize;\n      }\n\n      if (config.options.trustServerCertificate !== undefined) {\n        if (typeof config.options.trustServerCertificate !== 'boolean') {\n          throw new TypeError('The \"config.options.trustServerCertificate\" property must be of type boolean.');\n        }\n\n        this.config.options.trustServerCertificate = config.options.trustServerCertificate;\n      }\n\n      if (config.options.useColumnNames !== undefined) {\n        if (typeof config.options.useColumnNames !== 'boolean') {\n          throw new TypeError('The \"config.options.useColumnNames\" property must be of type boolean.');\n        }\n\n        this.config.options.useColumnNames = config.options.useColumnNames;\n      }\n\n      if (config.options.useUTC !== undefined) {\n        if (typeof config.options.useUTC !== 'boolean') {\n          throw new TypeError('The \"config.options.useUTC\" property must be of type boolean.');\n        }\n\n        this.config.options.useUTC = config.options.useUTC;\n      }\n\n      if (config.options.lowerCaseGuids !== undefined) {\n        if (typeof config.options.lowerCaseGuids !== 'boolean') {\n          throw new TypeError('The \"config.options.lowerCaseGuids\" property must be of type boolean.');\n        }\n\n        this.config.options.lowerCaseGuids = config.options.lowerCaseGuids;\n      }\n    }\n\n    let credentialsDetails = this.config.options.cryptoCredentialsDetails;\n\n    if (credentialsDetails.secureOptions === undefined) {\n      // If the caller has not specified their own `secureOptions`,\n      // we set `SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS` here.\n      // Older SQL Server instances running on older Windows versions have\n      // trouble with the BEAST workaround in OpenSSL.\n      // As BEAST is a browser specific exploit, we can just disable this option here.\n      credentialsDetails = Object.create(credentialsDetails, {\n        secureOptions: {\n          value: _constants.default.SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS\n        }\n      });\n    }\n\n    this.secureContext = (0, _tls.createSecureContext)(credentialsDetails);\n    this.debug = this.createDebug();\n    this.tokenStreamParser = this.createTokenStreamParser();\n    this.inTransaction = false;\n    this.transactionDescriptors = [Buffer.from([0, 0, 0, 0, 0, 0, 0, 0])]; // 'beginTransaction', 'commitTransaction' and 'rollbackTransaction'\n    // events are utilized to maintain inTransaction property state which in\n    // turn is used in managing transactions. These events are only fired for\n    // TDS version 7.2 and beyond. The properties below are used to emulate\n    // equivalent behavior for TDS versions before 7.2.\n\n    this.transactionDepth = 0;\n    this.isSqlBatch = false;\n    this.closed = false;\n    this.loggedIn = false;\n    this.messageBuffer = Buffer.alloc(0);\n    this.curTransientRetryCount = 0;\n    this.transientErrorLookup = new _transientErrorLookup.TransientErrorLookup();\n    this.state = this.STATE.CONNECTING;\n    this.state.enter.call(this);\n  }\n\n  close() {\n    this.transitionTo(this.STATE.FINAL);\n  }\n\n  initialiseConnection() {\n    this.connect();\n    this.createConnectTimer();\n  }\n\n  cleanupConnection(cleanupType) {\n    if (!this.closed) {\n      this.clearConnectTimer();\n      this.clearRequestTimer();\n      this.clearRetryTimer();\n      this.closeConnection();\n\n      if (cleanupType === CLEANUP_TYPE.REDIRECT) {\n        this.emit('rerouting');\n      } else if (cleanupType !== CLEANUP_TYPE.RETRY) {\n        process.nextTick(() => {\n          this.emit('end');\n        });\n      }\n\n      const request = this.request;\n\n      if (request) {\n        const err = (0, _errors.RequestError)('Connection closed before request completed.', 'ECLOSE');\n        request.callback(err);\n        this.request = undefined;\n      }\n\n      this.closed = true;\n      this.loggedIn = false;\n      this.loginError = undefined;\n    }\n  }\n\n  createDebug() {\n    const debug = new _debug.default(this.config.options.debug);\n    debug.on('debug', message => {\n      this.emit('debug', message);\n    });\n    return debug;\n  }\n\n  createTokenStreamParser() {\n    const tokenStreamParser = new _tokenStreamParser.Parser(this.debug, undefined, this.config.options);\n    tokenStreamParser.on('infoMessage', token => {\n      this.emit('infoMessage', token);\n    });\n    tokenStreamParser.on('sspichallenge', token => {\n      if (token.ntlmpacket) {\n        this.ntlmpacket = token.ntlmpacket;\n        this.ntlmpacketBuffer = token.ntlmpacketBuffer;\n      }\n\n      this.emit('sspichallenge', token);\n    });\n    tokenStreamParser.on('errorMessage', token => {\n      this.emit('errorMessage', token);\n\n      if (this.loggedIn) {\n        const request = this.request;\n\n        if (request) {\n          if (!request.canceled) {\n            const error = new _errors.RequestError(token.message, 'EREQUEST');\n            error.number = token.number;\n            error.state = token.state;\n            error.class = token.class;\n            error.serverName = token.serverName;\n            error.procName = token.procName;\n            error.lineNumber = token.lineNumber;\n            request.error = error;\n          }\n        }\n      } else {\n        const error = (0, _errors.ConnectionError)(token.message, 'ELOGIN');\n        const isLoginErrorTransient = this.transientErrorLookup.isTransientError(token.number);\n\n        if (isLoginErrorTransient && this.curTransientRetryCount !== this.config.options.maxRetriesOnTransientErrors) {\n          error.isTransient = true;\n        }\n\n        this.loginError = error;\n      }\n    });\n    tokenStreamParser.on('databaseChange', token => {\n      this.emit('databaseChange', token.newValue);\n    });\n    tokenStreamParser.on('languageChange', token => {\n      this.emit('languageChange', token.newValue);\n    });\n    tokenStreamParser.on('charsetChange', token => {\n      this.emit('charsetChange', token.newValue);\n    });\n    tokenStreamParser.on('fedAuthInfo', token => {\n      this.dispatchEvent('fedAuthInfo', token);\n    });\n    tokenStreamParser.on('featureExtAck', token => {\n      this.dispatchEvent('featureExtAck', token);\n    });\n    tokenStreamParser.on('loginack', token => {\n      if (!token.tdsVersion) {\n        // unsupported TDS version\n        this.loginError = (0, _errors.ConnectionError)('Server responded with unknown TDS version.', 'ETDS');\n        this.loggedIn = false;\n        return;\n      }\n\n      if (!token.interface) {\n        // unsupported interface\n        this.loginError = (0, _errors.ConnectionError)('Server responded with unsupported interface.', 'EINTERFACENOTSUPP');\n        this.loggedIn = false;\n        return;\n      } // use negotiated version\n\n\n      this.config.options.tdsVersion = token.tdsVersion;\n      this.loggedIn = true;\n    });\n    tokenStreamParser.on('routingChange', token => {\n      this.routingData = token.newValue;\n      this.dispatchEvent('routingChange');\n    });\n    tokenStreamParser.on('packetSizeChange', token => {\n      this.messageIo.packetSize(token.newValue);\n    }); // A new top-level transaction was started. This is not fired\n    // for nested transactions.\n\n    tokenStreamParser.on('beginTransaction', token => {\n      this.transactionDescriptors.push(token.newValue);\n      this.inTransaction = true;\n    }); // A top-level transaction was committed. This is not fired\n    // for nested transactions.\n\n    tokenStreamParser.on('commitTransaction', () => {\n      this.transactionDescriptors.length = 1;\n      this.inTransaction = false;\n    }); // A top-level transaction was rolled back. This is not fired\n    // for nested transactions. This is also fired if a batch\n    // aborting error happened that caused a rollback.\n\n    tokenStreamParser.on('rollbackTransaction', () => {\n      this.transactionDescriptors.length = 1; // An outermost transaction was rolled back. Reset the transaction counter\n\n      this.inTransaction = false;\n      this.emit('rollbackTransaction');\n    });\n    tokenStreamParser.on('columnMetadata', token => {\n      const request = this.request;\n\n      if (request) {\n        if (!request.canceled) {\n          if (this.config.options.useColumnNames) {\n            const columns = {};\n\n            for (let j = 0, len = token.columns.length; j < len; j++) {\n              const col = token.columns[j];\n\n              if (columns[col.colName] == null) {\n                columns[col.colName] = col;\n              }\n            }\n\n            request.emit('columnMetadata', columns);\n          } else {\n            request.emit('columnMetadata', token.columns);\n          }\n        }\n      } else {\n        this.emit('error', new Error(\"Received 'columnMetadata' when no sqlRequest is in progress\"));\n        this.close();\n      }\n    });\n    tokenStreamParser.on('order', token => {\n      const request = this.request;\n\n      if (request) {\n        if (!request.canceled) {\n          request.emit('order', token.orderColumns);\n        }\n      } else {\n        this.emit('error', new Error(\"Received 'order' when no sqlRequest is in progress\"));\n        this.close();\n      }\n    });\n    tokenStreamParser.on('row', token => {\n      const request = this.request;\n\n      if (request) {\n        if (!request.canceled) {\n          if (this.config.options.rowCollectionOnRequestCompletion) {\n            request.rows.push(token.columns);\n          }\n\n          if (this.config.options.rowCollectionOnDone) {\n            request.rst.push(token.columns);\n          }\n\n          if (!(this.state === this.STATE.SENT_ATTENTION && request.paused)) {\n            request.emit('row', token.columns);\n          }\n        }\n      } else {\n        this.emit('error', new Error(\"Received 'row' when no sqlRequest is in progress\"));\n        this.close();\n      }\n    });\n    tokenStreamParser.on('returnStatus', token => {\n      const request = this.request;\n\n      if (request) {\n        if (!request.canceled) {\n          // Keep value for passing in 'doneProc' event.\n          this.procReturnStatusValue = token.value;\n        }\n      }\n    });\n    tokenStreamParser.on('returnValue', token => {\n      const request = this.request;\n\n      if (request) {\n        if (!request.canceled) {\n          request.emit('returnValue', token.paramName, token.value, token.metadata);\n        }\n      }\n    });\n    tokenStreamParser.on('doneProc', token => {\n      const request = this.request;\n\n      if (request) {\n        if (!request.canceled) {\n          request.emit('doneProc', token.rowCount, token.more, this.procReturnStatusValue, request.rst);\n          this.procReturnStatusValue = undefined;\n\n          if (token.rowCount !== undefined) {\n            request.rowCount += token.rowCount;\n          }\n\n          if (this.config.options.rowCollectionOnDone) {\n            request.rst = [];\n          }\n        }\n      }\n    });\n    tokenStreamParser.on('doneInProc', token => {\n      const request = this.request;\n\n      if (request) {\n        if (!request.canceled) {\n          request.emit('doneInProc', token.rowCount, token.more, request.rst);\n\n          if (token.rowCount !== undefined) {\n            request.rowCount += token.rowCount;\n          }\n\n          if (this.config.options.rowCollectionOnDone) {\n            request.rst = [];\n          }\n        }\n      }\n    });\n    tokenStreamParser.on('done', token => {\n      const request = this.request;\n\n      if (request) {\n        if (token.attention) {\n          this.dispatchEvent('attention');\n        }\n\n        if (request.canceled) {\n          // If we received a `DONE` token with `DONE_ERROR`, but no previous `ERROR` token,\n          // We assume this is the indication that an in-flight request was canceled.\n          if (token.sqlError && !request.error) {\n            this.clearCancelTimer();\n            request.error = (0, _errors.RequestError)('Canceled.', 'ECANCEL');\n          }\n        } else {\n          if (token.sqlError && !request.error) {\n            // check if the DONE_ERROR flags was set, but an ERROR token was not sent.\n            request.error = (0, _errors.RequestError)('An unknown error has occurred.', 'UNKNOWN');\n          }\n\n          request.emit('done', token.rowCount, token.more, request.rst);\n\n          if (token.rowCount !== undefined) {\n            request.rowCount += token.rowCount;\n          }\n\n          if (this.config.options.rowCollectionOnDone) {\n            request.rst = [];\n          }\n        }\n      }\n    });\n    tokenStreamParser.on('endOfMessage', () => {\n      // EOM pseudo token received\n      if (this.state === this.STATE.SENT_CLIENT_REQUEST) {\n        this.dispatchEvent('endOfMessageMarkerReceived');\n      }\n    });\n    tokenStreamParser.on('resetConnection', () => {\n      this.emit('resetConnection');\n    });\n    tokenStreamParser.on('drain', () => {\n      // Bridge the release of backpressure from the token stream parser\n      // transform to the packet stream transform.\n      this.messageIo.resume();\n    });\n    return tokenStreamParser;\n  }\n\n  connect() {\n    if (this.config.options.port) {\n      return this.connectOnPort(this.config.options.port, this.config.options.multiSubnetFailover);\n    } else {\n      return new _instanceLookup.InstanceLookup().instanceLookup({\n        server: this.config.server,\n        instanceName: this.config.options.instanceName,\n        timeout: this.config.options.connectTimeout\n      }, (message, port) => {\n        if (this.state === this.STATE.FINAL) {\n          return;\n        }\n\n        if (message) {\n          this.emit('connect', (0, _errors.ConnectionError)(message, 'EINSTLOOKUP'));\n        } else {\n          this.connectOnPort(port, this.config.options.multiSubnetFailover);\n        }\n      });\n    }\n  }\n\n  connectOnPort(port, multiSubnetFailover) {\n    const connectOpts = {\n      host: this.routingData ? this.routingData.server : this.config.server,\n      port: this.routingData ? this.routingData.port : port,\n      localAddress: this.config.options.localAddress\n    };\n    new _connector.Connector(connectOpts, multiSubnetFailover).execute((err, socket) => {\n      if (err) {\n        return this.socketError(err);\n      }\n\n      if (this.state === this.STATE.FINAL) {\n        socket.destroy();\n        return;\n      }\n\n      socket.on('error', error => {\n        this.socketError(error);\n      });\n      socket.on('close', () => {\n        this.socketClose();\n      });\n      socket.on('end', () => {\n        this.socketEnd();\n      });\n      socket.setKeepAlive(true, KEEP_ALIVE_INITIAL_DELAY);\n      this.messageIo = new _messageIo.default(socket, this.config.options.packetSize, this.debug);\n      this.messageIo.on('data', data => {\n        this.dispatchEvent('data', data);\n      });\n      this.messageIo.on('message', () => {\n        this.dispatchEvent('message');\n      });\n      this.messageIo.on('secure', cleartext => {\n        this.emit('secure', cleartext);\n      });\n      this.socket = socket;\n      this.socketConnect();\n    });\n  }\n\n  closeConnection() {\n    if (this.socket) {\n      this.socket.destroy();\n    }\n  }\n\n  createConnectTimer() {\n    this.connectTimer = setTimeout(() => {\n      this.connectTimeout();\n    }, this.config.options.connectTimeout);\n  }\n\n  createCancelTimer() {\n    this.clearCancelTimer();\n    const timeout = this.config.options.cancelTimeout;\n\n    if (timeout > 0) {\n      this.cancelTimer = setTimeout(() => {\n        this.cancelTimeout();\n      }, timeout);\n    }\n  }\n\n  createRequestTimer() {\n    this.clearRequestTimer(); // release old timer, just to be safe\n\n    const request = this.request;\n    const timeout = request.timeout !== undefined ? request.timeout : this.config.options.requestTimeout;\n\n    if (timeout) {\n      this.requestTimer = setTimeout(() => {\n        this.requestTimeout();\n      }, timeout);\n    }\n  }\n\n  createRetryTimer() {\n    this.clearRetryTimer();\n    this.retryTimer = setTimeout(() => {\n      this.retryTimeout();\n    }, this.config.options.connectionRetryInterval);\n  }\n\n  connectTimeout() {\n    const message = `Failed to connect to ${this.config.server}${this.config.options.port ? `:${this.config.options.port}` : `\\\\${this.config.options.instanceName}`} in ${this.config.options.connectTimeout}ms`;\n    this.debug.log(message);\n    this.emit('connect', (0, _errors.ConnectionError)(message, 'ETIMEOUT'));\n    this.connectTimer = undefined;\n    this.dispatchEvent('connectTimeout');\n  }\n\n  cancelTimeout() {\n    const message = `Failed to cancel request in ${this.config.options.cancelTimeout}ms`;\n    this.debug.log(message);\n    this.dispatchEvent('socketError', (0, _errors.ConnectionError)(message, 'ETIMEOUT'));\n  }\n\n  requestTimeout() {\n    this.requestTimer = undefined;\n    const request = this.request;\n    request.cancel();\n    const timeout = request.timeout !== undefined ? request.timeout : this.config.options.requestTimeout;\n    const message = 'Timeout: Request failed to complete in ' + timeout + 'ms';\n    request.error = (0, _errors.RequestError)(message, 'ETIMEOUT');\n  }\n\n  retryTimeout() {\n    this.retryTimer = undefined;\n    this.emit('retry');\n    this.transitionTo(this.STATE.CONNECTING);\n  }\n\n  clearConnectTimer() {\n    if (this.connectTimer) {\n      clearTimeout(this.connectTimer);\n    }\n  }\n\n  clearCancelTimer() {\n    if (this.cancelTimer) {\n      clearTimeout(this.cancelTimer);\n    }\n  }\n\n  clearRequestTimer() {\n    if (this.requestTimer) {\n      clearTimeout(this.requestTimer);\n      this.requestTimer = undefined;\n    }\n  }\n\n  clearRetryTimer() {\n    if (this.retryTimer) {\n      clearTimeout(this.retryTimer);\n      this.retryTimer = undefined;\n    }\n  }\n\n  transitionTo(newState) {\n    if (this.state === newState) {\n      this.debug.log('State is already ' + newState.name);\n      return;\n    }\n\n    if (this.state && this.state.exit) {\n      this.state.exit.call(this, newState);\n    }\n\n    this.debug.log('State change: ' + (this.state ? this.state.name : 'undefined') + ' -> ' + newState.name);\n    this.state = newState;\n\n    if (this.state.enter) {\n      this.state.enter.apply(this);\n    }\n  }\n\n  getEventHandler(eventName) {\n    const handler = this.state.events[eventName];\n\n    if (!handler) {\n      throw new Error(`No event '${eventName}' in state '${this.state.name}'`);\n    }\n\n    return handler;\n  }\n\n  dispatchEvent(eventName, ...args) {\n    const handler = this.state.events[eventName];\n\n    if (handler) {\n      handler.apply(this, args);\n    } else {\n      this.emit('error', new Error(`No event '${eventName}' in state '${this.state.name}'`));\n      this.close();\n    }\n  }\n\n  socketError(error) {\n    if (this.state === this.STATE.CONNECTING || this.state === this.STATE.SENT_TLSSSLNEGOTIATION) {\n      const message = `Failed to connect to ${this.config.server}:${this.config.options.port} - ${error.message}`;\n      this.debug.log(message);\n      this.emit('connect', (0, _errors.ConnectionError)(message, 'ESOCKET'));\n    } else {\n      const message = `Connection lost - ${error.message}`;\n      this.debug.log(message);\n      this.emit('error', (0, _errors.ConnectionError)(message, 'ESOCKET'));\n    }\n\n    this.dispatchEvent('socketError', error);\n  }\n\n  socketConnect() {\n    this.closed = false;\n    this.debug.log('connected to ' + this.config.server + ':' + this.config.options.port);\n    this.dispatchEvent('socketConnect');\n  }\n\n  socketEnd() {\n    this.debug.log('socket ended');\n\n    if (this.state !== this.STATE.FINAL) {\n      const error = new Error('socket hang up');\n      error.code = 'ECONNRESET';\n      this.socketError(error);\n    }\n  }\n\n  socketClose() {\n    this.debug.log('connection to ' + this.config.server + ':' + this.config.options.port + ' closed');\n\n    if (this.state === this.STATE.REROUTING) {\n      this.debug.log('Rerouting to ' + this.routingData.server + ':' + this.routingData.port);\n      this.dispatchEvent('reconnect');\n    } else if (this.state === this.STATE.TRANSIENT_FAILURE_RETRY) {\n      const server = this.routingData ? this.routingData.server : this.config.server;\n      const port = this.routingData ? this.routingData.port : this.config.options.port;\n      this.debug.log('Retry after transient failure connecting to ' + server + ':' + port);\n      this.dispatchEvent('retry');\n    } else {\n      this.transitionTo(this.STATE.FINAL);\n    }\n  }\n\n  sendPreLogin() {\n    const payload = new _preloginPayload.default({\n      encrypt: this.config.options.encrypt\n    });\n    this.messageIo.sendMessage(_packet.TYPE.PRELOGIN, payload.data);\n    this.debug.payload(function () {\n      return payload.toString('  ');\n    });\n  }\n\n  emptyMessageBuffer() {\n    this.messageBuffer = Buffer.alloc(0);\n  }\n\n  addToMessageBuffer(data) {\n    this.messageBuffer = Buffer.concat([this.messageBuffer, data]);\n  }\n\n  sendLogin7Packet() {\n    const payload = new _login7Payload.default({\n      tdsVersion: _tdsVersions.versions[this.config.options.tdsVersion],\n      packetSize: this.config.options.packetSize,\n      clientProgVer: 0,\n      clientPid: process.pid,\n      connectionId: 0,\n      clientTimeZone: new Date().getTimezoneOffset(),\n      clientLcid: 0x00000409\n    });\n    const authentication = this.config.authentication;\n\n    switch (authentication.type) {\n      case 'azure-active-directory-password':\n        payload.fedAuth = {\n          type: 'ADAL',\n          echo: this.fedAuthRequired,\n          workflow: 'default'\n        };\n        break;\n\n      case 'azure-active-directory-access-token':\n        payload.fedAuth = {\n          type: 'SECURITYTOKEN',\n          echo: this.fedAuthRequired,\n          fedAuthToken: authentication.options.token\n        };\n        break;\n\n      case 'azure-active-directory-msi-vm':\n      case 'azure-active-directory-msi-app-service':\n      case 'azure-active-directory-service-principal-secret':\n        payload.fedAuth = {\n          type: 'ADAL',\n          echo: this.fedAuthRequired,\n          workflow: 'integrated'\n        };\n        break;\n\n      case 'ntlm':\n        payload.sspi = (0, _ntlm.createNTLMRequest)({\n          domain: authentication.options.domain\n        });\n        break;\n\n      default:\n        payload.userName = authentication.options.userName;\n        payload.password = authentication.options.password;\n    }\n\n    payload.hostname = _os.default.hostname();\n    payload.serverName = this.routingData ? this.routingData.server : this.config.server;\n    payload.appName = this.config.options.appName || 'Tedious';\n    payload.libraryName = _library.name;\n    payload.language = this.config.options.language;\n    payload.database = this.config.options.database;\n    payload.clientId = Buffer.from([1, 2, 3, 4, 5, 6]);\n    payload.readOnlyIntent = this.config.options.readOnlyIntent;\n    payload.initDbFatal = !this.config.options.fallbackToDefaultDb;\n    this.routingData = undefined;\n    this.messageIo.sendMessage(_packet.TYPE.LOGIN7, payload.toBuffer());\n    this.debug.payload(function () {\n      return payload.toString('  ');\n    });\n  }\n\n  sendFedAuthTokenMessage(token) {\n    const accessTokenLen = Buffer.byteLength(token, 'ucs2');\n    const data = Buffer.alloc(8 + accessTokenLen);\n    let offset = 0;\n    offset = data.writeUInt32LE(accessTokenLen + 4, offset);\n    offset = data.writeUInt32LE(accessTokenLen, offset);\n    data.write(token, offset, 'ucs2');\n    this.messageIo.sendMessage(_packet.TYPE.FEDAUTH_TOKEN, data); // sent the fedAuth token message, the rest is similar to standard login 7\n\n    this.transitionTo(this.STATE.SENT_LOGIN7_WITH_STANDARD_LOGIN);\n  } // Returns false to apply backpressure.\n\n\n  sendDataToTokenStreamParser(data) {\n    return this.tokenStreamParser.addBuffer(data);\n  } // This is an internal method that is called from Request.pause().\n  // It has to check whether the passed Request object represents the currently\n  // active request, because the application might have called Request.pause()\n  // on an old inactive Request object.\n\n\n  pauseRequest(request) {\n    if (this.isRequestActive(request)) {\n      this.tokenStreamParser.pause();\n    }\n  } // This is an internal method that is called from Request.resume().\n\n\n  resumeRequest(request) {\n    if (this.isRequestActive(request)) {\n      this.tokenStreamParser.resume();\n    }\n  } // Returns true if the passed request is the currently active request of the connection.\n\n\n  isRequestActive(request) {\n    return request === this.request && this.state === this.STATE.SENT_CLIENT_REQUEST;\n  }\n\n  sendInitialSql() {\n    const payload = new _sqlbatchPayload.default(this.getInitialSql(), this.currentTransactionDescriptor(), this.config.options);\n    payload.getData(data => {\n      return this.messageIo.sendMessage(_packet.TYPE.SQL_BATCH, data);\n    });\n  }\n\n  getInitialSql() {\n    const options = [];\n\n    if (this.config.options.enableAnsiNull === true) {\n      options.push('set ansi_nulls on');\n    } else if (this.config.options.enableAnsiNull === false) {\n      options.push('set ansi_nulls off');\n    }\n\n    if (this.config.options.enableAnsiNullDefault === true) {\n      options.push('set ansi_null_dflt_on on');\n    } else if (this.config.options.enableAnsiNullDefault === false) {\n      options.push('set ansi_null_dflt_on off');\n    }\n\n    if (this.config.options.enableAnsiPadding === true) {\n      options.push('set ansi_padding on');\n    } else if (this.config.options.enableAnsiPadding === false) {\n      options.push('set ansi_padding off');\n    }\n\n    if (this.config.options.enableAnsiWarnings === true) {\n      options.push('set ansi_warnings on');\n    } else if (this.config.options.enableAnsiWarnings === false) {\n      options.push('set ansi_warnings off');\n    }\n\n    if (this.config.options.enableArithAbort === true) {\n      options.push('set arithabort on');\n    } else if (this.config.options.enableArithAbort === false) {\n      options.push('set arithabort off');\n    }\n\n    if (this.config.options.enableConcatNullYieldsNull === true) {\n      options.push('set concat_null_yields_null on');\n    } else if (this.config.options.enableConcatNullYieldsNull === false) {\n      options.push('set concat_null_yields_null off');\n    }\n\n    if (this.config.options.enableCursorCloseOnCommit === true) {\n      options.push('set cursor_close_on_commit on');\n    } else if (this.config.options.enableCursorCloseOnCommit === false) {\n      options.push('set cursor_close_on_commit off');\n    }\n\n    if (this.config.options.datefirst !== null) {\n      options.push(`set datefirst ${this.config.options.datefirst}`);\n    }\n\n    if (this.config.options.dateFormat !== null) {\n      options.push(`set dateformat ${this.config.options.dateFormat}`);\n    }\n\n    if (this.config.options.enableImplicitTransactions === true) {\n      options.push('set implicit_transactions on');\n    } else if (this.config.options.enableImplicitTransactions === false) {\n      options.push('set implicit_transactions off');\n    }\n\n    if (this.config.options.language !== null) {\n      options.push(`set language ${this.config.options.language}`);\n    }\n\n    if (this.config.options.enableNumericRoundabort === true) {\n      options.push('set numeric_roundabort on');\n    } else if (this.config.options.enableNumericRoundabort === false) {\n      options.push('set numeric_roundabort off');\n    }\n\n    if (this.config.options.enableQuotedIdentifier === true) {\n      options.push('set quoted_identifier on');\n    } else if (this.config.options.enableQuotedIdentifier === false) {\n      options.push('set quoted_identifier off');\n    }\n\n    if (this.config.options.textsize !== null) {\n      options.push(`set textsize ${this.config.options.textsize}`);\n    }\n\n    if (this.config.options.connectionIsolationLevel !== null) {\n      options.push(`set transaction isolation level ${this.getIsolationLevelText(this.config.options.connectionIsolationLevel)}`);\n    }\n\n    if (this.config.options.abortTransactionOnError === true) {\n      options.push('set xact_abort on');\n    } else if (this.config.options.abortTransactionOnError === false) {\n      options.push('set xact_abort off');\n    }\n\n    return options.join('\\n');\n  }\n\n  processedInitialSql() {\n    this.clearConnectTimer();\n    this.emit('connect');\n  }\n\n  execSqlBatch(request) {\n    this.makeRequest(request, _packet.TYPE.SQL_BATCH, new _sqlbatchPayload.default(request.sqlTextOrProcedure, this.currentTransactionDescriptor(), this.config.options));\n  }\n\n  execSql(request) {\n    request.transformIntoExecuteSqlRpc();\n    const error = request.error;\n\n    if (error != null) {\n      process.nextTick(() => {\n        this.debug.log(error.message);\n        request.callback(error);\n      });\n      return;\n    }\n\n    this.makeRequest(request, _packet.TYPE.RPC_REQUEST, new _rpcrequestPayload.default(request, this.currentTransactionDescriptor(), this.config.options));\n  }\n  /**\n   @function newBulkLoad\n   @param {string} table - Table's name.\n   @param {Object} [options] - BulkLoad options.\n   @param {boolean} [options.checkConstraints=false] - Honors constraints during bulk load, it is disabled by default.\n   @param {boolean} [options.fireTriggers=false] - Honors insert triggers during bulk load, it is disabled by default.\n   @param {boolean} [options.keepNulls=false] - Honors null value passed, ignores the default values set on table.\n   @param {boolean} [options.tableLock=false] - Places a bulk update(BU) lock on table while performing bulk load. Uses row locks by default.\n   @param {callback} callback - Function to call after BulkLoad executes.\n   */\n\n\n  newBulkLoad(table, callbackOrOptions, callback) {\n    let options;\n\n    if (callback === undefined) {\n      callback = callbackOrOptions;\n      options = {};\n    } else {\n      options = callbackOrOptions;\n    }\n\n    if (typeof options !== 'object') {\n      throw new TypeError('\"options\" argument must be an object');\n    }\n\n    return new _bulkLoad.default(table, this.config.options, options, callback);\n  }\n\n  execBulkLoad(bulkLoad) {\n    bulkLoad.executionStarted = true;\n    const request = new _request.default(bulkLoad.getBulkInsertSql(), error => {\n      if (error) {\n        if (error.code === 'UNKNOWN') {\n          error.message += ' This is likely because the schema of the BulkLoad does not match the schema of the table you are attempting to insert into.';\n        }\n\n        bulkLoad.error = error;\n        bulkLoad.callback(error);\n        return;\n      }\n\n      this.makeRequest(bulkLoad, _packet.TYPE.BULK_LOAD);\n    });\n    bulkLoad.once('cancel', () => {\n      request.cancel();\n    });\n    this.execSqlBatch(request);\n  }\n\n  prepare(request) {\n    request.transformIntoPrepareRpc();\n    this.makeRequest(request, _packet.TYPE.RPC_REQUEST, new _rpcrequestPayload.default(request, this.currentTransactionDescriptor(), this.config.options));\n  }\n\n  unprepare(request) {\n    request.transformIntoUnprepareRpc();\n    this.makeRequest(request, _packet.TYPE.RPC_REQUEST, new _rpcrequestPayload.default(request, this.currentTransactionDescriptor(), this.config.options));\n  }\n\n  execute(request, parameters) {\n    request.transformIntoExecuteRpc(parameters);\n    const error = request.error;\n\n    if (error != null) {\n      process.nextTick(() => {\n        this.debug.log(error.message);\n        request.callback(error);\n      });\n      return;\n    }\n\n    this.makeRequest(request, _packet.TYPE.RPC_REQUEST, new _rpcrequestPayload.default(request, this.currentTransactionDescriptor(), this.config.options));\n  }\n\n  callProcedure(request) {\n    request.validateParameters();\n    const error = request.error;\n\n    if (error != null) {\n      process.nextTick(() => {\n        this.debug.log(error.message);\n        request.callback(error);\n      });\n      return;\n    }\n\n    this.makeRequest(request, _packet.TYPE.RPC_REQUEST, new _rpcrequestPayload.default(request, this.currentTransactionDescriptor(), this.config.options));\n  }\n\n  beginTransaction(callback, name = '', isolationLevel = this.config.options.isolationLevel) {\n    const transaction = new _transaction.Transaction(name, isolationLevel);\n\n    if (this.config.options.tdsVersion < '7_2') {\n      return this.execSqlBatch(new _request.default('SET TRANSACTION ISOLATION LEVEL ' + transaction.isolationLevelToTSQL() + ';BEGIN TRAN ' + transaction.name, err => {\n        this.transactionDepth++;\n\n        if (this.transactionDepth === 1) {\n          this.inTransaction = true;\n        }\n\n        callback(err);\n      }));\n    }\n\n    const request = new _request.default(undefined, err => {\n      return callback(err, this.currentTransactionDescriptor());\n    });\n    return this.makeRequest(request, _packet.TYPE.TRANSACTION_MANAGER, transaction.beginPayload(this.currentTransactionDescriptor()));\n  }\n\n  commitTransaction(callback, name = '') {\n    const transaction = new _transaction.Transaction(name);\n\n    if (this.config.options.tdsVersion < '7_2') {\n      return this.execSqlBatch(new _request.default('COMMIT TRAN ' + transaction.name, err => {\n        this.transactionDepth--;\n\n        if (this.transactionDepth === 0) {\n          this.inTransaction = false;\n        }\n\n        callback(err);\n      }));\n    }\n\n    const request = new _request.default(undefined, callback);\n    return this.makeRequest(request, _packet.TYPE.TRANSACTION_MANAGER, transaction.commitPayload(this.currentTransactionDescriptor()));\n  }\n\n  rollbackTransaction(callback, name = '') {\n    const transaction = new _transaction.Transaction(name);\n\n    if (this.config.options.tdsVersion < '7_2') {\n      return this.execSqlBatch(new _request.default('ROLLBACK TRAN ' + transaction.name, err => {\n        this.transactionDepth--;\n\n        if (this.transactionDepth === 0) {\n          this.inTransaction = false;\n        }\n\n        callback(err);\n      }));\n    }\n\n    const request = new _request.default(undefined, callback);\n    return this.makeRequest(request, _packet.TYPE.TRANSACTION_MANAGER, transaction.rollbackPayload(this.currentTransactionDescriptor()));\n  }\n\n  saveTransaction(callback, name) {\n    const transaction = new _transaction.Transaction(name);\n\n    if (this.config.options.tdsVersion < '7_2') {\n      return this.execSqlBatch(new _request.default('SAVE TRAN ' + transaction.name, err => {\n        this.transactionDepth++;\n        callback(err);\n      }));\n    }\n\n    const request = new _request.default(undefined, callback);\n    return this.makeRequest(request, _packet.TYPE.TRANSACTION_MANAGER, transaction.savePayload(this.currentTransactionDescriptor()));\n  }\n\n  transaction(cb, isolationLevel) {\n    if (typeof cb !== 'function') {\n      throw new TypeError('`cb` must be a function');\n    }\n\n    const useSavepoint = this.inTransaction;\n\n    const name = '_tedious_' + _crypto.default.randomBytes(10).toString('hex');\n\n    const txDone = (err, done, ...args) => {\n      if (err) {\n        if (this.inTransaction && this.state === this.STATE.LOGGED_IN) {\n          this.rollbackTransaction(txErr => {\n            done(txErr || err, ...args);\n          }, name);\n        } else {\n          done(err, ...args);\n        }\n      } else if (useSavepoint) {\n        if (this.config.options.tdsVersion < '7_2') {\n          this.transactionDepth--;\n        }\n\n        done(null, ...args);\n      } else {\n        this.commitTransaction(txErr => {\n          done(txErr, ...args);\n        }, name);\n      }\n    };\n\n    if (useSavepoint) {\n      return this.saveTransaction(err => {\n        if (err) {\n          return cb(err);\n        }\n\n        if (isolationLevel) {\n          return this.execSqlBatch(new _request.default('SET transaction isolation level ' + this.getIsolationLevelText(isolationLevel), err => {\n            return cb(err, txDone);\n          }));\n        } else {\n          return cb(null, txDone);\n        }\n      }, name);\n    } else {\n      return this.beginTransaction(err => {\n        if (err) {\n          return cb(err);\n        }\n\n        return cb(null, txDone);\n      }, name, isolationLevel);\n    }\n  }\n\n  makeRequest(request, packetType, payload) {\n    if (this.state !== this.STATE.LOGGED_IN) {\n      const message = 'Requests can only be made in the ' + this.STATE.LOGGED_IN.name + ' state, not the ' + this.state.name + ' state';\n      this.debug.log(message);\n      request.callback((0, _errors.RequestError)(message, 'EINVALIDSTATE'));\n    } else if (request.canceled) {\n      process.nextTick(() => {\n        request.callback((0, _errors.RequestError)('Canceled.', 'ECANCEL'));\n      });\n    } else {\n      if (packetType === _packet.TYPE.SQL_BATCH) {\n        this.isSqlBatch = true;\n      } else {\n        this.isSqlBatch = false;\n      }\n\n      this.request = request;\n      request.connection = this;\n      request.rowCount = 0;\n      request.rows = [];\n      request.rst = [];\n      let message;\n      request.once('cancel', () => {\n        if (!this.isRequestActive(request)) {\n          // Cancel was called on a request that is no longer active on this connection\n          return;\n        } // There's three ways to handle request cancelation:\n\n\n        if (this.state === this.STATE.BUILDING_CLIENT_REQUEST) {\n          // The request was cancelled before buffering finished\n          this.request = undefined;\n          request.callback((0, _errors.RequestError)('Canceled.', 'ECANCEL'));\n          this.transitionTo(this.STATE.LOGGED_IN);\n        } else if (message.writable) {\n          // - if the message is still writable, we'll set the ignore bit\n          //   and end the message.\n          message.ignore = true;\n          message.end();\n        } else {\n          // - but if the message has been ended (and thus has been fully sent off),\n          //   we need to send an `ATTENTION` message to the server\n          this.messageIo.sendMessage(_packet.TYPE.ATTENTION);\n          this.transitionTo(this.STATE.SENT_ATTENTION);\n        }\n\n        this.clearRequestTimer();\n        this.createCancelTimer();\n      });\n\n      if (request instanceof _bulkLoad.default) {\n        message = request.getMessageStream(); // If the bulkload was not put into streaming mode by the user,\n        // we end the rowToPacketTransform here for them.\n        //\n        // If it was put into streaming mode, it's the user's responsibility\n        // to end the stream.\n\n        if (!request.streamingMode) {\n          request.rowToPacketTransform.end();\n        }\n\n        this.messageIo.outgoingMessageStream.write(message);\n        this.transitionTo(this.STATE.SENT_CLIENT_REQUEST);\n\n        if (request.paused) {\n          // Request.pause() has been called before the request was started\n          this.pauseRequest(request);\n        }\n      } else {\n        this.createRequestTimer(); // Transition to an intermediate state to ensure that no new requests\n        // are made on the connection while the buffer is being populated.\n\n        this.transitionTo(this.STATE.BUILDING_CLIENT_REQUEST);\n        payload.getData(data => {\n          if (this.state !== this.STATE.BUILDING_CLIENT_REQUEST) {\n            // Something else has happened on the connection since starting to\n            // build the request. That state change should have invoked the\n            // request handler so there is nothing to do at this point.\n            return;\n          }\n\n          message = this.messageIo.sendMessage(packetType, data, this.resetConnectionOnNextRequest);\n          this.resetConnectionOnNextRequest = false;\n          this.debug.payload(function () {\n            return payload.toString('  ');\n          });\n          this.transitionTo(this.STATE.SENT_CLIENT_REQUEST);\n\n          if (request.paused) {\n            // Request.pause() has been called before the request was started\n            this.pauseRequest(request);\n          }\n        });\n      }\n    }\n  }\n\n  cancel() {\n    if (!this.request) {\n      return false;\n    }\n\n    if (this.request.canceled) {\n      return false;\n    }\n\n    this.request.cancel();\n    return true;\n  }\n\n  reset(callback) {\n    const request = new _request.default(this.getInitialSql(), err => {\n      if (this.config.options.tdsVersion < '7_2') {\n        this.inTransaction = false;\n      }\n\n      callback(err);\n    });\n    this.resetConnectionOnNextRequest = true;\n    this.execSqlBatch(request);\n  }\n\n  currentTransactionDescriptor() {\n    return this.transactionDescriptors[this.transactionDescriptors.length - 1];\n  }\n\n  getIsolationLevelText(isolationLevel) {\n    switch (isolationLevel) {\n      case _transaction.ISOLATION_LEVEL.READ_UNCOMMITTED:\n        return 'read uncommitted';\n\n      case _transaction.ISOLATION_LEVEL.REPEATABLE_READ:\n        return 'repeatable read';\n\n      case _transaction.ISOLATION_LEVEL.SERIALIZABLE:\n        return 'serializable';\n\n      case _transaction.ISOLATION_LEVEL.SNAPSHOT:\n        return 'snapshot';\n\n      default:\n        return 'read committed';\n    }\n  }\n\n}\n\nvar _default = Connection;\nexports.default = _default;\nmodule.exports = Connection;\nConnection.prototype.STATE = {\n  CONNECTING: {\n    name: 'Connecting',\n    enter: function enter() {\n      this.initialiseConnection();\n    },\n    events: {\n      socketError: function socketError() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      connectTimeout: function connectTimeout() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      socketConnect: function socketConnect() {\n        this.sendPreLogin();\n        this.transitionTo(this.STATE.SENT_PRELOGIN);\n      }\n    }\n  },\n  SENT_PRELOGIN: {\n    name: 'SentPrelogin',\n    enter: function enter() {\n      this.emptyMessageBuffer();\n    },\n    events: {\n      socketError: function socketError() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      connectTimeout: function connectTimeout() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      data: function (_data) {\n        function data(_x) {\n          return _data.apply(this, arguments);\n        }\n\n        data.toString = function () {\n          return _data.toString();\n        };\n\n        return data;\n      }(function (data) {\n        this.addToMessageBuffer(data);\n      }),\n      message: function message() {\n        const preloginPayload = new _preloginPayload.default(this.messageBuffer);\n        this.debug.payload(function () {\n          return preloginPayload.toString('  ');\n        });\n\n        if (preloginPayload.fedAuthRequired === 1) {\n          this.fedAuthRequired = true;\n        }\n\n        if (preloginPayload.encryptionString === 'ON' || preloginPayload.encryptionString === 'REQ') {\n          if (!this.config.options.encrypt) {\n            this.emit('connect', (0, _errors.ConnectionError)(\"Server requires encryption, set 'encrypt' config option to true.\", 'EENCRYPT'));\n            return this.close();\n          }\n\n          this.messageIo.startTls(this.secureContext, this.config.server, this.config.options.trustServerCertificate);\n          this.transitionTo(this.STATE.SENT_TLSSSLNEGOTIATION);\n        } else {\n          this.sendLogin7Packet();\n          const authentication = this.config.authentication;\n\n          if (authentication.type === 'ntlm') {\n            this.transitionTo(this.STATE.SENT_LOGIN7_WITH_NTLM);\n          } else {\n            this.transitionTo(this.STATE.SENT_LOGIN7_WITH_STANDARD_LOGIN);\n          }\n        }\n      }\n    }\n  },\n  REROUTING: {\n    name: 'ReRouting',\n    enter: function enter() {\n      this.cleanupConnection(CLEANUP_TYPE.REDIRECT);\n    },\n    events: {\n      message: function message() {},\n      socketError: function socketError() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      connectTimeout: function connectTimeout() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      reconnect: function reconnect() {\n        this.transitionTo(this.STATE.CONNECTING);\n      }\n    }\n  },\n  TRANSIENT_FAILURE_RETRY: {\n    name: 'TRANSIENT_FAILURE_RETRY',\n    enter: function enter() {\n      this.curTransientRetryCount++;\n      this.cleanupConnection(CLEANUP_TYPE.RETRY);\n    },\n    events: {\n      message: function message() {},\n      socketError: function socketError() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      connectTimeout: function connectTimeout() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      retry: function retry() {\n        this.createRetryTimer();\n      }\n    }\n  },\n  SENT_TLSSSLNEGOTIATION: {\n    name: 'SentTLSSSLNegotiation',\n    events: {\n      socketError: function socketError() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      connectTimeout: function connectTimeout() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      data: function (_data2) {\n        function data(_x2) {\n          return _data2.apply(this, arguments);\n        }\n\n        data.toString = function () {\n          return _data2.toString();\n        };\n\n        return data;\n      }(function (data) {\n        this.messageIo.tlsHandshakeData(data);\n      }),\n      message: function message() {\n        if (this.messageIo.tlsNegotiationComplete) {\n          this.sendLogin7Packet();\n          const authentication = this.config.authentication;\n\n          if (authentication.type === 'azure-active-directory-password' || authentication.type === 'azure-active-directory-msi-vm' || authentication.type === 'azure-active-directory-msi-app-service' || authentication.type === 'azure-active-directory-service-principal-secret') {\n            this.transitionTo(this.STATE.SENT_LOGIN7_WITH_FEDAUTH);\n          } else if (authentication.type === 'ntlm') {\n            this.transitionTo(this.STATE.SENT_LOGIN7_WITH_NTLM);\n          } else {\n            this.transitionTo(this.STATE.SENT_LOGIN7_WITH_STANDARD_LOGIN);\n          }\n        }\n      }\n    }\n  },\n  SENT_LOGIN7_WITH_STANDARD_LOGIN: {\n    name: 'SentLogin7WithStandardLogin',\n    events: {\n      socketError: function socketError() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      connectTimeout: function connectTimeout() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      data: function (_data3) {\n        function data(_x3) {\n          return _data3.apply(this, arguments);\n        }\n\n        data.toString = function () {\n          return _data3.toString();\n        };\n\n        return data;\n      }(function (data) {\n        this.sendDataToTokenStreamParser(data);\n      }),\n      routingChange: function routingChange() {\n        this.transitionTo(this.STATE.REROUTING);\n      },\n      featureExtAck: function featureExtAck(token) {\n        const authentication = this.config.authentication;\n\n        if (authentication.type === 'azure-active-directory-password' || authentication.type === 'azure-active-directory-access-token' || authentication.type === 'azure-active-directory-msi-vm' || authentication.type === 'azure-active-directory-msi-app-service' || authentication.type === 'azure-active-directory-service-principal-secret') {\n          if (token.fedAuth === undefined) {\n            this.loginError = (0, _errors.ConnectionError)('Did not receive Active Directory authentication acknowledgement');\n            this.loggedIn = false;\n          } else if (token.fedAuth.length !== 0) {\n            this.loginError = (0, _errors.ConnectionError)(`Active Directory authentication acknowledgment for ${authentication.type} authentication method includes extra data`);\n            this.loggedIn = false;\n          }\n        } else if (token.fedAuth === undefined) {\n          this.loginError = (0, _errors.ConnectionError)('Received acknowledgement for unknown feature');\n          this.loggedIn = false;\n        } else {\n          this.loginError = (0, _errors.ConnectionError)('Did not request Active Directory authentication, but received the acknowledgment');\n          this.loggedIn = false;\n        }\n      },\n      message: function message() {\n        if (this.loggedIn) {\n          this.transitionTo(this.STATE.LOGGED_IN_SENDING_INITIAL_SQL);\n        } else if (this.loginError) {\n          if (this.loginError.isTransient) {\n            this.debug.log('Initiating retry on transient error');\n            this.transitionTo(this.STATE.TRANSIENT_FAILURE_RETRY);\n          } else {\n            this.emit('connect', this.loginError);\n            this.transitionTo(this.STATE.FINAL);\n          }\n        } else {\n          this.emit('connect', (0, _errors.ConnectionError)('Login failed.', 'ELOGIN'));\n          this.transitionTo(this.STATE.FINAL);\n        }\n      }\n    }\n  },\n  SENT_LOGIN7_WITH_NTLM: {\n    name: 'SentLogin7WithNTLMLogin',\n    events: {\n      socketError: function socketError() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      connectTimeout: function connectTimeout() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      data: function (_data4) {\n        function data(_x4) {\n          return _data4.apply(this, arguments);\n        }\n\n        data.toString = function () {\n          return _data4.toString();\n        };\n\n        return data;\n      }(function (data) {\n        this.sendDataToTokenStreamParser(data);\n      }),\n      message: function message() {\n        if (this.ntlmpacket) {\n          const authentication = this.config.authentication;\n          const payload = new _ntlmPayload.default({\n            domain: authentication.options.domain,\n            userName: authentication.options.userName,\n            password: authentication.options.password,\n            ntlmpacket: this.ntlmpacket\n          });\n          this.messageIo.sendMessage(_packet.TYPE.NTLMAUTH_PKT, payload.data);\n          this.debug.payload(function () {\n            return payload.toString('  ');\n          });\n          this.ntlmpacket = undefined;\n        } else if (this.loggedIn) {\n          this.transitionTo(this.STATE.LOGGED_IN_SENDING_INITIAL_SQL);\n        } else if (this.loginError) {\n          if (this.loginError.isTransient) {\n            this.debug.log('Initiating retry on transient error');\n            this.transitionTo(this.STATE.TRANSIENT_FAILURE_RETRY);\n          } else {\n            this.emit('connect', this.loginError);\n            this.transitionTo(this.STATE.FINAL);\n          }\n        } else {\n          this.emit('connect', (0, _errors.ConnectionError)('Login failed.', 'ELOGIN'));\n          this.transitionTo(this.STATE.FINAL);\n        }\n      }\n    }\n  },\n  SENT_LOGIN7_WITH_FEDAUTH: {\n    name: 'SentLogin7Withfedauth',\n    events: {\n      socketError: function socketError() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      connectTimeout: function connectTimeout() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      data: function (_data5) {\n        function data(_x5) {\n          return _data5.apply(this, arguments);\n        }\n\n        data.toString = function () {\n          return _data5.toString();\n        };\n\n        return data;\n      }(function (data) {\n        this.sendDataToTokenStreamParser(data);\n      }),\n      routingChange: function routingChange() {\n        this.transitionTo(this.STATE.REROUTING);\n      },\n      fedAuthInfo: function fedAuthInfo(token) {\n        this.fedAuthInfoToken = token;\n      },\n      message: function message() {\n        const fedAuthInfoToken = this.fedAuthInfoToken;\n\n        if (fedAuthInfoToken && fedAuthInfoToken.stsurl && fedAuthInfoToken.spn) {\n          const authentication = this.config.authentication;\n\n          const getToken = callback => {\n            const getTokenFromCredentials = (err, credentials) => {\n              if (err) {\n                return callback(err);\n              }\n\n              credentials.getToken().then(tokenResponse => {\n                callback(null, tokenResponse.accessToken);\n              }, callback);\n            };\n\n            if (authentication.type === 'azure-active-directory-password') {\n              (0, _msRestNodeauth.loginWithUsernamePassword)(authentication.options.userName, authentication.options.password, {\n                clientId: '7f98cb04-cd1e-40df-9140-3bf7e2cea4db',\n                tokenAudience: fedAuthInfoToken.spn\n              }, getTokenFromCredentials);\n            } else if (authentication.type === 'azure-active-directory-msi-vm') {\n              (0, _msRestNodeauth.loginWithVmMSI)({\n                clientId: authentication.options.clientId,\n                msiEndpoint: authentication.options.msiEndpoint,\n                resource: fedAuthInfoToken.spn\n              }, getTokenFromCredentials);\n            } else if (authentication.type === 'azure-active-directory-msi-app-service') {\n              (0, _msRestNodeauth.loginWithAppServiceMSI)({\n                msiEndpoint: authentication.options.msiEndpoint,\n                msiSecret: authentication.options.msiSecret,\n                resource: fedAuthInfoToken.spn\n              }, getTokenFromCredentials);\n            } else if (authentication.type === 'azure-active-directory-service-principal-secret') {\n              (0, _msRestNodeauth.loginWithServicePrincipalSecret)(authentication.options.clientId, authentication.options.clientSecret, authentication.options.tenantId, {\n                tokenAudience: fedAuthInfoToken.spn\n              }, getTokenFromCredentials);\n            }\n          };\n\n          getToken((err, token) => {\n            if (err) {\n              this.loginError = (0, _errors.ConnectionError)('Security token could not be authenticated or authorized.', 'EFEDAUTH');\n              this.emit('connect', this.loginError);\n              this.transitionTo(this.STATE.FINAL);\n              return;\n            }\n\n            this.sendFedAuthTokenMessage(token);\n          });\n        } else if (this.loginError) {\n          if (this.loginError.isTransient) {\n            this.debug.log('Initiating retry on transient error');\n            this.transitionTo(this.STATE.TRANSIENT_FAILURE_RETRY);\n          } else {\n            this.emit('connect', this.loginError);\n            this.transitionTo(this.STATE.FINAL);\n          }\n        } else {\n          this.emit('connect', (0, _errors.ConnectionError)('Login failed.', 'ELOGIN'));\n          this.transitionTo(this.STATE.FINAL);\n        }\n      }\n    }\n  },\n  LOGGED_IN_SENDING_INITIAL_SQL: {\n    name: 'LoggedInSendingInitialSql',\n    enter: function enter() {\n      this.sendInitialSql();\n    },\n    events: {\n      socketError: function socketError() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      connectTimeout: function connectTimeout() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      data: function (_data6) {\n        function data(_x6) {\n          return _data6.apply(this, arguments);\n        }\n\n        data.toString = function () {\n          return _data6.toString();\n        };\n\n        return data;\n      }(function (data) {\n        this.sendDataToTokenStreamParser(data);\n      }),\n      message: function message() {\n        this.transitionTo(this.STATE.LOGGED_IN);\n        this.processedInitialSql();\n      }\n    }\n  },\n  LOGGED_IN: {\n    name: 'LoggedIn',\n    events: {\n      socketError: function socketError() {\n        this.transitionTo(this.STATE.FINAL);\n      }\n    }\n  },\n  BUILDING_CLIENT_REQUEST: {\n    name: 'BuildingClientRequest',\n    events: {\n      socketError: function socketError(err) {\n        const sqlRequest = this.request;\n        this.request = undefined;\n        this.transitionTo(this.STATE.FINAL);\n        sqlRequest.callback(err);\n      }\n    }\n  },\n  SENT_CLIENT_REQUEST: {\n    name: 'SentClientRequest',\n    exit: function exit(nextState) {\n      this.clearRequestTimer();\n\n      if (nextState !== this.STATE.FINAL) {\n        this.tokenStreamParser.resume();\n      }\n    },\n    events: {\n      socketError: function socketError(err) {\n        const sqlRequest = this.request;\n        this.request = undefined;\n        this.transitionTo(this.STATE.FINAL);\n        sqlRequest.callback(err);\n      },\n      data: function (_data7) {\n        function data(_x7) {\n          return _data7.apply(this, arguments);\n        }\n\n        data.toString = function () {\n          return _data7.toString();\n        };\n\n        return data;\n      }(function (data) {\n        this.clearRequestTimer(); // request timer is stopped on first data package\n\n        const ret = this.sendDataToTokenStreamParser(data);\n\n        if (ret === false) {\n          // Bridge backpressure from the token stream parser transform to the\n          // packet stream transform.\n          this.messageIo.pause();\n        }\n      }),\n      message: function message() {\n        // We have to channel the 'message' (EOM) event through the token stream\n        // parser transform, to keep it in line with the flow of the tokens, when\n        // the incoming data flow is paused and resumed.\n        this.tokenStreamParser.addEndOfMessageMarker();\n      },\n      endOfMessageMarkerReceived: function endOfMessageMarkerReceived() {\n        this.transitionTo(this.STATE.LOGGED_IN);\n        const sqlRequest = this.request;\n        this.request = undefined;\n\n        if (this.config.options.tdsVersion < '7_2' && sqlRequest.error && this.isSqlBatch) {\n          this.inTransaction = false;\n        }\n\n        sqlRequest.callback(sqlRequest.error, sqlRequest.rowCount, sqlRequest.rows);\n      }\n    }\n  },\n  SENT_ATTENTION: {\n    name: 'SentAttention',\n    enter: function enter() {\n      this.attentionReceived = false;\n    },\n    events: {\n      socketError: function socketError(err) {\n        const sqlRequest = this.request;\n        this.request = undefined;\n        this.transitionTo(this.STATE.FINAL);\n        sqlRequest.callback(err);\n      },\n      data: function (_data8) {\n        function data(_x8) {\n          return _data8.apply(this, arguments);\n        }\n\n        data.toString = function () {\n          return _data8.toString();\n        };\n\n        return data;\n      }(function (data) {\n        this.sendDataToTokenStreamParser(data);\n      }),\n      attention: function attention() {\n        this.attentionReceived = true;\n      },\n      message: function message() {\n        // 3.2.5.7 Sent Attention State\n        // Discard any data contained in the response, until we receive the attention response\n        if (this.attentionReceived) {\n          this.clearCancelTimer();\n          const sqlRequest = this.request;\n          this.request = undefined;\n          this.transitionTo(this.STATE.LOGGED_IN);\n\n          if (sqlRequest.error && sqlRequest.error instanceof _errors.RequestError && sqlRequest.error.code === 'ETIMEOUT') {\n            sqlRequest.callback(sqlRequest.error);\n          } else {\n            sqlRequest.callback((0, _errors.RequestError)('Canceled.', 'ECANCEL'));\n          }\n        }\n      }\n    }\n  },\n  FINAL: {\n    name: 'Final',\n    enter: function enter() {\n      this.cleanupConnection(CLEANUP_TYPE.NORMAL);\n    },\n    events: {\n      loginFailed: function loginFailed() {// Do nothing. The connection was probably closed by the client code.\n      },\n      connectTimeout: function connectTimeout() {// Do nothing, as the timer should be cleaned up.\n      },\n      message: function message() {// Do nothing\n      },\n      socketError: function socketError() {// Do nothing\n      }\n    }\n  }\n};","map":{"version":3,"sources":["C:/Projects/sqlsample/node_modules/tedious/lib/connection.js"],"names":["Object","defineProperty","exports","value","default","_crypto","_interopRequireDefault","require","_os","_constants","_tls","_msRestNodeauth","_bulkLoad","_debug","_events","_instanceLookup","_transientErrorLookup","_packet","_preloginPayload","_login7Payload","_ntlmPayload","_request","_rpcrequestPayload","_sqlbatchPayload","_messageIo","_tokenStreamParser","_transaction","_errors","_connector","_library","_tdsVersions","_ntlm","_depd","obj","__esModule","deprecate","KEEP_ALIVE_INITIAL_DELAY","DEFAULT_CONNECT_TIMEOUT","DEFAULT_CLIENT_REQUEST_TIMEOUT","DEFAULT_CANCEL_TIMEOUT","DEFAULT_CONNECT_RETRY_INTERVAL","DEFAULT_PACKET_SIZE","DEFAULT_TEXTSIZE","DEFAULT_DATEFIRST","DEFAULT_PORT","DEFAULT_TDS_VERSION","DEFAULT_LANGUAGE","DEFAULT_DATEFORMAT","CLEANUP_TYPE","NORMAL","REDIRECT","RETRY","Connection","EventEmitter","constructor","config","fedAuthRequired","fedAuthInfoToken","secureContext","inTransaction","transactionDescriptors","transactionDepth","isSqlBatch","curTransientRetryCount","transientErrorLookup","closed","loggedIn","loginError","debug","tokenStreamParser","ntlmpacket","ntlmpacketBuffer","routingData","state","resetConnectionOnNextRequest","attentionReceived","request","procReturnStatusValue","socket","messageBuffer","connectTimer","cancelTimer","requestTimer","retryTimer","TypeError","server","undefined","authentication","type","options","domain","userName","password","toUpperCase","token","clientId","msiEndpoint","msiSecret","clientSecret","tenantId","abortTransactionOnError","appName","camelCaseColumns","cancelTimeout","columnNameReplacer","connectionRetryInterval","connectTimeout","connectionIsolationLevel","ISOLATION_LEVEL","READ_COMMITTED","cryptoCredentialsDetails","database","datefirst","dateFormat","data","packet","payload","enableAnsiNull","enableAnsiNullDefault","enableAnsiPadding","enableAnsiWarnings","enableArithAbort","enableConcatNullYieldsNull","enableCursorCloseOnCommit","enableImplicitTransactions","enableNumericRoundabort","enableQuotedIdentifier","encrypt","fallbackToDefaultDb","instanceName","isolationLevel","language","localAddress","maxRetriesOnTransientErrors","multiSubnetFailover","packetSize","port","readOnlyIntent","requestTimeout","rowCollectionOnDone","rowCollectionOnRequestCompletion","tdsVersion","textsize","trustServerCertificate","useColumnNames","useUTC","lowerCaseGuids","Error","RangeError","credentialsDetails","secureOptions","create","SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS","createSecureContext","createDebug","createTokenStreamParser","Buffer","from","alloc","TransientErrorLookup","STATE","CONNECTING","enter","call","close","transitionTo","FINAL","initialiseConnection","connect","createConnectTimer","cleanupConnection","cleanupType","clearConnectTimer","clearRequestTimer","clearRetryTimer","closeConnection","emit","process","nextTick","err","RequestError","callback","on","message","Parser","canceled","error","number","class","serverName","procName","lineNumber","ConnectionError","isLoginErrorTransient","isTransientError","isTransient","newValue","dispatchEvent","interface","messageIo","push","length","columns","j","len","col","colName","orderColumns","rows","rst","SENT_ATTENTION","paused","paramName","metadata","rowCount","more","attention","sqlError","clearCancelTimer","SENT_CLIENT_REQUEST","resume","connectOnPort","InstanceLookup","instanceLookup","timeout","connectOpts","host","Connector","execute","socketError","destroy","socketClose","socketEnd","setKeepAlive","cleartext","socketConnect","setTimeout","createCancelTimer","createRequestTimer","createRetryTimer","retryTimeout","log","cancel","clearTimeout","newState","name","exit","apply","getEventHandler","eventName","handler","events","args","SENT_TLSSSLNEGOTIATION","code","REROUTING","TRANSIENT_FAILURE_RETRY","sendPreLogin","sendMessage","TYPE","PRELOGIN","toString","emptyMessageBuffer","addToMessageBuffer","concat","sendLogin7Packet","versions","clientProgVer","clientPid","pid","connectionId","clientTimeZone","Date","getTimezoneOffset","clientLcid","fedAuth","echo","workflow","fedAuthToken","sspi","createNTLMRequest","hostname","libraryName","initDbFatal","LOGIN7","toBuffer","sendFedAuthTokenMessage","accessTokenLen","byteLength","offset","writeUInt32LE","write","FEDAUTH_TOKEN","SENT_LOGIN7_WITH_STANDARD_LOGIN","sendDataToTokenStreamParser","addBuffer","pauseRequest","isRequestActive","pause","resumeRequest","sendInitialSql","getInitialSql","currentTransactionDescriptor","getData","SQL_BATCH","getIsolationLevelText","join","processedInitialSql","execSqlBatch","makeRequest","sqlTextOrProcedure","execSql","transformIntoExecuteSqlRpc","RPC_REQUEST","newBulkLoad","table","callbackOrOptions","execBulkLoad","bulkLoad","executionStarted","getBulkInsertSql","BULK_LOAD","once","prepare","transformIntoPrepareRpc","unprepare","transformIntoUnprepareRpc","parameters","transformIntoExecuteRpc","callProcedure","validateParameters","beginTransaction","transaction","Transaction","isolationLevelToTSQL","TRANSACTION_MANAGER","beginPayload","commitTransaction","commitPayload","rollbackTransaction","rollbackPayload","saveTransaction","savePayload","cb","useSavepoint","randomBytes","txDone","done","LOGGED_IN","txErr","packetType","connection","BUILDING_CLIENT_REQUEST","writable","ignore","end","ATTENTION","getMessageStream","streamingMode","rowToPacketTransform","outgoingMessageStream","reset","READ_UNCOMMITTED","REPEATABLE_READ","SERIALIZABLE","SNAPSHOT","_default","module","prototype","SENT_PRELOGIN","_data","_x","arguments","preloginPayload","encryptionString","startTls","SENT_LOGIN7_WITH_NTLM","reconnect","retry","_data2","_x2","tlsHandshakeData","tlsNegotiationComplete","SENT_LOGIN7_WITH_FEDAUTH","_data3","_x3","routingChange","featureExtAck","LOGGED_IN_SENDING_INITIAL_SQL","_data4","_x4","NTLMAUTH_PKT","_data5","_x5","fedAuthInfo","stsurl","spn","getToken","getTokenFromCredentials","credentials","then","tokenResponse","accessToken","loginWithUsernamePassword","tokenAudience","loginWithVmMSI","resource","loginWithAppServiceMSI","loginWithServicePrincipalSecret","_data6","_x6","sqlRequest","nextState","_data7","_x7","ret","addEndOfMessageMarker","endOfMessageMarkerReceived","_data8","_x8","loginFailed"],"mappings":"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","sourcesContent":["\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\n\nvar _crypto = _interopRequireDefault(require(\"crypto\"));\n\nvar _os = _interopRequireDefault(require(\"os\"));\n\nvar _constants = _interopRequireDefault(require(\"constants\"));\n\nvar _tls = require(\"tls\");\n\nvar _msRestNodeauth = require(\"@azure/ms-rest-nodeauth\");\n\nvar _bulkLoad = _interopRequireDefault(require(\"./bulk-load\"));\n\nvar _debug = _interopRequireDefault(require(\"./debug\"));\n\nvar _events = require(\"events\");\n\nvar _instanceLookup = require(\"./instance-lookup\");\n\nvar _transientErrorLookup = require(\"./transient-error-lookup\");\n\nvar _packet = require(\"./packet\");\n\nvar _preloginPayload = _interopRequireDefault(require(\"./prelogin-payload\"));\n\nvar _login7Payload = _interopRequireDefault(require(\"./login7-payload\"));\n\nvar _ntlmPayload = _interopRequireDefault(require(\"./ntlm-payload\"));\n\nvar _request = _interopRequireDefault(require(\"./request\"));\n\nvar _rpcrequestPayload = _interopRequireDefault(require(\"./rpcrequest-payload\"));\n\nvar _sqlbatchPayload = _interopRequireDefault(require(\"./sqlbatch-payload\"));\n\nvar _messageIo = _interopRequireDefault(require(\"./message-io\"));\n\nvar _tokenStreamParser = require(\"./token/token-stream-parser\");\n\nvar _transaction = require(\"./transaction\");\n\nvar _errors = require(\"./errors\");\n\nvar _connector = require(\"./connector\");\n\nvar _library = require(\"./library\");\n\nvar _tdsVersions = require(\"./tds-versions\");\n\nvar _ntlm = require(\"./ntlm\");\n\nvar _depd = _interopRequireDefault(require(\"depd\"));\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nconst deprecate = (0, _depd.default)('tedious'); // A rather basic state machine for managing a connection.\n// Implements something approximating s3.2.1.\n\nconst KEEP_ALIVE_INITIAL_DELAY = 30 * 1000;\nconst DEFAULT_CONNECT_TIMEOUT = 15 * 1000;\nconst DEFAULT_CLIENT_REQUEST_TIMEOUT = 15 * 1000;\nconst DEFAULT_CANCEL_TIMEOUT = 5 * 1000;\nconst DEFAULT_CONNECT_RETRY_INTERVAL = 500;\nconst DEFAULT_PACKET_SIZE = 4 * 1024;\nconst DEFAULT_TEXTSIZE = '2147483647';\nconst DEFAULT_DATEFIRST = 7;\nconst DEFAULT_PORT = 1433;\nconst DEFAULT_TDS_VERSION = '7_4';\nconst DEFAULT_LANGUAGE = 'us_english';\nconst DEFAULT_DATEFORMAT = 'mdy';\nconst CLEANUP_TYPE = {\n  NORMAL: 0,\n  REDIRECT: 1,\n  RETRY: 2\n};\n\nclass Connection extends _events.EventEmitter {\n  constructor(config) {\n    super();\n    this.fedAuthRequired = void 0;\n    this.fedAuthInfoToken = void 0;\n    this.config = void 0;\n    this.secureContext = void 0;\n    this.inTransaction = void 0;\n    this.transactionDescriptors = void 0;\n    this.transactionDepth = void 0;\n    this.isSqlBatch = void 0;\n    this.curTransientRetryCount = void 0;\n    this.transientErrorLookup = void 0;\n    this.closed = void 0;\n    this.loggedIn = void 0;\n    this.loginError = void 0;\n    this.debug = void 0;\n    this.tokenStreamParser = void 0;\n    this.ntlmpacket = void 0;\n    this.ntlmpacketBuffer = void 0;\n    this.routingData = void 0;\n    this.state = void 0;\n    this.resetConnectionOnNextRequest = void 0;\n    this.attentionReceived = void 0;\n    this.request = void 0;\n    this.procReturnStatusValue = void 0;\n    this.socket = void 0;\n    this.messageBuffer = void 0;\n    this.connectTimer = void 0;\n    this.cancelTimer = void 0;\n    this.requestTimer = void 0;\n    this.retryTimer = void 0;\n\n    if (typeof config !== 'object' || config === null) {\n      throw new TypeError('The \"config\" argument is required and must be of type Object.');\n    }\n\n    if (typeof config.server !== 'string') {\n      throw new TypeError('The \"config.server\" property is required and must be of type string.');\n    }\n\n    this.fedAuthRequired = false;\n    this.fedAuthInfoToken = undefined;\n    let authentication;\n\n    if (config.authentication !== undefined) {\n      if (typeof config.authentication !== 'object' || config.authentication === null) {\n        throw new TypeError('The \"config.authentication\" property must be of type Object.');\n      }\n\n      const type = config.authentication.type;\n      const options = config.authentication.options === undefined ? {} : config.authentication.options;\n\n      if (typeof type !== 'string') {\n        throw new TypeError('The \"config.authentication.type\" property must be of type string.');\n      }\n\n      if (type !== 'default' && type !== 'ntlm' && type !== 'azure-active-directory-password' && type !== 'azure-active-directory-access-token' && type !== 'azure-active-directory-msi-vm' && type !== 'azure-active-directory-msi-app-service' && type !== 'azure-active-directory-service-principal-secret') {\n        throw new TypeError('The \"type\" property must one of \"default\", \"ntlm\", \"azure-active-directory-password\", \"azure-active-directory-access-token\", \"azure-active-directory-msi-vm\" or \"azure-active-directory-msi-app-service\" or \"azure-active-directory-service-principal-secret\".');\n      }\n\n      if (typeof options !== 'object' || options === null) {\n        throw new TypeError('The \"config.authentication.options\" property must be of type object.');\n      }\n\n      if (type === 'ntlm') {\n        if (typeof options.domain !== 'string') {\n          throw new TypeError('The \"config.authentication.options.domain\" property must be of type string.');\n        }\n\n        if (options.userName !== undefined && typeof options.userName !== 'string') {\n          throw new TypeError('The \"config.authentication.options.userName\" property must be of type string.');\n        }\n\n        if (options.password !== undefined && typeof options.password !== 'string') {\n          throw new TypeError('The \"config.authentication.options.password\" property must be of type string.');\n        }\n\n        authentication = {\n          type: 'ntlm',\n          options: {\n            userName: options.userName,\n            password: options.password,\n            domain: options.domain && options.domain.toUpperCase()\n          }\n        };\n      } else if (type === 'azure-active-directory-password') {\n        if (options.userName !== undefined && typeof options.userName !== 'string') {\n          throw new TypeError('The \"config.authentication.options.userName\" property must be of type string.');\n        }\n\n        if (options.password !== undefined && typeof options.password !== 'string') {\n          throw new TypeError('The \"config.authentication.options.password\" property must be of type string.');\n        }\n\n        authentication = {\n          type: 'azure-active-directory-password',\n          options: {\n            userName: options.userName,\n            password: options.password\n          }\n        };\n      } else if (type === 'azure-active-directory-access-token') {\n        if (typeof options.token !== 'string') {\n          throw new TypeError('The \"config.authentication.options.token\" property must be of type string.');\n        }\n\n        authentication = {\n          type: 'azure-active-directory-access-token',\n          options: {\n            token: options.token\n          }\n        };\n      } else if (type === 'azure-active-directory-msi-vm') {\n        if (options.clientId !== undefined && typeof options.clientId !== 'string') {\n          throw new TypeError('The \"config.authentication.options.clientId\" property must be of type string.');\n        }\n\n        if (options.msiEndpoint !== undefined && typeof options.msiEndpoint !== 'string') {\n          throw new TypeError('The \"config.authentication.options.msiEndpoint\" property must be of type string.');\n        }\n\n        authentication = {\n          type: 'azure-active-directory-msi-vm',\n          options: {\n            clientId: options.clientId,\n            msiEndpoint: options.msiEndpoint\n          }\n        };\n      } else if (type === 'azure-active-directory-msi-app-service') {\n        if (options.clientId !== undefined && typeof options.clientId !== 'string') {\n          throw new TypeError('The \"config.authentication.options.clientId\" property must be of type string.');\n        }\n\n        if (options.msiEndpoint !== undefined && typeof options.msiEndpoint !== 'string') {\n          throw new TypeError('The \"config.authentication.options.msiEndpoint\" property must be of type string.');\n        }\n\n        if (options.msiSecret !== undefined && typeof options.msiSecret !== 'string') {\n          throw new TypeError('The \"config.authentication.options.msiSecret\" property must be of type string.');\n        }\n\n        authentication = {\n          type: 'azure-active-directory-msi-app-service',\n          options: {\n            clientId: options.clientId,\n            msiEndpoint: options.msiEndpoint,\n            msiSecret: options.msiSecret\n          }\n        };\n      } else if (type === 'azure-active-directory-service-principal-secret') {\n        if (typeof options.clientId !== 'string') {\n          throw new TypeError('The \"config.authentication.options.clientId\" property must be of type string.');\n        }\n\n        if (typeof options.clientSecret !== 'string') {\n          throw new TypeError('The \"config.authentication.options.clientSecret\" property must be of type string.');\n        }\n\n        if (typeof options.tenantId !== 'string') {\n          throw new TypeError('The \"config.authentication.options.tenantId\" property must be of type string.');\n        }\n\n        authentication = {\n          type: 'azure-active-directory-service-principal-secret',\n          options: {\n            clientId: options.clientId,\n            clientSecret: options.clientSecret,\n            tenantId: options.tenantId\n          }\n        };\n      } else {\n        if (options.userName !== undefined && typeof options.userName !== 'string') {\n          throw new TypeError('The \"config.authentication.options.userName\" property must be of type string.');\n        }\n\n        if (options.password !== undefined && typeof options.password !== 'string') {\n          throw new TypeError('The \"config.authentication.options.password\" property must be of type string.');\n        }\n\n        authentication = {\n          type: 'default',\n          options: {\n            userName: options.userName,\n            password: options.password\n          }\n        };\n      }\n    } else {\n      authentication = {\n        type: 'default',\n        options: {\n          userName: undefined,\n          password: undefined\n        }\n      };\n    }\n\n    this.config = {\n      server: config.server,\n      authentication: authentication,\n      options: {\n        abortTransactionOnError: false,\n        appName: undefined,\n        camelCaseColumns: false,\n        cancelTimeout: DEFAULT_CANCEL_TIMEOUT,\n        columnNameReplacer: undefined,\n        connectionRetryInterval: DEFAULT_CONNECT_RETRY_INTERVAL,\n        connectTimeout: DEFAULT_CONNECT_TIMEOUT,\n        connectionIsolationLevel: _transaction.ISOLATION_LEVEL.READ_COMMITTED,\n        cryptoCredentialsDetails: {},\n        database: undefined,\n        datefirst: DEFAULT_DATEFIRST,\n        dateFormat: DEFAULT_DATEFORMAT,\n        debug: {\n          data: false,\n          packet: false,\n          payload: false,\n          token: false\n        },\n        enableAnsiNull: true,\n        enableAnsiNullDefault: true,\n        enableAnsiPadding: true,\n        enableAnsiWarnings: true,\n        enableArithAbort: false,\n        enableConcatNullYieldsNull: true,\n        enableCursorCloseOnCommit: null,\n        enableImplicitTransactions: false,\n        enableNumericRoundabort: false,\n        enableQuotedIdentifier: true,\n        encrypt: true,\n        fallbackToDefaultDb: false,\n        instanceName: undefined,\n        isolationLevel: _transaction.ISOLATION_LEVEL.READ_COMMITTED,\n        language: DEFAULT_LANGUAGE,\n        localAddress: undefined,\n        maxRetriesOnTransientErrors: 3,\n        multiSubnetFailover: false,\n        packetSize: DEFAULT_PACKET_SIZE,\n        port: DEFAULT_PORT,\n        readOnlyIntent: false,\n        requestTimeout: DEFAULT_CLIENT_REQUEST_TIMEOUT,\n        rowCollectionOnDone: false,\n        rowCollectionOnRequestCompletion: false,\n        tdsVersion: DEFAULT_TDS_VERSION,\n        textsize: DEFAULT_TEXTSIZE,\n        trustServerCertificate: true,\n        useColumnNames: false,\n        useUTC: true,\n        lowerCaseGuids: false\n      }\n    };\n\n    if (config.options) {\n      if (config.options.port && config.options.instanceName) {\n        throw new Error('Port and instanceName are mutually exclusive, but ' + config.options.port + ' and ' + config.options.instanceName + ' provided');\n      }\n\n      if (config.options.abortTransactionOnError !== undefined) {\n        if (typeof config.options.abortTransactionOnError !== 'boolean' && config.options.abortTransactionOnError !== null) {\n          throw new TypeError('The \"config.options.abortTransactionOnError\" property must be of type string or null.');\n        }\n\n        this.config.options.abortTransactionOnError = config.options.abortTransactionOnError;\n      }\n\n      if (config.options.appName !== undefined) {\n        if (typeof config.options.appName !== 'string') {\n          throw new TypeError('The \"config.options.appName\" property must be of type string.');\n        }\n\n        this.config.options.appName = config.options.appName;\n      }\n\n      if (config.options.camelCaseColumns !== undefined) {\n        if (typeof config.options.camelCaseColumns !== 'boolean') {\n          throw new TypeError('The \"config.options.camelCaseColumns\" property must be of type boolean.');\n        }\n\n        this.config.options.camelCaseColumns = config.options.camelCaseColumns;\n      }\n\n      if (config.options.cancelTimeout !== undefined) {\n        if (typeof config.options.cancelTimeout !== 'number') {\n          throw new TypeError('The \"config.options.cancelTimeout\" property must be of type number.');\n        }\n\n        this.config.options.cancelTimeout = config.options.cancelTimeout;\n      }\n\n      if (config.options.columnNameReplacer) {\n        if (typeof config.options.columnNameReplacer !== 'function') {\n          throw new TypeError('The \"config.options.cancelTimeout\" property must be of type function.');\n        }\n\n        this.config.options.columnNameReplacer = config.options.columnNameReplacer;\n      }\n\n      if (config.options.connectTimeout !== undefined) {\n        if (typeof config.options.connectTimeout !== 'number') {\n          throw new TypeError('The \"config.options.connectTimeout\" property must be of type number.');\n        }\n\n        this.config.options.connectTimeout = config.options.connectTimeout;\n      }\n\n      if (config.options.connectionIsolationLevel !== undefined) {\n        this.config.options.connectionIsolationLevel = config.options.connectionIsolationLevel;\n      }\n\n      if (config.options.connectTimeout !== undefined) {\n        if (typeof config.options.connectTimeout !== 'number') {\n          throw new TypeError('The \"config.options.connectTimeout\" property must be of type number.');\n        }\n\n        this.config.options.connectTimeout = config.options.connectTimeout;\n      }\n\n      if (config.options.cryptoCredentialsDetails !== undefined) {\n        if (typeof config.options.cryptoCredentialsDetails !== 'object' || config.options.cryptoCredentialsDetails === null) {\n          throw new TypeError('The \"config.options.cryptoCredentialsDetails\" property must be of type Object.');\n        }\n\n        this.config.options.cryptoCredentialsDetails = config.options.cryptoCredentialsDetails;\n      }\n\n      if (config.options.database !== undefined) {\n        if (typeof config.options.database !== 'string') {\n          throw new TypeError('The \"config.options.database\" property must be of type string.');\n        }\n\n        this.config.options.database = config.options.database;\n      }\n\n      if (config.options.datefirst !== undefined) {\n        if (typeof config.options.datefirst !== 'number' && config.options.datefirst !== null) {\n          throw new TypeError('The \"config.options.datefirst\" property must be of type number.');\n        }\n\n        if (config.options.datefirst !== null && (config.options.datefirst < 1 || config.options.datefirst > 7)) {\n          throw new RangeError('The \"config.options.datefirst\" property must be >= 1 and <= 7');\n        }\n\n        this.config.options.datefirst = config.options.datefirst;\n      }\n\n      if (config.options.dateFormat !== undefined) {\n        if (typeof config.options.dateFormat !== 'string' && config.options.dateFormat !== null) {\n          throw new TypeError('The \"config.options.dateFormat\" property must be of type string or null.');\n        }\n\n        this.config.options.dateFormat = config.options.dateFormat;\n      }\n\n      if (config.options.debug) {\n        if (config.options.debug.data !== undefined) {\n          if (typeof config.options.debug.data !== 'boolean') {\n            throw new TypeError('The \"config.options.debug.data\" property must be of type boolean.');\n          }\n\n          this.config.options.debug.data = config.options.debug.data;\n        }\n\n        if (config.options.debug.packet !== undefined) {\n          if (typeof config.options.debug.packet !== 'boolean') {\n            throw new TypeError('The \"config.options.debug.packet\" property must be of type boolean.');\n          }\n\n          this.config.options.debug.packet = config.options.debug.packet;\n        }\n\n        if (config.options.debug.payload !== undefined) {\n          if (typeof config.options.debug.payload !== 'boolean') {\n            throw new TypeError('The \"config.options.debug.payload\" property must be of type boolean.');\n          }\n\n          this.config.options.debug.payload = config.options.debug.payload;\n        }\n\n        if (config.options.debug.token !== undefined) {\n          if (typeof config.options.debug.token !== 'boolean') {\n            throw new TypeError('The \"config.options.debug.token\" property must be of type boolean.');\n          }\n\n          this.config.options.debug.token = config.options.debug.token;\n        }\n      }\n\n      if (config.options.enableAnsiNull !== undefined) {\n        if (typeof config.options.enableAnsiNull !== 'boolean' && config.options.enableAnsiNull !== null) {\n          throw new TypeError('The \"config.options.enableAnsiNull\" property must be of type boolean or null.');\n        }\n\n        this.config.options.enableAnsiNull = config.options.enableAnsiNull;\n      }\n\n      if (config.options.enableAnsiNullDefault !== undefined) {\n        if (typeof config.options.enableAnsiNullDefault !== 'boolean' && config.options.enableAnsiNullDefault !== null) {\n          throw new TypeError('The \"config.options.enableAnsiNullDefault\" property must be of type boolean or null.');\n        }\n\n        this.config.options.enableAnsiNullDefault = config.options.enableAnsiNullDefault;\n      }\n\n      if (config.options.enableAnsiPadding !== undefined) {\n        if (typeof config.options.enableAnsiPadding !== 'boolean' && config.options.enableAnsiPadding !== null) {\n          throw new TypeError('The \"config.options.enableAnsiPadding\" property must be of type boolean or null.');\n        }\n\n        this.config.options.enableAnsiPadding = config.options.enableAnsiPadding;\n      }\n\n      if (config.options.enableAnsiWarnings !== undefined) {\n        if (typeof config.options.enableAnsiWarnings !== 'boolean' && config.options.enableAnsiWarnings !== null) {\n          throw new TypeError('The \"config.options.enableAnsiWarnings\" property must be of type boolean or null.');\n        }\n\n        this.config.options.enableAnsiWarnings = config.options.enableAnsiWarnings;\n      }\n\n      if (config.options.enableArithAbort !== undefined) {\n        if (typeof config.options.enableArithAbort !== 'boolean' && config.options.enableArithAbort !== null) {\n          throw new TypeError('The \"config.options.enableArithAbort\" property must be of type boolean or null.');\n        }\n\n        this.config.options.enableArithAbort = config.options.enableArithAbort;\n      } else {\n        deprecate('The default value for `config.options.enableArithAbort` will change from `false` to `true` in the next major version of `tedious`. Set the value to `true` or `false` explicitly to silence this message.');\n      }\n\n      if (config.options.enableConcatNullYieldsNull !== undefined) {\n        if (typeof config.options.enableConcatNullYieldsNull !== 'boolean' && config.options.enableConcatNullYieldsNull !== null) {\n          throw new TypeError('The \"config.options.enableConcatNullYieldsNull\" property must be of type boolean or null.');\n        }\n\n        this.config.options.enableConcatNullYieldsNull = config.options.enableConcatNullYieldsNull;\n      }\n\n      if (config.options.enableCursorCloseOnCommit !== undefined) {\n        if (typeof config.options.enableCursorCloseOnCommit !== 'boolean' && config.options.enableCursorCloseOnCommit !== null) {\n          throw new TypeError('The \"config.options.enableCursorCloseOnCommit\" property must be of type boolean or null.');\n        }\n\n        this.config.options.enableCursorCloseOnCommit = config.options.enableCursorCloseOnCommit;\n      }\n\n      if (config.options.enableImplicitTransactions !== undefined) {\n        if (typeof config.options.enableImplicitTransactions !== 'boolean' && config.options.enableImplicitTransactions !== null) {\n          throw new TypeError('The \"config.options.enableImplicitTransactions\" property must be of type boolean or null.');\n        }\n\n        this.config.options.enableImplicitTransactions = config.options.enableImplicitTransactions;\n      }\n\n      if (config.options.enableNumericRoundabort !== undefined) {\n        if (typeof config.options.enableNumericRoundabort !== 'boolean' && config.options.enableNumericRoundabort !== null) {\n          throw new TypeError('The \"config.options.enableNumericRoundabort\" property must be of type boolean or null.');\n        }\n\n        this.config.options.enableNumericRoundabort = config.options.enableNumericRoundabort;\n      }\n\n      if (config.options.enableQuotedIdentifier !== undefined) {\n        if (typeof config.options.enableQuotedIdentifier !== 'boolean' && config.options.enableQuotedIdentifier !== null) {\n          throw new TypeError('The \"config.options.enableQuotedIdentifier\" property must be of type boolean or null.');\n        }\n\n        this.config.options.enableQuotedIdentifier = config.options.enableQuotedIdentifier;\n      }\n\n      if (config.options.encrypt !== undefined) {\n        if (typeof config.options.encrypt !== 'boolean') {\n          throw new TypeError('The \"config.options.encrypt\" property must be of type boolean.');\n        }\n\n        this.config.options.encrypt = config.options.encrypt;\n      }\n\n      if (config.options.fallbackToDefaultDb !== undefined) {\n        if (typeof config.options.fallbackToDefaultDb !== 'boolean') {\n          throw new TypeError('The \"config.options.fallbackToDefaultDb\" property must be of type boolean.');\n        }\n\n        this.config.options.fallbackToDefaultDb = config.options.fallbackToDefaultDb;\n      }\n\n      if (config.options.instanceName !== undefined) {\n        if (typeof config.options.instanceName !== 'string') {\n          throw new TypeError('The \"config.options.instanceName\" property must be of type string.');\n        }\n\n        this.config.options.instanceName = config.options.instanceName;\n        this.config.options.port = undefined;\n      }\n\n      if (config.options.isolationLevel !== undefined) {\n        if (typeof config.options.isolationLevel !== 'number') {\n          throw new TypeError('The \"config.options.isolationLevel\" property must be of type number.');\n        }\n\n        this.config.options.isolationLevel = config.options.isolationLevel;\n      }\n\n      if (config.options.language !== undefined) {\n        if (typeof config.options.language !== 'string' && config.options.language !== null) {\n          throw new TypeError('The \"config.options.language\" property must be of type string or null.');\n        }\n\n        this.config.options.language = config.options.language;\n      }\n\n      if (config.options.localAddress !== undefined) {\n        if (typeof config.options.localAddress !== 'string') {\n          throw new TypeError('The \"config.options.localAddress\" property must be of type string.');\n        }\n\n        this.config.options.localAddress = config.options.localAddress;\n      }\n\n      if (config.options.multiSubnetFailover !== undefined) {\n        if (typeof config.options.multiSubnetFailover !== 'boolean') {\n          throw new TypeError('The \"config.options.multiSubnetFailover\" property must be of type boolean.');\n        }\n\n        this.config.options.multiSubnetFailover = config.options.multiSubnetFailover;\n      }\n\n      if (config.options.packetSize !== undefined) {\n        if (typeof config.options.packetSize !== 'number') {\n          throw new TypeError('The \"config.options.packetSize\" property must be of type number.');\n        }\n\n        this.config.options.packetSize = config.options.packetSize;\n      }\n\n      if (config.options.port !== undefined) {\n        if (typeof config.options.port !== 'number') {\n          throw new TypeError('The \"config.options.port\" property must be of type number.');\n        }\n\n        if (config.options.port <= 0 || config.options.port >= 65536) {\n          throw new RangeError('The \"config.options.port\" property must be > 0 and < 65536');\n        }\n\n        this.config.options.port = config.options.port;\n        this.config.options.instanceName = undefined;\n      }\n\n      if (config.options.readOnlyIntent !== undefined) {\n        if (typeof config.options.readOnlyIntent !== 'boolean') {\n          throw new TypeError('The \"config.options.readOnlyIntent\" property must be of type boolean.');\n        }\n\n        this.config.options.readOnlyIntent = config.options.readOnlyIntent;\n      }\n\n      if (config.options.requestTimeout !== undefined) {\n        if (typeof config.options.requestTimeout !== 'number') {\n          throw new TypeError('The \"config.options.requestTimeout\" property must be of type number.');\n        }\n\n        this.config.options.requestTimeout = config.options.requestTimeout;\n      }\n\n      if (config.options.maxRetriesOnTransientErrors !== undefined) {\n        if (typeof config.options.maxRetriesOnTransientErrors !== 'number') {\n          throw new TypeError('The \"config.options.maxRetriesOnTransientErrors\" property must be of type number.');\n        }\n\n        if (config.options.maxRetriesOnTransientErrors < 0) {\n          throw new TypeError('The \"config.options.maxRetriesOnTransientErrors\" property must be equal or greater than 0.');\n        }\n\n        this.config.options.maxRetriesOnTransientErrors = config.options.maxRetriesOnTransientErrors;\n      }\n\n      if (config.options.connectionRetryInterval !== undefined) {\n        if (typeof config.options.connectionRetryInterval !== 'number') {\n          throw new TypeError('The \"config.options.connectionRetryInterval\" property must be of type number.');\n        }\n\n        if (config.options.connectionRetryInterval <= 0) {\n          throw new TypeError('The \"config.options.connectionRetryInterval\" property must be greater than 0.');\n        }\n\n        this.config.options.connectionRetryInterval = config.options.connectionRetryInterval;\n      }\n\n      if (config.options.rowCollectionOnDone !== undefined) {\n        if (typeof config.options.rowCollectionOnDone !== 'boolean') {\n          throw new TypeError('The \"config.options.rowCollectionOnDone\" property must be of type boolean.');\n        }\n\n        this.config.options.rowCollectionOnDone = config.options.rowCollectionOnDone;\n      }\n\n      if (config.options.rowCollectionOnRequestCompletion !== undefined) {\n        if (typeof config.options.rowCollectionOnRequestCompletion !== 'boolean') {\n          throw new TypeError('The \"config.options.rowCollectionOnRequestCompletion\" property must be of type boolean.');\n        }\n\n        this.config.options.rowCollectionOnRequestCompletion = config.options.rowCollectionOnRequestCompletion;\n      }\n\n      if (config.options.tdsVersion !== undefined) {\n        if (typeof config.options.tdsVersion !== 'string') {\n          throw new TypeError('The \"config.options.tdsVersion\" property must be of type string.');\n        }\n\n        this.config.options.tdsVersion = config.options.tdsVersion;\n      }\n\n      if (config.options.textsize !== undefined) {\n        if (typeof config.options.textsize !== 'number' && config.options.textsize !== null) {\n          throw new TypeError('The \"config.options.textsize\" property must be of type number or null.');\n        }\n\n        this.config.options.textsize = config.options.textsize;\n      }\n\n      if (config.options.trustServerCertificate !== undefined) {\n        if (typeof config.options.trustServerCertificate !== 'boolean') {\n          throw new TypeError('The \"config.options.trustServerCertificate\" property must be of type boolean.');\n        }\n\n        this.config.options.trustServerCertificate = config.options.trustServerCertificate;\n      }\n\n      if (config.options.useColumnNames !== undefined) {\n        if (typeof config.options.useColumnNames !== 'boolean') {\n          throw new TypeError('The \"config.options.useColumnNames\" property must be of type boolean.');\n        }\n\n        this.config.options.useColumnNames = config.options.useColumnNames;\n      }\n\n      if (config.options.useUTC !== undefined) {\n        if (typeof config.options.useUTC !== 'boolean') {\n          throw new TypeError('The \"config.options.useUTC\" property must be of type boolean.');\n        }\n\n        this.config.options.useUTC = config.options.useUTC;\n      }\n\n      if (config.options.lowerCaseGuids !== undefined) {\n        if (typeof config.options.lowerCaseGuids !== 'boolean') {\n          throw new TypeError('The \"config.options.lowerCaseGuids\" property must be of type boolean.');\n        }\n\n        this.config.options.lowerCaseGuids = config.options.lowerCaseGuids;\n      }\n    }\n\n    let credentialsDetails = this.config.options.cryptoCredentialsDetails;\n\n    if (credentialsDetails.secureOptions === undefined) {\n      // If the caller has not specified their own `secureOptions`,\n      // we set `SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS` here.\n      // Older SQL Server instances running on older Windows versions have\n      // trouble with the BEAST workaround in OpenSSL.\n      // As BEAST is a browser specific exploit, we can just disable this option here.\n      credentialsDetails = Object.create(credentialsDetails, {\n        secureOptions: {\n          value: _constants.default.SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS\n        }\n      });\n    }\n\n    this.secureContext = (0, _tls.createSecureContext)(credentialsDetails);\n    this.debug = this.createDebug();\n    this.tokenStreamParser = this.createTokenStreamParser();\n    this.inTransaction = false;\n    this.transactionDescriptors = [Buffer.from([0, 0, 0, 0, 0, 0, 0, 0])]; // 'beginTransaction', 'commitTransaction' and 'rollbackTransaction'\n    // events are utilized to maintain inTransaction property state which in\n    // turn is used in managing transactions. These events are only fired for\n    // TDS version 7.2 and beyond. The properties below are used to emulate\n    // equivalent behavior for TDS versions before 7.2.\n\n    this.transactionDepth = 0;\n    this.isSqlBatch = false;\n    this.closed = false;\n    this.loggedIn = false;\n    this.messageBuffer = Buffer.alloc(0);\n    this.curTransientRetryCount = 0;\n    this.transientErrorLookup = new _transientErrorLookup.TransientErrorLookup();\n    this.state = this.STATE.CONNECTING;\n    this.state.enter.call(this);\n  }\n\n  close() {\n    this.transitionTo(this.STATE.FINAL);\n  }\n\n  initialiseConnection() {\n    this.connect();\n    this.createConnectTimer();\n  }\n\n  cleanupConnection(cleanupType) {\n    if (!this.closed) {\n      this.clearConnectTimer();\n      this.clearRequestTimer();\n      this.clearRetryTimer();\n      this.closeConnection();\n\n      if (cleanupType === CLEANUP_TYPE.REDIRECT) {\n        this.emit('rerouting');\n      } else if (cleanupType !== CLEANUP_TYPE.RETRY) {\n        process.nextTick(() => {\n          this.emit('end');\n        });\n      }\n\n      const request = this.request;\n\n      if (request) {\n        const err = (0, _errors.RequestError)('Connection closed before request completed.', 'ECLOSE');\n        request.callback(err);\n        this.request = undefined;\n      }\n\n      this.closed = true;\n      this.loggedIn = false;\n      this.loginError = undefined;\n    }\n  }\n\n  createDebug() {\n    const debug = new _debug.default(this.config.options.debug);\n    debug.on('debug', message => {\n      this.emit('debug', message);\n    });\n    return debug;\n  }\n\n  createTokenStreamParser() {\n    const tokenStreamParser = new _tokenStreamParser.Parser(this.debug, undefined, this.config.options);\n    tokenStreamParser.on('infoMessage', token => {\n      this.emit('infoMessage', token);\n    });\n    tokenStreamParser.on('sspichallenge', token => {\n      if (token.ntlmpacket) {\n        this.ntlmpacket = token.ntlmpacket;\n        this.ntlmpacketBuffer = token.ntlmpacketBuffer;\n      }\n\n      this.emit('sspichallenge', token);\n    });\n    tokenStreamParser.on('errorMessage', token => {\n      this.emit('errorMessage', token);\n\n      if (this.loggedIn) {\n        const request = this.request;\n\n        if (request) {\n          if (!request.canceled) {\n            const error = new _errors.RequestError(token.message, 'EREQUEST');\n            error.number = token.number;\n            error.state = token.state;\n            error.class = token.class;\n            error.serverName = token.serverName;\n            error.procName = token.procName;\n            error.lineNumber = token.lineNumber;\n            request.error = error;\n          }\n        }\n      } else {\n        const error = (0, _errors.ConnectionError)(token.message, 'ELOGIN');\n        const isLoginErrorTransient = this.transientErrorLookup.isTransientError(token.number);\n\n        if (isLoginErrorTransient && this.curTransientRetryCount !== this.config.options.maxRetriesOnTransientErrors) {\n          error.isTransient = true;\n        }\n\n        this.loginError = error;\n      }\n    });\n    tokenStreamParser.on('databaseChange', token => {\n      this.emit('databaseChange', token.newValue);\n    });\n    tokenStreamParser.on('languageChange', token => {\n      this.emit('languageChange', token.newValue);\n    });\n    tokenStreamParser.on('charsetChange', token => {\n      this.emit('charsetChange', token.newValue);\n    });\n    tokenStreamParser.on('fedAuthInfo', token => {\n      this.dispatchEvent('fedAuthInfo', token);\n    });\n    tokenStreamParser.on('featureExtAck', token => {\n      this.dispatchEvent('featureExtAck', token);\n    });\n    tokenStreamParser.on('loginack', token => {\n      if (!token.tdsVersion) {\n        // unsupported TDS version\n        this.loginError = (0, _errors.ConnectionError)('Server responded with unknown TDS version.', 'ETDS');\n        this.loggedIn = false;\n        return;\n      }\n\n      if (!token.interface) {\n        // unsupported interface\n        this.loginError = (0, _errors.ConnectionError)('Server responded with unsupported interface.', 'EINTERFACENOTSUPP');\n        this.loggedIn = false;\n        return;\n      } // use negotiated version\n\n\n      this.config.options.tdsVersion = token.tdsVersion;\n      this.loggedIn = true;\n    });\n    tokenStreamParser.on('routingChange', token => {\n      this.routingData = token.newValue;\n      this.dispatchEvent('routingChange');\n    });\n    tokenStreamParser.on('packetSizeChange', token => {\n      this.messageIo.packetSize(token.newValue);\n    }); // A new top-level transaction was started. This is not fired\n    // for nested transactions.\n\n    tokenStreamParser.on('beginTransaction', token => {\n      this.transactionDescriptors.push(token.newValue);\n      this.inTransaction = true;\n    }); // A top-level transaction was committed. This is not fired\n    // for nested transactions.\n\n    tokenStreamParser.on('commitTransaction', () => {\n      this.transactionDescriptors.length = 1;\n      this.inTransaction = false;\n    }); // A top-level transaction was rolled back. This is not fired\n    // for nested transactions. This is also fired if a batch\n    // aborting error happened that caused a rollback.\n\n    tokenStreamParser.on('rollbackTransaction', () => {\n      this.transactionDescriptors.length = 1; // An outermost transaction was rolled back. Reset the transaction counter\n\n      this.inTransaction = false;\n      this.emit('rollbackTransaction');\n    });\n    tokenStreamParser.on('columnMetadata', token => {\n      const request = this.request;\n\n      if (request) {\n        if (!request.canceled) {\n          if (this.config.options.useColumnNames) {\n            const columns = {};\n\n            for (let j = 0, len = token.columns.length; j < len; j++) {\n              const col = token.columns[j];\n\n              if (columns[col.colName] == null) {\n                columns[col.colName] = col;\n              }\n            }\n\n            request.emit('columnMetadata', columns);\n          } else {\n            request.emit('columnMetadata', token.columns);\n          }\n        }\n      } else {\n        this.emit('error', new Error(\"Received 'columnMetadata' when no sqlRequest is in progress\"));\n        this.close();\n      }\n    });\n    tokenStreamParser.on('order', token => {\n      const request = this.request;\n\n      if (request) {\n        if (!request.canceled) {\n          request.emit('order', token.orderColumns);\n        }\n      } else {\n        this.emit('error', new Error(\"Received 'order' when no sqlRequest is in progress\"));\n        this.close();\n      }\n    });\n    tokenStreamParser.on('row', token => {\n      const request = this.request;\n\n      if (request) {\n        if (!request.canceled) {\n          if (this.config.options.rowCollectionOnRequestCompletion) {\n            request.rows.push(token.columns);\n          }\n\n          if (this.config.options.rowCollectionOnDone) {\n            request.rst.push(token.columns);\n          }\n\n          if (!(this.state === this.STATE.SENT_ATTENTION && request.paused)) {\n            request.emit('row', token.columns);\n          }\n        }\n      } else {\n        this.emit('error', new Error(\"Received 'row' when no sqlRequest is in progress\"));\n        this.close();\n      }\n    });\n    tokenStreamParser.on('returnStatus', token => {\n      const request = this.request;\n\n      if (request) {\n        if (!request.canceled) {\n          // Keep value for passing in 'doneProc' event.\n          this.procReturnStatusValue = token.value;\n        }\n      }\n    });\n    tokenStreamParser.on('returnValue', token => {\n      const request = this.request;\n\n      if (request) {\n        if (!request.canceled) {\n          request.emit('returnValue', token.paramName, token.value, token.metadata);\n        }\n      }\n    });\n    tokenStreamParser.on('doneProc', token => {\n      const request = this.request;\n\n      if (request) {\n        if (!request.canceled) {\n          request.emit('doneProc', token.rowCount, token.more, this.procReturnStatusValue, request.rst);\n          this.procReturnStatusValue = undefined;\n\n          if (token.rowCount !== undefined) {\n            request.rowCount += token.rowCount;\n          }\n\n          if (this.config.options.rowCollectionOnDone) {\n            request.rst = [];\n          }\n        }\n      }\n    });\n    tokenStreamParser.on('doneInProc', token => {\n      const request = this.request;\n\n      if (request) {\n        if (!request.canceled) {\n          request.emit('doneInProc', token.rowCount, token.more, request.rst);\n\n          if (token.rowCount !== undefined) {\n            request.rowCount += token.rowCount;\n          }\n\n          if (this.config.options.rowCollectionOnDone) {\n            request.rst = [];\n          }\n        }\n      }\n    });\n    tokenStreamParser.on('done', token => {\n      const request = this.request;\n\n      if (request) {\n        if (token.attention) {\n          this.dispatchEvent('attention');\n        }\n\n        if (request.canceled) {\n          // If we received a `DONE` token with `DONE_ERROR`, but no previous `ERROR` token,\n          // We assume this is the indication that an in-flight request was canceled.\n          if (token.sqlError && !request.error) {\n            this.clearCancelTimer();\n            request.error = (0, _errors.RequestError)('Canceled.', 'ECANCEL');\n          }\n        } else {\n          if (token.sqlError && !request.error) {\n            // check if the DONE_ERROR flags was set, but an ERROR token was not sent.\n            request.error = (0, _errors.RequestError)('An unknown error has occurred.', 'UNKNOWN');\n          }\n\n          request.emit('done', token.rowCount, token.more, request.rst);\n\n          if (token.rowCount !== undefined) {\n            request.rowCount += token.rowCount;\n          }\n\n          if (this.config.options.rowCollectionOnDone) {\n            request.rst = [];\n          }\n        }\n      }\n    });\n    tokenStreamParser.on('endOfMessage', () => {\n      // EOM pseudo token received\n      if (this.state === this.STATE.SENT_CLIENT_REQUEST) {\n        this.dispatchEvent('endOfMessageMarkerReceived');\n      }\n    });\n    tokenStreamParser.on('resetConnection', () => {\n      this.emit('resetConnection');\n    });\n    tokenStreamParser.on('drain', () => {\n      // Bridge the release of backpressure from the token stream parser\n      // transform to the packet stream transform.\n      this.messageIo.resume();\n    });\n    return tokenStreamParser;\n  }\n\n  connect() {\n    if (this.config.options.port) {\n      return this.connectOnPort(this.config.options.port, this.config.options.multiSubnetFailover);\n    } else {\n      return new _instanceLookup.InstanceLookup().instanceLookup({\n        server: this.config.server,\n        instanceName: this.config.options.instanceName,\n        timeout: this.config.options.connectTimeout\n      }, (message, port) => {\n        if (this.state === this.STATE.FINAL) {\n          return;\n        }\n\n        if (message) {\n          this.emit('connect', (0, _errors.ConnectionError)(message, 'EINSTLOOKUP'));\n        } else {\n          this.connectOnPort(port, this.config.options.multiSubnetFailover);\n        }\n      });\n    }\n  }\n\n  connectOnPort(port, multiSubnetFailover) {\n    const connectOpts = {\n      host: this.routingData ? this.routingData.server : this.config.server,\n      port: this.routingData ? this.routingData.port : port,\n      localAddress: this.config.options.localAddress\n    };\n    new _connector.Connector(connectOpts, multiSubnetFailover).execute((err, socket) => {\n      if (err) {\n        return this.socketError(err);\n      }\n\n      if (this.state === this.STATE.FINAL) {\n        socket.destroy();\n        return;\n      }\n\n      socket.on('error', error => {\n        this.socketError(error);\n      });\n      socket.on('close', () => {\n        this.socketClose();\n      });\n      socket.on('end', () => {\n        this.socketEnd();\n      });\n      socket.setKeepAlive(true, KEEP_ALIVE_INITIAL_DELAY);\n      this.messageIo = new _messageIo.default(socket, this.config.options.packetSize, this.debug);\n      this.messageIo.on('data', data => {\n        this.dispatchEvent('data', data);\n      });\n      this.messageIo.on('message', () => {\n        this.dispatchEvent('message');\n      });\n      this.messageIo.on('secure', cleartext => {\n        this.emit('secure', cleartext);\n      });\n      this.socket = socket;\n      this.socketConnect();\n    });\n  }\n\n  closeConnection() {\n    if (this.socket) {\n      this.socket.destroy();\n    }\n  }\n\n  createConnectTimer() {\n    this.connectTimer = setTimeout(() => {\n      this.connectTimeout();\n    }, this.config.options.connectTimeout);\n  }\n\n  createCancelTimer() {\n    this.clearCancelTimer();\n    const timeout = this.config.options.cancelTimeout;\n\n    if (timeout > 0) {\n      this.cancelTimer = setTimeout(() => {\n        this.cancelTimeout();\n      }, timeout);\n    }\n  }\n\n  createRequestTimer() {\n    this.clearRequestTimer(); // release old timer, just to be safe\n\n    const request = this.request;\n    const timeout = request.timeout !== undefined ? request.timeout : this.config.options.requestTimeout;\n\n    if (timeout) {\n      this.requestTimer = setTimeout(() => {\n        this.requestTimeout();\n      }, timeout);\n    }\n  }\n\n  createRetryTimer() {\n    this.clearRetryTimer();\n    this.retryTimer = setTimeout(() => {\n      this.retryTimeout();\n    }, this.config.options.connectionRetryInterval);\n  }\n\n  connectTimeout() {\n    const message = `Failed to connect to ${this.config.server}${this.config.options.port ? `:${this.config.options.port}` : `\\\\${this.config.options.instanceName}`} in ${this.config.options.connectTimeout}ms`;\n    this.debug.log(message);\n    this.emit('connect', (0, _errors.ConnectionError)(message, 'ETIMEOUT'));\n    this.connectTimer = undefined;\n    this.dispatchEvent('connectTimeout');\n  }\n\n  cancelTimeout() {\n    const message = `Failed to cancel request in ${this.config.options.cancelTimeout}ms`;\n    this.debug.log(message);\n    this.dispatchEvent('socketError', (0, _errors.ConnectionError)(message, 'ETIMEOUT'));\n  }\n\n  requestTimeout() {\n    this.requestTimer = undefined;\n    const request = this.request;\n    request.cancel();\n    const timeout = request.timeout !== undefined ? request.timeout : this.config.options.requestTimeout;\n    const message = 'Timeout: Request failed to complete in ' + timeout + 'ms';\n    request.error = (0, _errors.RequestError)(message, 'ETIMEOUT');\n  }\n\n  retryTimeout() {\n    this.retryTimer = undefined;\n    this.emit('retry');\n    this.transitionTo(this.STATE.CONNECTING);\n  }\n\n  clearConnectTimer() {\n    if (this.connectTimer) {\n      clearTimeout(this.connectTimer);\n    }\n  }\n\n  clearCancelTimer() {\n    if (this.cancelTimer) {\n      clearTimeout(this.cancelTimer);\n    }\n  }\n\n  clearRequestTimer() {\n    if (this.requestTimer) {\n      clearTimeout(this.requestTimer);\n      this.requestTimer = undefined;\n    }\n  }\n\n  clearRetryTimer() {\n    if (this.retryTimer) {\n      clearTimeout(this.retryTimer);\n      this.retryTimer = undefined;\n    }\n  }\n\n  transitionTo(newState) {\n    if (this.state === newState) {\n      this.debug.log('State is already ' + newState.name);\n      return;\n    }\n\n    if (this.state && this.state.exit) {\n      this.state.exit.call(this, newState);\n    }\n\n    this.debug.log('State change: ' + (this.state ? this.state.name : 'undefined') + ' -> ' + newState.name);\n    this.state = newState;\n\n    if (this.state.enter) {\n      this.state.enter.apply(this);\n    }\n  }\n\n  getEventHandler(eventName) {\n    const handler = this.state.events[eventName];\n\n    if (!handler) {\n      throw new Error(`No event '${eventName}' in state '${this.state.name}'`);\n    }\n\n    return handler;\n  }\n\n  dispatchEvent(eventName, ...args) {\n    const handler = this.state.events[eventName];\n\n    if (handler) {\n      handler.apply(this, args);\n    } else {\n      this.emit('error', new Error(`No event '${eventName}' in state '${this.state.name}'`));\n      this.close();\n    }\n  }\n\n  socketError(error) {\n    if (this.state === this.STATE.CONNECTING || this.state === this.STATE.SENT_TLSSSLNEGOTIATION) {\n      const message = `Failed to connect to ${this.config.server}:${this.config.options.port} - ${error.message}`;\n      this.debug.log(message);\n      this.emit('connect', (0, _errors.ConnectionError)(message, 'ESOCKET'));\n    } else {\n      const message = `Connection lost - ${error.message}`;\n      this.debug.log(message);\n      this.emit('error', (0, _errors.ConnectionError)(message, 'ESOCKET'));\n    }\n\n    this.dispatchEvent('socketError', error);\n  }\n\n  socketConnect() {\n    this.closed = false;\n    this.debug.log('connected to ' + this.config.server + ':' + this.config.options.port);\n    this.dispatchEvent('socketConnect');\n  }\n\n  socketEnd() {\n    this.debug.log('socket ended');\n\n    if (this.state !== this.STATE.FINAL) {\n      const error = new Error('socket hang up');\n      error.code = 'ECONNRESET';\n      this.socketError(error);\n    }\n  }\n\n  socketClose() {\n    this.debug.log('connection to ' + this.config.server + ':' + this.config.options.port + ' closed');\n\n    if (this.state === this.STATE.REROUTING) {\n      this.debug.log('Rerouting to ' + this.routingData.server + ':' + this.routingData.port);\n      this.dispatchEvent('reconnect');\n    } else if (this.state === this.STATE.TRANSIENT_FAILURE_RETRY) {\n      const server = this.routingData ? this.routingData.server : this.config.server;\n      const port = this.routingData ? this.routingData.port : this.config.options.port;\n      this.debug.log('Retry after transient failure connecting to ' + server + ':' + port);\n      this.dispatchEvent('retry');\n    } else {\n      this.transitionTo(this.STATE.FINAL);\n    }\n  }\n\n  sendPreLogin() {\n    const payload = new _preloginPayload.default({\n      encrypt: this.config.options.encrypt\n    });\n    this.messageIo.sendMessage(_packet.TYPE.PRELOGIN, payload.data);\n    this.debug.payload(function () {\n      return payload.toString('  ');\n    });\n  }\n\n  emptyMessageBuffer() {\n    this.messageBuffer = Buffer.alloc(0);\n  }\n\n  addToMessageBuffer(data) {\n    this.messageBuffer = Buffer.concat([this.messageBuffer, data]);\n  }\n\n  sendLogin7Packet() {\n    const payload = new _login7Payload.default({\n      tdsVersion: _tdsVersions.versions[this.config.options.tdsVersion],\n      packetSize: this.config.options.packetSize,\n      clientProgVer: 0,\n      clientPid: process.pid,\n      connectionId: 0,\n      clientTimeZone: new Date().getTimezoneOffset(),\n      clientLcid: 0x00000409\n    });\n    const authentication = this.config.authentication;\n\n    switch (authentication.type) {\n      case 'azure-active-directory-password':\n        payload.fedAuth = {\n          type: 'ADAL',\n          echo: this.fedAuthRequired,\n          workflow: 'default'\n        };\n        break;\n\n      case 'azure-active-directory-access-token':\n        payload.fedAuth = {\n          type: 'SECURITYTOKEN',\n          echo: this.fedAuthRequired,\n          fedAuthToken: authentication.options.token\n        };\n        break;\n\n      case 'azure-active-directory-msi-vm':\n      case 'azure-active-directory-msi-app-service':\n      case 'azure-active-directory-service-principal-secret':\n        payload.fedAuth = {\n          type: 'ADAL',\n          echo: this.fedAuthRequired,\n          workflow: 'integrated'\n        };\n        break;\n\n      case 'ntlm':\n        payload.sspi = (0, _ntlm.createNTLMRequest)({\n          domain: authentication.options.domain\n        });\n        break;\n\n      default:\n        payload.userName = authentication.options.userName;\n        payload.password = authentication.options.password;\n    }\n\n    payload.hostname = _os.default.hostname();\n    payload.serverName = this.routingData ? this.routingData.server : this.config.server;\n    payload.appName = this.config.options.appName || 'Tedious';\n    payload.libraryName = _library.name;\n    payload.language = this.config.options.language;\n    payload.database = this.config.options.database;\n    payload.clientId = Buffer.from([1, 2, 3, 4, 5, 6]);\n    payload.readOnlyIntent = this.config.options.readOnlyIntent;\n    payload.initDbFatal = !this.config.options.fallbackToDefaultDb;\n    this.routingData = undefined;\n    this.messageIo.sendMessage(_packet.TYPE.LOGIN7, payload.toBuffer());\n    this.debug.payload(function () {\n      return payload.toString('  ');\n    });\n  }\n\n  sendFedAuthTokenMessage(token) {\n    const accessTokenLen = Buffer.byteLength(token, 'ucs2');\n    const data = Buffer.alloc(8 + accessTokenLen);\n    let offset = 0;\n    offset = data.writeUInt32LE(accessTokenLen + 4, offset);\n    offset = data.writeUInt32LE(accessTokenLen, offset);\n    data.write(token, offset, 'ucs2');\n    this.messageIo.sendMessage(_packet.TYPE.FEDAUTH_TOKEN, data); // sent the fedAuth token message, the rest is similar to standard login 7\n\n    this.transitionTo(this.STATE.SENT_LOGIN7_WITH_STANDARD_LOGIN);\n  } // Returns false to apply backpressure.\n\n\n  sendDataToTokenStreamParser(data) {\n    return this.tokenStreamParser.addBuffer(data);\n  } // This is an internal method that is called from Request.pause().\n  // It has to check whether the passed Request object represents the currently\n  // active request, because the application might have called Request.pause()\n  // on an old inactive Request object.\n\n\n  pauseRequest(request) {\n    if (this.isRequestActive(request)) {\n      this.tokenStreamParser.pause();\n    }\n  } // This is an internal method that is called from Request.resume().\n\n\n  resumeRequest(request) {\n    if (this.isRequestActive(request)) {\n      this.tokenStreamParser.resume();\n    }\n  } // Returns true if the passed request is the currently active request of the connection.\n\n\n  isRequestActive(request) {\n    return request === this.request && this.state === this.STATE.SENT_CLIENT_REQUEST;\n  }\n\n  sendInitialSql() {\n    const payload = new _sqlbatchPayload.default(this.getInitialSql(), this.currentTransactionDescriptor(), this.config.options);\n    payload.getData(data => {\n      return this.messageIo.sendMessage(_packet.TYPE.SQL_BATCH, data);\n    });\n  }\n\n  getInitialSql() {\n    const options = [];\n\n    if (this.config.options.enableAnsiNull === true) {\n      options.push('set ansi_nulls on');\n    } else if (this.config.options.enableAnsiNull === false) {\n      options.push('set ansi_nulls off');\n    }\n\n    if (this.config.options.enableAnsiNullDefault === true) {\n      options.push('set ansi_null_dflt_on on');\n    } else if (this.config.options.enableAnsiNullDefault === false) {\n      options.push('set ansi_null_dflt_on off');\n    }\n\n    if (this.config.options.enableAnsiPadding === true) {\n      options.push('set ansi_padding on');\n    } else if (this.config.options.enableAnsiPadding === false) {\n      options.push('set ansi_padding off');\n    }\n\n    if (this.config.options.enableAnsiWarnings === true) {\n      options.push('set ansi_warnings on');\n    } else if (this.config.options.enableAnsiWarnings === false) {\n      options.push('set ansi_warnings off');\n    }\n\n    if (this.config.options.enableArithAbort === true) {\n      options.push('set arithabort on');\n    } else if (this.config.options.enableArithAbort === false) {\n      options.push('set arithabort off');\n    }\n\n    if (this.config.options.enableConcatNullYieldsNull === true) {\n      options.push('set concat_null_yields_null on');\n    } else if (this.config.options.enableConcatNullYieldsNull === false) {\n      options.push('set concat_null_yields_null off');\n    }\n\n    if (this.config.options.enableCursorCloseOnCommit === true) {\n      options.push('set cursor_close_on_commit on');\n    } else if (this.config.options.enableCursorCloseOnCommit === false) {\n      options.push('set cursor_close_on_commit off');\n    }\n\n    if (this.config.options.datefirst !== null) {\n      options.push(`set datefirst ${this.config.options.datefirst}`);\n    }\n\n    if (this.config.options.dateFormat !== null) {\n      options.push(`set dateformat ${this.config.options.dateFormat}`);\n    }\n\n    if (this.config.options.enableImplicitTransactions === true) {\n      options.push('set implicit_transactions on');\n    } else if (this.config.options.enableImplicitTransactions === false) {\n      options.push('set implicit_transactions off');\n    }\n\n    if (this.config.options.language !== null) {\n      options.push(`set language ${this.config.options.language}`);\n    }\n\n    if (this.config.options.enableNumericRoundabort === true) {\n      options.push('set numeric_roundabort on');\n    } else if (this.config.options.enableNumericRoundabort === false) {\n      options.push('set numeric_roundabort off');\n    }\n\n    if (this.config.options.enableQuotedIdentifier === true) {\n      options.push('set quoted_identifier on');\n    } else if (this.config.options.enableQuotedIdentifier === false) {\n      options.push('set quoted_identifier off');\n    }\n\n    if (this.config.options.textsize !== null) {\n      options.push(`set textsize ${this.config.options.textsize}`);\n    }\n\n    if (this.config.options.connectionIsolationLevel !== null) {\n      options.push(`set transaction isolation level ${this.getIsolationLevelText(this.config.options.connectionIsolationLevel)}`);\n    }\n\n    if (this.config.options.abortTransactionOnError === true) {\n      options.push('set xact_abort on');\n    } else if (this.config.options.abortTransactionOnError === false) {\n      options.push('set xact_abort off');\n    }\n\n    return options.join('\\n');\n  }\n\n  processedInitialSql() {\n    this.clearConnectTimer();\n    this.emit('connect');\n  }\n\n  execSqlBatch(request) {\n    this.makeRequest(request, _packet.TYPE.SQL_BATCH, new _sqlbatchPayload.default(request.sqlTextOrProcedure, this.currentTransactionDescriptor(), this.config.options));\n  }\n\n  execSql(request) {\n    request.transformIntoExecuteSqlRpc();\n    const error = request.error;\n\n    if (error != null) {\n      process.nextTick(() => {\n        this.debug.log(error.message);\n        request.callback(error);\n      });\n      return;\n    }\n\n    this.makeRequest(request, _packet.TYPE.RPC_REQUEST, new _rpcrequestPayload.default(request, this.currentTransactionDescriptor(), this.config.options));\n  }\n  /**\n   @function newBulkLoad\n   @param {string} table - Table's name.\n   @param {Object} [options] - BulkLoad options.\n   @param {boolean} [options.checkConstraints=false] - Honors constraints during bulk load, it is disabled by default.\n   @param {boolean} [options.fireTriggers=false] - Honors insert triggers during bulk load, it is disabled by default.\n   @param {boolean} [options.keepNulls=false] - Honors null value passed, ignores the default values set on table.\n   @param {boolean} [options.tableLock=false] - Places a bulk update(BU) lock on table while performing bulk load. Uses row locks by default.\n   @param {callback} callback - Function to call after BulkLoad executes.\n   */\n\n\n  newBulkLoad(table, callbackOrOptions, callback) {\n    let options;\n\n    if (callback === undefined) {\n      callback = callbackOrOptions;\n      options = {};\n    } else {\n      options = callbackOrOptions;\n    }\n\n    if (typeof options !== 'object') {\n      throw new TypeError('\"options\" argument must be an object');\n    }\n\n    return new _bulkLoad.default(table, this.config.options, options, callback);\n  }\n\n  execBulkLoad(bulkLoad) {\n    bulkLoad.executionStarted = true;\n    const request = new _request.default(bulkLoad.getBulkInsertSql(), error => {\n      if (error) {\n        if (error.code === 'UNKNOWN') {\n          error.message += ' This is likely because the schema of the BulkLoad does not match the schema of the table you are attempting to insert into.';\n        }\n\n        bulkLoad.error = error;\n        bulkLoad.callback(error);\n        return;\n      }\n\n      this.makeRequest(bulkLoad, _packet.TYPE.BULK_LOAD);\n    });\n    bulkLoad.once('cancel', () => {\n      request.cancel();\n    });\n    this.execSqlBatch(request);\n  }\n\n  prepare(request) {\n    request.transformIntoPrepareRpc();\n    this.makeRequest(request, _packet.TYPE.RPC_REQUEST, new _rpcrequestPayload.default(request, this.currentTransactionDescriptor(), this.config.options));\n  }\n\n  unprepare(request) {\n    request.transformIntoUnprepareRpc();\n    this.makeRequest(request, _packet.TYPE.RPC_REQUEST, new _rpcrequestPayload.default(request, this.currentTransactionDescriptor(), this.config.options));\n  }\n\n  execute(request, parameters) {\n    request.transformIntoExecuteRpc(parameters);\n    const error = request.error;\n\n    if (error != null) {\n      process.nextTick(() => {\n        this.debug.log(error.message);\n        request.callback(error);\n      });\n      return;\n    }\n\n    this.makeRequest(request, _packet.TYPE.RPC_REQUEST, new _rpcrequestPayload.default(request, this.currentTransactionDescriptor(), this.config.options));\n  }\n\n  callProcedure(request) {\n    request.validateParameters();\n    const error = request.error;\n\n    if (error != null) {\n      process.nextTick(() => {\n        this.debug.log(error.message);\n        request.callback(error);\n      });\n      return;\n    }\n\n    this.makeRequest(request, _packet.TYPE.RPC_REQUEST, new _rpcrequestPayload.default(request, this.currentTransactionDescriptor(), this.config.options));\n  }\n\n  beginTransaction(callback, name = '', isolationLevel = this.config.options.isolationLevel) {\n    const transaction = new _transaction.Transaction(name, isolationLevel);\n\n    if (this.config.options.tdsVersion < '7_2') {\n      return this.execSqlBatch(new _request.default('SET TRANSACTION ISOLATION LEVEL ' + transaction.isolationLevelToTSQL() + ';BEGIN TRAN ' + transaction.name, err => {\n        this.transactionDepth++;\n\n        if (this.transactionDepth === 1) {\n          this.inTransaction = true;\n        }\n\n        callback(err);\n      }));\n    }\n\n    const request = new _request.default(undefined, err => {\n      return callback(err, this.currentTransactionDescriptor());\n    });\n    return this.makeRequest(request, _packet.TYPE.TRANSACTION_MANAGER, transaction.beginPayload(this.currentTransactionDescriptor()));\n  }\n\n  commitTransaction(callback, name = '') {\n    const transaction = new _transaction.Transaction(name);\n\n    if (this.config.options.tdsVersion < '7_2') {\n      return this.execSqlBatch(new _request.default('COMMIT TRAN ' + transaction.name, err => {\n        this.transactionDepth--;\n\n        if (this.transactionDepth === 0) {\n          this.inTransaction = false;\n        }\n\n        callback(err);\n      }));\n    }\n\n    const request = new _request.default(undefined, callback);\n    return this.makeRequest(request, _packet.TYPE.TRANSACTION_MANAGER, transaction.commitPayload(this.currentTransactionDescriptor()));\n  }\n\n  rollbackTransaction(callback, name = '') {\n    const transaction = new _transaction.Transaction(name);\n\n    if (this.config.options.tdsVersion < '7_2') {\n      return this.execSqlBatch(new _request.default('ROLLBACK TRAN ' + transaction.name, err => {\n        this.transactionDepth--;\n\n        if (this.transactionDepth === 0) {\n          this.inTransaction = false;\n        }\n\n        callback(err);\n      }));\n    }\n\n    const request = new _request.default(undefined, callback);\n    return this.makeRequest(request, _packet.TYPE.TRANSACTION_MANAGER, transaction.rollbackPayload(this.currentTransactionDescriptor()));\n  }\n\n  saveTransaction(callback, name) {\n    const transaction = new _transaction.Transaction(name);\n\n    if (this.config.options.tdsVersion < '7_2') {\n      return this.execSqlBatch(new _request.default('SAVE TRAN ' + transaction.name, err => {\n        this.transactionDepth++;\n        callback(err);\n      }));\n    }\n\n    const request = new _request.default(undefined, callback);\n    return this.makeRequest(request, _packet.TYPE.TRANSACTION_MANAGER, transaction.savePayload(this.currentTransactionDescriptor()));\n  }\n\n  transaction(cb, isolationLevel) {\n    if (typeof cb !== 'function') {\n      throw new TypeError('`cb` must be a function');\n    }\n\n    const useSavepoint = this.inTransaction;\n\n    const name = '_tedious_' + _crypto.default.randomBytes(10).toString('hex');\n\n    const txDone = (err, done, ...args) => {\n      if (err) {\n        if (this.inTransaction && this.state === this.STATE.LOGGED_IN) {\n          this.rollbackTransaction(txErr => {\n            done(txErr || err, ...args);\n          }, name);\n        } else {\n          done(err, ...args);\n        }\n      } else if (useSavepoint) {\n        if (this.config.options.tdsVersion < '7_2') {\n          this.transactionDepth--;\n        }\n\n        done(null, ...args);\n      } else {\n        this.commitTransaction(txErr => {\n          done(txErr, ...args);\n        }, name);\n      }\n    };\n\n    if (useSavepoint) {\n      return this.saveTransaction(err => {\n        if (err) {\n          return cb(err);\n        }\n\n        if (isolationLevel) {\n          return this.execSqlBatch(new _request.default('SET transaction isolation level ' + this.getIsolationLevelText(isolationLevel), err => {\n            return cb(err, txDone);\n          }));\n        } else {\n          return cb(null, txDone);\n        }\n      }, name);\n    } else {\n      return this.beginTransaction(err => {\n        if (err) {\n          return cb(err);\n        }\n\n        return cb(null, txDone);\n      }, name, isolationLevel);\n    }\n  }\n\n  makeRequest(request, packetType, payload) {\n    if (this.state !== this.STATE.LOGGED_IN) {\n      const message = 'Requests can only be made in the ' + this.STATE.LOGGED_IN.name + ' state, not the ' + this.state.name + ' state';\n      this.debug.log(message);\n      request.callback((0, _errors.RequestError)(message, 'EINVALIDSTATE'));\n    } else if (request.canceled) {\n      process.nextTick(() => {\n        request.callback((0, _errors.RequestError)('Canceled.', 'ECANCEL'));\n      });\n    } else {\n      if (packetType === _packet.TYPE.SQL_BATCH) {\n        this.isSqlBatch = true;\n      } else {\n        this.isSqlBatch = false;\n      }\n\n      this.request = request;\n      request.connection = this;\n      request.rowCount = 0;\n      request.rows = [];\n      request.rst = [];\n      let message;\n      request.once('cancel', () => {\n        if (!this.isRequestActive(request)) {\n          // Cancel was called on a request that is no longer active on this connection\n          return;\n        } // There's three ways to handle request cancelation:\n\n\n        if (this.state === this.STATE.BUILDING_CLIENT_REQUEST) {\n          // The request was cancelled before buffering finished\n          this.request = undefined;\n          request.callback((0, _errors.RequestError)('Canceled.', 'ECANCEL'));\n          this.transitionTo(this.STATE.LOGGED_IN);\n        } else if (message.writable) {\n          // - if the message is still writable, we'll set the ignore bit\n          //   and end the message.\n          message.ignore = true;\n          message.end();\n        } else {\n          // - but if the message has been ended (and thus has been fully sent off),\n          //   we need to send an `ATTENTION` message to the server\n          this.messageIo.sendMessage(_packet.TYPE.ATTENTION);\n          this.transitionTo(this.STATE.SENT_ATTENTION);\n        }\n\n        this.clearRequestTimer();\n        this.createCancelTimer();\n      });\n\n      if (request instanceof _bulkLoad.default) {\n        message = request.getMessageStream(); // If the bulkload was not put into streaming mode by the user,\n        // we end the rowToPacketTransform here for them.\n        //\n        // If it was put into streaming mode, it's the user's responsibility\n        // to end the stream.\n\n        if (!request.streamingMode) {\n          request.rowToPacketTransform.end();\n        }\n\n        this.messageIo.outgoingMessageStream.write(message);\n        this.transitionTo(this.STATE.SENT_CLIENT_REQUEST);\n\n        if (request.paused) {\n          // Request.pause() has been called before the request was started\n          this.pauseRequest(request);\n        }\n      } else {\n        this.createRequestTimer(); // Transition to an intermediate state to ensure that no new requests\n        // are made on the connection while the buffer is being populated.\n\n        this.transitionTo(this.STATE.BUILDING_CLIENT_REQUEST);\n        payload.getData(data => {\n          if (this.state !== this.STATE.BUILDING_CLIENT_REQUEST) {\n            // Something else has happened on the connection since starting to\n            // build the request. That state change should have invoked the\n            // request handler so there is nothing to do at this point.\n            return;\n          }\n\n          message = this.messageIo.sendMessage(packetType, data, this.resetConnectionOnNextRequest);\n          this.resetConnectionOnNextRequest = false;\n          this.debug.payload(function () {\n            return payload.toString('  ');\n          });\n          this.transitionTo(this.STATE.SENT_CLIENT_REQUEST);\n\n          if (request.paused) {\n            // Request.pause() has been called before the request was started\n            this.pauseRequest(request);\n          }\n        });\n      }\n    }\n  }\n\n  cancel() {\n    if (!this.request) {\n      return false;\n    }\n\n    if (this.request.canceled) {\n      return false;\n    }\n\n    this.request.cancel();\n    return true;\n  }\n\n  reset(callback) {\n    const request = new _request.default(this.getInitialSql(), err => {\n      if (this.config.options.tdsVersion < '7_2') {\n        this.inTransaction = false;\n      }\n\n      callback(err);\n    });\n    this.resetConnectionOnNextRequest = true;\n    this.execSqlBatch(request);\n  }\n\n  currentTransactionDescriptor() {\n    return this.transactionDescriptors[this.transactionDescriptors.length - 1];\n  }\n\n  getIsolationLevelText(isolationLevel) {\n    switch (isolationLevel) {\n      case _transaction.ISOLATION_LEVEL.READ_UNCOMMITTED:\n        return 'read uncommitted';\n\n      case _transaction.ISOLATION_LEVEL.REPEATABLE_READ:\n        return 'repeatable read';\n\n      case _transaction.ISOLATION_LEVEL.SERIALIZABLE:\n        return 'serializable';\n\n      case _transaction.ISOLATION_LEVEL.SNAPSHOT:\n        return 'snapshot';\n\n      default:\n        return 'read committed';\n    }\n  }\n\n}\n\nvar _default = Connection;\nexports.default = _default;\nmodule.exports = Connection;\nConnection.prototype.STATE = {\n  CONNECTING: {\n    name: 'Connecting',\n    enter: function enter() {\n      this.initialiseConnection();\n    },\n    events: {\n      socketError: function socketError() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      connectTimeout: function connectTimeout() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      socketConnect: function socketConnect() {\n        this.sendPreLogin();\n        this.transitionTo(this.STATE.SENT_PRELOGIN);\n      }\n    }\n  },\n  SENT_PRELOGIN: {\n    name: 'SentPrelogin',\n    enter: function enter() {\n      this.emptyMessageBuffer();\n    },\n    events: {\n      socketError: function socketError() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      connectTimeout: function connectTimeout() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      data: function (_data) {\n        function data(_x) {\n          return _data.apply(this, arguments);\n        }\n\n        data.toString = function () {\n          return _data.toString();\n        };\n\n        return data;\n      }(function (data) {\n        this.addToMessageBuffer(data);\n      }),\n      message: function message() {\n        const preloginPayload = new _preloginPayload.default(this.messageBuffer);\n        this.debug.payload(function () {\n          return preloginPayload.toString('  ');\n        });\n\n        if (preloginPayload.fedAuthRequired === 1) {\n          this.fedAuthRequired = true;\n        }\n\n        if (preloginPayload.encryptionString === 'ON' || preloginPayload.encryptionString === 'REQ') {\n          if (!this.config.options.encrypt) {\n            this.emit('connect', (0, _errors.ConnectionError)(\"Server requires encryption, set 'encrypt' config option to true.\", 'EENCRYPT'));\n            return this.close();\n          }\n\n          this.messageIo.startTls(this.secureContext, this.config.server, this.config.options.trustServerCertificate);\n          this.transitionTo(this.STATE.SENT_TLSSSLNEGOTIATION);\n        } else {\n          this.sendLogin7Packet();\n          const authentication = this.config.authentication;\n\n          if (authentication.type === 'ntlm') {\n            this.transitionTo(this.STATE.SENT_LOGIN7_WITH_NTLM);\n          } else {\n            this.transitionTo(this.STATE.SENT_LOGIN7_WITH_STANDARD_LOGIN);\n          }\n        }\n      }\n    }\n  },\n  REROUTING: {\n    name: 'ReRouting',\n    enter: function enter() {\n      this.cleanupConnection(CLEANUP_TYPE.REDIRECT);\n    },\n    events: {\n      message: function message() {},\n      socketError: function socketError() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      connectTimeout: function connectTimeout() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      reconnect: function reconnect() {\n        this.transitionTo(this.STATE.CONNECTING);\n      }\n    }\n  },\n  TRANSIENT_FAILURE_RETRY: {\n    name: 'TRANSIENT_FAILURE_RETRY',\n    enter: function enter() {\n      this.curTransientRetryCount++;\n      this.cleanupConnection(CLEANUP_TYPE.RETRY);\n    },\n    events: {\n      message: function message() {},\n      socketError: function socketError() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      connectTimeout: function connectTimeout() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      retry: function retry() {\n        this.createRetryTimer();\n      }\n    }\n  },\n  SENT_TLSSSLNEGOTIATION: {\n    name: 'SentTLSSSLNegotiation',\n    events: {\n      socketError: function socketError() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      connectTimeout: function connectTimeout() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      data: function (_data2) {\n        function data(_x2) {\n          return _data2.apply(this, arguments);\n        }\n\n        data.toString = function () {\n          return _data2.toString();\n        };\n\n        return data;\n      }(function (data) {\n        this.messageIo.tlsHandshakeData(data);\n      }),\n      message: function message() {\n        if (this.messageIo.tlsNegotiationComplete) {\n          this.sendLogin7Packet();\n          const authentication = this.config.authentication;\n\n          if (authentication.type === 'azure-active-directory-password' || authentication.type === 'azure-active-directory-msi-vm' || authentication.type === 'azure-active-directory-msi-app-service' || authentication.type === 'azure-active-directory-service-principal-secret') {\n            this.transitionTo(this.STATE.SENT_LOGIN7_WITH_FEDAUTH);\n          } else if (authentication.type === 'ntlm') {\n            this.transitionTo(this.STATE.SENT_LOGIN7_WITH_NTLM);\n          } else {\n            this.transitionTo(this.STATE.SENT_LOGIN7_WITH_STANDARD_LOGIN);\n          }\n        }\n      }\n    }\n  },\n  SENT_LOGIN7_WITH_STANDARD_LOGIN: {\n    name: 'SentLogin7WithStandardLogin',\n    events: {\n      socketError: function socketError() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      connectTimeout: function connectTimeout() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      data: function (_data3) {\n        function data(_x3) {\n          return _data3.apply(this, arguments);\n        }\n\n        data.toString = function () {\n          return _data3.toString();\n        };\n\n        return data;\n      }(function (data) {\n        this.sendDataToTokenStreamParser(data);\n      }),\n      routingChange: function routingChange() {\n        this.transitionTo(this.STATE.REROUTING);\n      },\n      featureExtAck: function featureExtAck(token) {\n        const authentication = this.config.authentication;\n\n        if (authentication.type === 'azure-active-directory-password' || authentication.type === 'azure-active-directory-access-token' || authentication.type === 'azure-active-directory-msi-vm' || authentication.type === 'azure-active-directory-msi-app-service' || authentication.type === 'azure-active-directory-service-principal-secret') {\n          if (token.fedAuth === undefined) {\n            this.loginError = (0, _errors.ConnectionError)('Did not receive Active Directory authentication acknowledgement');\n            this.loggedIn = false;\n          } else if (token.fedAuth.length !== 0) {\n            this.loginError = (0, _errors.ConnectionError)(`Active Directory authentication acknowledgment for ${authentication.type} authentication method includes extra data`);\n            this.loggedIn = false;\n          }\n        } else if (token.fedAuth === undefined) {\n          this.loginError = (0, _errors.ConnectionError)('Received acknowledgement for unknown feature');\n          this.loggedIn = false;\n        } else {\n          this.loginError = (0, _errors.ConnectionError)('Did not request Active Directory authentication, but received the acknowledgment');\n          this.loggedIn = false;\n        }\n      },\n      message: function message() {\n        if (this.loggedIn) {\n          this.transitionTo(this.STATE.LOGGED_IN_SENDING_INITIAL_SQL);\n        } else if (this.loginError) {\n          if (this.loginError.isTransient) {\n            this.debug.log('Initiating retry on transient error');\n            this.transitionTo(this.STATE.TRANSIENT_FAILURE_RETRY);\n          } else {\n            this.emit('connect', this.loginError);\n            this.transitionTo(this.STATE.FINAL);\n          }\n        } else {\n          this.emit('connect', (0, _errors.ConnectionError)('Login failed.', 'ELOGIN'));\n          this.transitionTo(this.STATE.FINAL);\n        }\n      }\n    }\n  },\n  SENT_LOGIN7_WITH_NTLM: {\n    name: 'SentLogin7WithNTLMLogin',\n    events: {\n      socketError: function socketError() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      connectTimeout: function connectTimeout() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      data: function (_data4) {\n        function data(_x4) {\n          return _data4.apply(this, arguments);\n        }\n\n        data.toString = function () {\n          return _data4.toString();\n        };\n\n        return data;\n      }(function (data) {\n        this.sendDataToTokenStreamParser(data);\n      }),\n      message: function message() {\n        if (this.ntlmpacket) {\n          const authentication = this.config.authentication;\n          const payload = new _ntlmPayload.default({\n            domain: authentication.options.domain,\n            userName: authentication.options.userName,\n            password: authentication.options.password,\n            ntlmpacket: this.ntlmpacket\n          });\n          this.messageIo.sendMessage(_packet.TYPE.NTLMAUTH_PKT, payload.data);\n          this.debug.payload(function () {\n            return payload.toString('  ');\n          });\n          this.ntlmpacket = undefined;\n        } else if (this.loggedIn) {\n          this.transitionTo(this.STATE.LOGGED_IN_SENDING_INITIAL_SQL);\n        } else if (this.loginError) {\n          if (this.loginError.isTransient) {\n            this.debug.log('Initiating retry on transient error');\n            this.transitionTo(this.STATE.TRANSIENT_FAILURE_RETRY);\n          } else {\n            this.emit('connect', this.loginError);\n            this.transitionTo(this.STATE.FINAL);\n          }\n        } else {\n          this.emit('connect', (0, _errors.ConnectionError)('Login failed.', 'ELOGIN'));\n          this.transitionTo(this.STATE.FINAL);\n        }\n      }\n    }\n  },\n  SENT_LOGIN7_WITH_FEDAUTH: {\n    name: 'SentLogin7Withfedauth',\n    events: {\n      socketError: function socketError() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      connectTimeout: function connectTimeout() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      data: function (_data5) {\n        function data(_x5) {\n          return _data5.apply(this, arguments);\n        }\n\n        data.toString = function () {\n          return _data5.toString();\n        };\n\n        return data;\n      }(function (data) {\n        this.sendDataToTokenStreamParser(data);\n      }),\n      routingChange: function routingChange() {\n        this.transitionTo(this.STATE.REROUTING);\n      },\n      fedAuthInfo: function fedAuthInfo(token) {\n        this.fedAuthInfoToken = token;\n      },\n      message: function message() {\n        const fedAuthInfoToken = this.fedAuthInfoToken;\n\n        if (fedAuthInfoToken && fedAuthInfoToken.stsurl && fedAuthInfoToken.spn) {\n          const authentication = this.config.authentication;\n\n          const getToken = callback => {\n            const getTokenFromCredentials = (err, credentials) => {\n              if (err) {\n                return callback(err);\n              }\n\n              credentials.getToken().then(tokenResponse => {\n                callback(null, tokenResponse.accessToken);\n              }, callback);\n            };\n\n            if (authentication.type === 'azure-active-directory-password') {\n              (0, _msRestNodeauth.loginWithUsernamePassword)(authentication.options.userName, authentication.options.password, {\n                clientId: '7f98cb04-cd1e-40df-9140-3bf7e2cea4db',\n                tokenAudience: fedAuthInfoToken.spn\n              }, getTokenFromCredentials);\n            } else if (authentication.type === 'azure-active-directory-msi-vm') {\n              (0, _msRestNodeauth.loginWithVmMSI)({\n                clientId: authentication.options.clientId,\n                msiEndpoint: authentication.options.msiEndpoint,\n                resource: fedAuthInfoToken.spn\n              }, getTokenFromCredentials);\n            } else if (authentication.type === 'azure-active-directory-msi-app-service') {\n              (0, _msRestNodeauth.loginWithAppServiceMSI)({\n                msiEndpoint: authentication.options.msiEndpoint,\n                msiSecret: authentication.options.msiSecret,\n                resource: fedAuthInfoToken.spn\n              }, getTokenFromCredentials);\n            } else if (authentication.type === 'azure-active-directory-service-principal-secret') {\n              (0, _msRestNodeauth.loginWithServicePrincipalSecret)(authentication.options.clientId, authentication.options.clientSecret, authentication.options.tenantId, {\n                tokenAudience: fedAuthInfoToken.spn\n              }, getTokenFromCredentials);\n            }\n          };\n\n          getToken((err, token) => {\n            if (err) {\n              this.loginError = (0, _errors.ConnectionError)('Security token could not be authenticated or authorized.', 'EFEDAUTH');\n              this.emit('connect', this.loginError);\n              this.transitionTo(this.STATE.FINAL);\n              return;\n            }\n\n            this.sendFedAuthTokenMessage(token);\n          });\n        } else if (this.loginError) {\n          if (this.loginError.isTransient) {\n            this.debug.log('Initiating retry on transient error');\n            this.transitionTo(this.STATE.TRANSIENT_FAILURE_RETRY);\n          } else {\n            this.emit('connect', this.loginError);\n            this.transitionTo(this.STATE.FINAL);\n          }\n        } else {\n          this.emit('connect', (0, _errors.ConnectionError)('Login failed.', 'ELOGIN'));\n          this.transitionTo(this.STATE.FINAL);\n        }\n      }\n    }\n  },\n  LOGGED_IN_SENDING_INITIAL_SQL: {\n    name: 'LoggedInSendingInitialSql',\n    enter: function enter() {\n      this.sendInitialSql();\n    },\n    events: {\n      socketError: function socketError() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      connectTimeout: function connectTimeout() {\n        this.transitionTo(this.STATE.FINAL);\n      },\n      data: function (_data6) {\n        function data(_x6) {\n          return _data6.apply(this, arguments);\n        }\n\n        data.toString = function () {\n          return _data6.toString();\n        };\n\n        return data;\n      }(function (data) {\n        this.sendDataToTokenStreamParser(data);\n      }),\n      message: function message() {\n        this.transitionTo(this.STATE.LOGGED_IN);\n        this.processedInitialSql();\n      }\n    }\n  },\n  LOGGED_IN: {\n    name: 'LoggedIn',\n    events: {\n      socketError: function socketError() {\n        this.transitionTo(this.STATE.FINAL);\n      }\n    }\n  },\n  BUILDING_CLIENT_REQUEST: {\n    name: 'BuildingClientRequest',\n    events: {\n      socketError: function socketError(err) {\n        const sqlRequest = this.request;\n        this.request = undefined;\n        this.transitionTo(this.STATE.FINAL);\n        sqlRequest.callback(err);\n      }\n    }\n  },\n  SENT_CLIENT_REQUEST: {\n    name: 'SentClientRequest',\n    exit: function exit(nextState) {\n      this.clearRequestTimer();\n\n      if (nextState !== this.STATE.FINAL) {\n        this.tokenStreamParser.resume();\n      }\n    },\n    events: {\n      socketError: function socketError(err) {\n        const sqlRequest = this.request;\n        this.request = undefined;\n        this.transitionTo(this.STATE.FINAL);\n        sqlRequest.callback(err);\n      },\n      data: function (_data7) {\n        function data(_x7) {\n          return _data7.apply(this, arguments);\n        }\n\n        data.toString = function () {\n          return _data7.toString();\n        };\n\n        return data;\n      }(function (data) {\n        this.clearRequestTimer(); // request timer is stopped on first data package\n\n        const ret = this.sendDataToTokenStreamParser(data);\n\n        if (ret === false) {\n          // Bridge backpressure from the token stream parser transform to the\n          // packet stream transform.\n          this.messageIo.pause();\n        }\n      }),\n      message: function message() {\n        // We have to channel the 'message' (EOM) event through the token stream\n        // parser transform, to keep it in line with the flow of the tokens, when\n        // the incoming data flow is paused and resumed.\n        this.tokenStreamParser.addEndOfMessageMarker();\n      },\n      endOfMessageMarkerReceived: function endOfMessageMarkerReceived() {\n        this.transitionTo(this.STATE.LOGGED_IN);\n        const sqlRequest = this.request;\n        this.request = undefined;\n\n        if (this.config.options.tdsVersion < '7_2' && sqlRequest.error && this.isSqlBatch) {\n          this.inTransaction = false;\n        }\n\n        sqlRequest.callback(sqlRequest.error, sqlRequest.rowCount, sqlRequest.rows);\n      }\n    }\n  },\n  SENT_ATTENTION: {\n    name: 'SentAttention',\n    enter: function enter() {\n      this.attentionReceived = false;\n    },\n    events: {\n      socketError: function socketError(err) {\n        const sqlRequest = this.request;\n        this.request = undefined;\n        this.transitionTo(this.STATE.FINAL);\n        sqlRequest.callback(err);\n      },\n      data: function (_data8) {\n        function data(_x8) {\n          return _data8.apply(this, arguments);\n        }\n\n        data.toString = function () {\n          return _data8.toString();\n        };\n\n        return data;\n      }(function (data) {\n        this.sendDataToTokenStreamParser(data);\n      }),\n      attention: function attention() {\n        this.attentionReceived = true;\n      },\n      message: function message() {\n        // 3.2.5.7 Sent Attention State\n        // Discard any data contained in the response, until we receive the attention response\n        if (this.attentionReceived) {\n          this.clearCancelTimer();\n          const sqlRequest = this.request;\n          this.request = undefined;\n          this.transitionTo(this.STATE.LOGGED_IN);\n\n          if (sqlRequest.error && sqlRequest.error instanceof _errors.RequestError && sqlRequest.error.code === 'ETIMEOUT') {\n            sqlRequest.callback(sqlRequest.error);\n          } else {\n            sqlRequest.callback((0, _errors.RequestError)('Canceled.', 'ECANCEL'));\n          }\n        }\n      }\n    }\n  },\n  FINAL: {\n    name: 'Final',\n    enter: function enter() {\n      this.cleanupConnection(CLEANUP_TYPE.NORMAL);\n    },\n    events: {\n      loginFailed: function loginFailed() {// Do nothing. The connection was probably closed by the client code.\n      },\n      connectTimeout: function connectTimeout() {// Do nothing, as the timer should be cleaned up.\n      },\n      message: function message() {// Do nothing\n      },\n      socketError: function socketError() {// Do nothing\n      }\n    }\n  }\n};"]},"metadata":{},"sourceType":"script"}