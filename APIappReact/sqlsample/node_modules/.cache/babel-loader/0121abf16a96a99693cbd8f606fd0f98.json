{"ast":null,"code":"'use strict';\n\nconst debug = require('debug')('mssql:base');\n\nconst {\n  EventEmitter\n} = require('events');\n\nconst {\n  IDS,\n  objectHasProperty\n} = require('../utils');\n\nconst globalConnection = require('../global-connection');\n\nconst {\n  RequestError,\n  ConnectionError\n} = require('../error');\n\nconst {\n  TYPES\n} = require('../datatypes');\n\nconst shared = require('../shared');\n/**\r\n * Class Request.\r\n *\r\n * @property {Transaction} transaction Reference to transaction when request was created in transaction.\r\n * @property {*} parameters Collection of input and output parameters.\r\n * @property {Boolean} canceled `true` if request was canceled.\r\n *\r\n * @fires Request#recordset\r\n * @fires Request#row\r\n * @fires Request#done\r\n * @fires Request#error\r\n */\n\n\nclass Request extends EventEmitter {\n  /**\r\n   * Create new Request.\r\n   *\r\n   * @param {Connection|ConnectionPool|Transaction|PreparedStatement} parent If ommited, global connection is used instead.\r\n   */\n  constructor(parent) {\n    super();\n    IDS.add(this, 'Request');\n    debug('request(%d): created', IDS.get(this));\n    this.canceled = false;\n    this._paused = false;\n    this.parent = parent || globalConnection.pool;\n    this.parameters = {};\n  }\n\n  get paused() {\n    return this._paused;\n  }\n  /**\r\n   * Generate sql string and set imput parameters from tagged template string.\r\n   *\r\n   * @param {Template literal} template\r\n   * @return {String}\r\n   */\n\n\n  template() {\n    const values = Array.prototype.slice.call(arguments);\n    const strings = values.shift();\n    return this._template(strings, values);\n  }\n  /**\r\n   * Fetch request from tagged template string.\r\n   *\r\n   * @private\r\n   * @param {Array} strings\r\n   * @param {Array} values\r\n   * @param {String} [method] If provided, method is automatically called with serialized command on this object.\r\n   * @return {Request}\r\n   */\n\n\n  _template(strings, values, method) {\n    const command = [strings[0]];\n\n    for (let index = 0; index < values.length; index++) {\n      const value = values[index]; // if value is an array, prepare each items as it's own comma separated parameter\n\n      if (Array.isArray(value)) {\n        for (let parameterIndex = 0; parameterIndex < value.length; parameterIndex++) {\n          this.input(`param${index + 1}_${parameterIndex}`, value[parameterIndex]);\n          command.push(`@param${index + 1}_${parameterIndex}`);\n\n          if (parameterIndex < value.length - 1) {\n            command.push(', ');\n          }\n        }\n\n        command.push(strings[index + 1]);\n      } else {\n        this.input(`param${index + 1}`, value);\n        command.push(`@param${index + 1}`, strings[index + 1]);\n      }\n    }\n\n    if (method) {\n      return this[method](command.join(''));\n    } else {\n      return command.join('');\n    }\n  }\n  /**\r\n   * Add an input parameter to the request.\r\n   *\r\n   * @param {String} name Name of the input parameter without @ char.\r\n   * @param {*} [type] SQL data type of input parameter. If you omit type, module automaticaly decide which SQL data type should be used based on JS data type.\r\n   * @param {*} value Input parameter value. `undefined` and `NaN` values are automatically converted to `null` values.\r\n   * @return {Request}\r\n   */\n\n\n  input(name, type, value) {\n    if (/(--| |\\/\\*|\\*\\/|')/.test(name)) {\n      throw new RequestError(`SQL injection warning for param '${name}'`, 'EINJECT');\n    }\n\n    if (arguments.length < 2) {\n      throw new RequestError('Invalid number of arguments. At least 2 arguments expected.', 'EARGS');\n    } else if (arguments.length === 2) {\n      value = type;\n      type = shared.getTypeByValue(value);\n    } // support for custom data types\n\n\n    if (value && typeof value.valueOf === 'function' && !(value instanceof Date)) value = value.valueOf();\n    if (value === undefined) value = null; // undefined to null\n\n    if (typeof value === 'number' && isNaN(value)) value = null; // NaN to null\n\n    if (type instanceof Function) type = type();\n\n    if (objectHasProperty(this.parameters, name)) {\n      throw new RequestError(`The parameter name ${name} has already been declared. Parameter names must be unique`, 'EDUPEPARAM');\n    }\n\n    this.parameters[name] = {\n      name,\n      type: type.type,\n      io: 1,\n      value,\n      length: type.length,\n      scale: type.scale,\n      precision: type.precision,\n      tvpType: type.tvpType\n    };\n    return this;\n  }\n  /**\r\n   * Replace an input parameter on the request.\r\n   *\r\n   * @param {String} name Name of the input parameter without @ char.\r\n   * @param {*} [type] SQL data type of input parameter. If you omit type, module automaticaly decide which SQL data type should be used based on JS data type.\r\n   * @param {*} value Input parameter value. `undefined` and `NaN` values are automatically converted to `null` values.\r\n   * @return {Request}\r\n   */\n\n\n  replaceInput(name, type, value) {\n    delete this.parameters[name];\n    return this.input(name, type, value);\n  }\n  /**\r\n   * Add an output parameter to the request.\r\n   *\r\n   * @param {String} name Name of the output parameter without @ char.\r\n   * @param {*} type SQL data type of output parameter.\r\n   * @param {*} [value] Output parameter value initial value. `undefined` and `NaN` values are automatically converted to `null` values. Optional.\r\n   * @return {Request}\r\n   */\n\n\n  output(name, type, value) {\n    if (!type) {\n      type = TYPES.NVarChar;\n    }\n\n    if (/(--| |\\/\\*|\\*\\/|')/.test(name)) {\n      throw new RequestError(`SQL injection warning for param '${name}'`, 'EINJECT');\n    }\n\n    if (type === TYPES.Text || type === TYPES.NText || type === TYPES.Image) {\n      throw new RequestError('Deprecated types (Text, NText, Image) are not supported as OUTPUT parameters.', 'EDEPRECATED');\n    } // support for custom data types\n\n\n    if (value && typeof value.valueOf === 'function' && !(value instanceof Date)) value = value.valueOf();\n    if (value === undefined) value = null; // undefined to null\n\n    if (typeof value === 'number' && isNaN(value)) value = null; // NaN to null\n\n    if (type instanceof Function) type = type();\n\n    if (objectHasProperty(this.parameters, name)) {\n      throw new RequestError(`The parameter name ${name} has already been declared. Parameter names must be unique`, 'EDUPEPARAM');\n    }\n\n    this.parameters[name] = {\n      name,\n      type: type.type,\n      io: 2,\n      value,\n      length: type.length,\n      scale: type.scale,\n      precision: type.precision\n    };\n    return this;\n  }\n  /**\r\n   * Replace an output parameter on the request.\r\n   *\r\n   * @param {String} name Name of the output parameter without @ char.\r\n   * @param {*} type SQL data type of output parameter.\r\n   * @param {*} [value] Output parameter value initial value. `undefined` and `NaN` values are automatically converted to `null` values. Optional.\r\n   * @return {Request}\r\n   */\n\n\n  replaceOutput(name, type, value) {\n    delete this.parameters[name];\n    return this.output(name, type, value);\n  }\n  /**\r\n   * Execute the SQL batch.\r\n   *\r\n   * @param {String} batch T-SQL batch to be executed.\r\n   * @param {Request~requestCallback} [callback] A callback which is called after execution has completed, or an error has occurred. If omited, method returns Promise.\r\n   * @return {Request|Promise}\r\n   */\n\n\n  batch(batch, callback) {\n    if (this.stream == null && this.connection) this.stream = this.connection.config.stream;\n    this.rowsAffected = 0;\n\n    if (typeof callback === 'function') {\n      this._batch(batch, (err, recordsets, output, rowsAffected) => {\n        if (this.stream) {\n          if (err) this.emit('error', err);\n          err = null;\n          this.emit('done', {\n            output,\n            rowsAffected\n          });\n        }\n\n        if (err) return callback(err);\n        callback(null, {\n          recordsets,\n          recordset: recordsets && recordsets[0],\n          output,\n          rowsAffected\n        });\n      });\n\n      return this;\n    } // Check is method was called as tagged template\n\n\n    if (typeof batch === 'object') {\n      const values = Array.prototype.slice.call(arguments);\n      const strings = values.shift();\n      batch = this._template(strings, values);\n    }\n\n    return new shared.Promise((resolve, reject) => {\n      this._batch(batch, (err, recordsets, output, rowsAffected) => {\n        if (this.stream) {\n          if (err) this.emit('error', err);\n          err = null;\n          this.emit('done', {\n            output,\n            rowsAffected\n          });\n        }\n\n        if (err) return reject(err);\n        resolve({\n          recordsets,\n          recordset: recordsets && recordsets[0],\n          output,\n          rowsAffected\n        });\n      });\n    });\n  }\n  /**\r\n   * @private\r\n   * @param {String} batch\r\n   * @param {Request~requestCallback} callback\r\n   */\n\n\n  _batch(batch, callback) {\n    if (!this.connection) {\n      return setImmediate(callback, new RequestError('No connection is specified for that request.', 'ENOCONN'));\n    }\n\n    if (!this.connection.connected) {\n      return setImmediate(callback, new ConnectionError('Connection is closed.', 'ECONNCLOSED'));\n    }\n\n    this.canceled = false;\n    setImmediate(callback);\n  }\n  /**\r\n   * Bulk load.\r\n   *\r\n   * @param {Table} table SQL table.\r\n   * @param {object} [options] Options to be passed to the underlying driver (tedious only).\r\n   * @param {Request~bulkCallback} [callback] A callback which is called after bulk load has completed, or an error has occurred. If omited, method returns Promise.\r\n   * @return {Request|Promise}\r\n   */\n\n\n  bulk(table, options, callback) {\n    if (typeof options === 'function') {\n      callback = options;\n      options = {};\n    } else if (typeof options === 'undefined') {\n      options = {};\n    }\n\n    if (this.stream == null && this.connection) this.stream = this.connection.config.stream;\n\n    if (this.stream || typeof callback === 'function') {\n      this._bulk(table, options, (err, rowsAffected) => {\n        if (this.stream) {\n          if (err) this.emit('error', err);\n          return this.emit('done', {\n            rowsAffected\n          });\n        }\n\n        if (err) return callback(err);\n        callback(null, {\n          rowsAffected\n        });\n      });\n\n      return this;\n    }\n\n    return new shared.Promise((resolve, reject) => {\n      this._bulk(table, options, (err, rowsAffected) => {\n        if (err) return reject(err);\n        resolve({\n          rowsAffected\n        });\n      });\n    });\n  }\n  /**\r\n   * @private\r\n   * @param {Table} table\r\n   * @param {object} options\r\n   * @param {Request~bulkCallback} callback\r\n   */\n\n\n  _bulk(table, options, callback) {\n    if (!this.parent) {\n      return setImmediate(callback, new RequestError('No connection is specified for that request.', 'ENOCONN'));\n    }\n\n    if (!this.parent.connected) {\n      return setImmediate(callback, new ConnectionError('Connection is closed.', 'ECONNCLOSED'));\n    }\n\n    this.canceled = false;\n    setImmediate(callback);\n  }\n  /**\r\n   * Sets request to `stream` mode and pulls all rows from all recordsets to a given stream.\r\n   *\r\n   * @param {Stream} stream Stream to pipe data into.\r\n   * @return {Stream}\r\n   */\n\n\n  pipe(stream) {\n    this.stream = true;\n    this.on('row', stream.write.bind(stream));\n    this.on('error', stream.emit.bind(stream, 'error'));\n    this.on('done', () => {\n      setImmediate(() => stream.end());\n    });\n    stream.emit('pipe', this);\n    return stream;\n  }\n  /**\r\n   * Execute the SQL command.\r\n   *\r\n   * @param {String} command T-SQL command to be executed.\r\n   * @param {Request~requestCallback} [callback] A callback which is called after execution has completed, or an error has occurred. If omited, method returns Promise.\r\n   * @return {Request|Promise}\r\n   */\n\n\n  query(command, callback) {\n    if (this.stream == null && this.connection) this.stream = this.connection.config.stream;\n    this.rowsAffected = 0;\n\n    if (typeof callback === 'function') {\n      this._query(command, (err, recordsets, output, rowsAffected) => {\n        if (this.stream) {\n          if (err) this.emit('error', err);\n          err = null;\n          this.emit('done', {\n            output,\n            rowsAffected\n          });\n        }\n\n        if (err) return callback(err);\n        callback(null, {\n          recordsets,\n          recordset: recordsets && recordsets[0],\n          output,\n          rowsAffected\n        });\n      });\n\n      return this;\n    } // Check is method was called as tagged template\n\n\n    if (typeof command === 'object') {\n      const values = Array.prototype.slice.call(arguments);\n      const strings = values.shift();\n      command = this._template(strings, values);\n    }\n\n    return new shared.Promise((resolve, reject) => {\n      this._query(command, (err, recordsets, output, rowsAffected) => {\n        if (this.stream) {\n          if (err) this.emit('error', err);\n          err = null;\n          this.emit('done', {\n            output,\n            rowsAffected\n          });\n        }\n\n        if (err) return reject(err);\n        resolve({\n          recordsets,\n          recordset: recordsets && recordsets[0],\n          output,\n          rowsAffected\n        });\n      });\n    });\n  }\n  /**\r\n   * @private\r\n   * @param {String} command\r\n   * @param {Request~bulkCallback} callback\r\n   */\n\n\n  _query(command, callback) {\n    if (!this.parent) {\n      return setImmediate(callback, new RequestError('No connection is specified for that request.', 'ENOCONN'));\n    }\n\n    if (!this.parent.connected) {\n      return setImmediate(callback, new ConnectionError('Connection is closed.', 'ECONNCLOSED'));\n    }\n\n    this.canceled = false;\n    setImmediate(callback);\n  }\n  /**\r\n   * Call a stored procedure.\r\n   *\r\n   * @param {String} procedure Name of the stored procedure to be executed.\r\n   * @param {Request~requestCallback} [callback] A callback which is called after execution has completed, or an error has occurred. If omited, method returns Promise.\r\n   * @return {Request|Promise}\r\n   */\n\n\n  execute(command, callback) {\n    if (this.stream == null && this.connection) this.stream = this.connection.config.stream;\n    this.rowsAffected = 0;\n\n    if (typeof callback === 'function') {\n      this._execute(command, (err, recordsets, output, returnValue, rowsAffected) => {\n        if (this.stream) {\n          if (err) this.emit('error', err);\n          err = null;\n          this.emit('done', {\n            output,\n            rowsAffected,\n            returnValue\n          });\n        }\n\n        if (err) return callback(err);\n        callback(null, {\n          recordsets,\n          recordset: recordsets && recordsets[0],\n          output,\n          rowsAffected,\n          returnValue\n        });\n      });\n\n      return this;\n    }\n\n    return new shared.Promise((resolve, reject) => {\n      this._execute(command, (err, recordsets, output, returnValue, rowsAffected) => {\n        if (this.stream) {\n          if (err) this.emit('error', err);\n          err = null;\n          this.emit('done', {\n            output,\n            rowsAffected,\n            returnValue\n          });\n        }\n\n        if (err) return reject(err);\n        resolve({\n          recordsets,\n          recordset: recordsets && recordsets[0],\n          output,\n          rowsAffected,\n          returnValue\n        });\n      });\n    });\n  }\n  /**\r\n   * @private\r\n   * @param {String} procedure\r\n   * @param {Request~bulkCallback} callback\r\n   */\n\n\n  _execute(procedure, callback) {\n    if (!this.parent) {\n      return setImmediate(callback, new RequestError('No connection is specified for that request.', 'ENOCONN'));\n    }\n\n    if (!this.parent.connected) {\n      return setImmediate(callback, new ConnectionError('Connection is closed.', 'ECONNCLOSED'));\n    }\n\n    this.canceled = false;\n    setImmediate(callback);\n  }\n  /**\r\n   * Cancel currently executed request.\r\n   *\r\n   * @return {Boolean}\r\n   */\n\n\n  cancel() {\n    this._cancel();\n\n    return true;\n  }\n  /**\r\n   * @private\r\n   */\n\n\n  _cancel() {\n    this.canceled = true;\n  }\n\n  pause() {\n    if (this.stream) {\n      this._pause();\n\n      return true;\n    }\n\n    return false;\n  }\n\n  _pause() {\n    this._paused = true;\n  }\n\n  resume() {\n    if (this.stream) {\n      this._resume();\n\n      return true;\n    }\n\n    return false;\n  }\n\n  _resume() {\n    this._paused = false;\n  }\n\n  _setCurrentRequest(request) {\n    this._currentRequest = request;\n\n    if (this._paused) {\n      this.pause();\n    }\n\n    return this;\n  }\n\n}\n\nmodule.exports = Request;","map":{"version":3,"sources":["C:/Projects/sqlsample/node_modules/mssql/lib/base/request.js"],"names":["debug","require","EventEmitter","IDS","objectHasProperty","globalConnection","RequestError","ConnectionError","TYPES","shared","Request","constructor","parent","add","get","canceled","_paused","pool","parameters","paused","template","values","Array","prototype","slice","call","arguments","strings","shift","_template","method","command","index","length","value","isArray","parameterIndex","input","push","join","name","type","test","getTypeByValue","valueOf","Date","undefined","isNaN","Function","io","scale","precision","tvpType","replaceInput","output","NVarChar","Text","NText","Image","replaceOutput","batch","callback","stream","connection","config","rowsAffected","_batch","err","recordsets","emit","recordset","Promise","resolve","reject","setImmediate","connected","bulk","table","options","_bulk","pipe","on","write","bind","end","query","_query","execute","_execute","returnValue","procedure","cancel","_cancel","pause","_pause","resume","_resume","_setCurrentRequest","request","_currentRequest","module","exports"],"mappings":"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","sourcesContent":["'use strict'\r\n\r\nconst debug = require('debug')('mssql:base')\r\nconst { EventEmitter } = require('events')\r\nconst { IDS, objectHasProperty } = require('../utils')\r\nconst globalConnection = require('../global-connection')\r\nconst { RequestError, ConnectionError } = require('../error')\r\nconst { TYPES } = require('../datatypes')\r\nconst shared = require('../shared')\r\n\r\n/**\r\n * Class Request.\r\n *\r\n * @property {Transaction} transaction Reference to transaction when request was created in transaction.\r\n * @property {*} parameters Collection of input and output parameters.\r\n * @property {Boolean} canceled `true` if request was canceled.\r\n *\r\n * @fires Request#recordset\r\n * @fires Request#row\r\n * @fires Request#done\r\n * @fires Request#error\r\n */\r\n\r\nclass Request extends EventEmitter {\r\n  /**\r\n   * Create new Request.\r\n   *\r\n   * @param {Connection|ConnectionPool|Transaction|PreparedStatement} parent If ommited, global connection is used instead.\r\n   */\r\n\r\n  constructor (parent) {\r\n    super()\r\n\r\n    IDS.add(this, 'Request')\r\n    debug('request(%d): created', IDS.get(this))\r\n\r\n    this.canceled = false\r\n    this._paused = false\r\n    this.parent = parent || globalConnection.pool\r\n    this.parameters = {}\r\n  }\r\n\r\n  get paused () {\r\n    return this._paused\r\n  }\r\n\r\n  /**\r\n   * Generate sql string and set imput parameters from tagged template string.\r\n   *\r\n   * @param {Template literal} template\r\n   * @return {String}\r\n   */\r\n  template () {\r\n    const values = Array.prototype.slice.call(arguments)\r\n    const strings = values.shift()\r\n    return this._template(strings, values)\r\n  }\r\n\r\n  /**\r\n   * Fetch request from tagged template string.\r\n   *\r\n   * @private\r\n   * @param {Array} strings\r\n   * @param {Array} values\r\n   * @param {String} [method] If provided, method is automatically called with serialized command on this object.\r\n   * @return {Request}\r\n   */\r\n\r\n  _template (strings, values, method) {\r\n    const command = [strings[0]]\r\n\r\n    for (let index = 0; index < values.length; index++) {\r\n      const value = values[index]\r\n      // if value is an array, prepare each items as it's own comma separated parameter\r\n      if (Array.isArray(value)) {\r\n        for (let parameterIndex = 0; parameterIndex < value.length; parameterIndex++) {\r\n          this.input(`param${index + 1}_${parameterIndex}`, value[parameterIndex])\r\n          command.push(`@param${index + 1}_${parameterIndex}`)\r\n          if (parameterIndex < value.length - 1) {\r\n            command.push(', ')\r\n          }\r\n        }\r\n        command.push(strings[index + 1])\r\n      } else {\r\n        this.input(`param${index + 1}`, value)\r\n        command.push(`@param${index + 1}`, strings[index + 1])\r\n      }\r\n    }\r\n\r\n    if (method) {\r\n      return this[method](command.join(''))\r\n    } else {\r\n      return command.join('')\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add an input parameter to the request.\r\n   *\r\n   * @param {String} name Name of the input parameter without @ char.\r\n   * @param {*} [type] SQL data type of input parameter. If you omit type, module automaticaly decide which SQL data type should be used based on JS data type.\r\n   * @param {*} value Input parameter value. `undefined` and `NaN` values are automatically converted to `null` values.\r\n   * @return {Request}\r\n   */\r\n\r\n  input (name, type, value) {\r\n    if ((/(--| |\\/\\*|\\*\\/|')/).test(name)) {\r\n      throw new RequestError(`SQL injection warning for param '${name}'`, 'EINJECT')\r\n    }\r\n\r\n    if (arguments.length < 2) {\r\n      throw new RequestError('Invalid number of arguments. At least 2 arguments expected.', 'EARGS')\r\n    } else if (arguments.length === 2) {\r\n      value = type\r\n      type = shared.getTypeByValue(value)\r\n    }\r\n\r\n    // support for custom data types\r\n    if (value && typeof value.valueOf === 'function' && !(value instanceof Date)) value = value.valueOf()\r\n\r\n    if (value === undefined) value = null // undefined to null\r\n    if (typeof value === 'number' && isNaN(value)) value = null // NaN to null\r\n    if (type instanceof Function) type = type()\r\n\r\n    if (objectHasProperty(this.parameters, name)) {\r\n      throw new RequestError(`The parameter name ${name} has already been declared. Parameter names must be unique`, 'EDUPEPARAM')\r\n    }\r\n\r\n    this.parameters[name] = {\r\n      name,\r\n      type: type.type,\r\n      io: 1,\r\n      value,\r\n      length: type.length,\r\n      scale: type.scale,\r\n      precision: type.precision,\r\n      tvpType: type.tvpType\r\n    }\r\n\r\n    return this\r\n  }\r\n\r\n  /**\r\n   * Replace an input parameter on the request.\r\n   *\r\n   * @param {String} name Name of the input parameter without @ char.\r\n   * @param {*} [type] SQL data type of input parameter. If you omit type, module automaticaly decide which SQL data type should be used based on JS data type.\r\n   * @param {*} value Input parameter value. `undefined` and `NaN` values are automatically converted to `null` values.\r\n   * @return {Request}\r\n   */\r\n\r\n  replaceInput (name, type, value) {\r\n    delete this.parameters[name]\r\n\r\n    return this.input(name, type, value)\r\n  }\r\n\r\n  /**\r\n   * Add an output parameter to the request.\r\n   *\r\n   * @param {String} name Name of the output parameter without @ char.\r\n   * @param {*} type SQL data type of output parameter.\r\n   * @param {*} [value] Output parameter value initial value. `undefined` and `NaN` values are automatically converted to `null` values. Optional.\r\n   * @return {Request}\r\n   */\r\n\r\n  output (name, type, value) {\r\n    if (!type) { type = TYPES.NVarChar }\r\n\r\n    if ((/(--| |\\/\\*|\\*\\/|')/).test(name)) {\r\n      throw new RequestError(`SQL injection warning for param '${name}'`, 'EINJECT')\r\n    }\r\n\r\n    if ((type === TYPES.Text) || (type === TYPES.NText) || (type === TYPES.Image)) {\r\n      throw new RequestError('Deprecated types (Text, NText, Image) are not supported as OUTPUT parameters.', 'EDEPRECATED')\r\n    }\r\n\r\n    // support for custom data types\r\n    if (value && typeof value.valueOf === 'function' && !(value instanceof Date)) value = value.valueOf()\r\n\r\n    if (value === undefined) value = null // undefined to null\r\n    if (typeof value === 'number' && isNaN(value)) value = null // NaN to null\r\n    if (type instanceof Function) type = type()\r\n\r\n    if (objectHasProperty(this.parameters, name)) {\r\n      throw new RequestError(`The parameter name ${name} has already been declared. Parameter names must be unique`, 'EDUPEPARAM')\r\n    }\r\n\r\n    this.parameters[name] = {\r\n      name,\r\n      type: type.type,\r\n      io: 2,\r\n      value,\r\n      length: type.length,\r\n      scale: type.scale,\r\n      precision: type.precision\r\n    }\r\n\r\n    return this\r\n  }\r\n\r\n  /**\r\n   * Replace an output parameter on the request.\r\n   *\r\n   * @param {String} name Name of the output parameter without @ char.\r\n   * @param {*} type SQL data type of output parameter.\r\n   * @param {*} [value] Output parameter value initial value. `undefined` and `NaN` values are automatically converted to `null` values. Optional.\r\n   * @return {Request}\r\n   */\r\n\r\n  replaceOutput (name, type, value) {\r\n    delete this.parameters[name]\r\n\r\n    return this.output(name, type, value)\r\n  }\r\n\r\n  /**\r\n   * Execute the SQL batch.\r\n   *\r\n   * @param {String} batch T-SQL batch to be executed.\r\n   * @param {Request~requestCallback} [callback] A callback which is called after execution has completed, or an error has occurred. If omited, method returns Promise.\r\n   * @return {Request|Promise}\r\n   */\r\n\r\n  batch (batch, callback) {\r\n    if (this.stream == null && this.connection) this.stream = this.connection.config.stream\r\n    this.rowsAffected = 0\r\n\r\n    if (typeof callback === 'function') {\r\n      this._batch(batch, (err, recordsets, output, rowsAffected) => {\r\n        if (this.stream) {\r\n          if (err) this.emit('error', err)\r\n          err = null\r\n\r\n          this.emit('done', {\r\n            output,\r\n            rowsAffected\r\n          })\r\n        }\r\n\r\n        if (err) return callback(err)\r\n        callback(null, {\r\n          recordsets,\r\n          recordset: recordsets && recordsets[0],\r\n          output,\r\n          rowsAffected\r\n        })\r\n      })\r\n      return this\r\n    }\r\n\r\n    // Check is method was called as tagged template\r\n    if (typeof batch === 'object') {\r\n      const values = Array.prototype.slice.call(arguments)\r\n      const strings = values.shift()\r\n      batch = this._template(strings, values)\r\n    }\r\n\r\n    return new shared.Promise((resolve, reject) => {\r\n      this._batch(batch, (err, recordsets, output, rowsAffected) => {\r\n        if (this.stream) {\r\n          if (err) this.emit('error', err)\r\n          err = null\r\n\r\n          this.emit('done', {\r\n            output,\r\n            rowsAffected\r\n          })\r\n        }\r\n\r\n        if (err) return reject(err)\r\n        resolve({\r\n          recordsets,\r\n          recordset: recordsets && recordsets[0],\r\n          output,\r\n          rowsAffected\r\n        })\r\n      })\r\n    })\r\n  }\r\n\r\n  /**\r\n   * @private\r\n   * @param {String} batch\r\n   * @param {Request~requestCallback} callback\r\n   */\r\n\r\n  _batch (batch, callback) {\r\n    if (!this.connection) {\r\n      return setImmediate(callback, new RequestError('No connection is specified for that request.', 'ENOCONN'))\r\n    }\r\n\r\n    if (!this.connection.connected) {\r\n      return setImmediate(callback, new ConnectionError('Connection is closed.', 'ECONNCLOSED'))\r\n    }\r\n\r\n    this.canceled = false\r\n    setImmediate(callback)\r\n  }\r\n\r\n  /**\r\n   * Bulk load.\r\n   *\r\n   * @param {Table} table SQL table.\r\n   * @param {object} [options] Options to be passed to the underlying driver (tedious only).\r\n   * @param {Request~bulkCallback} [callback] A callback which is called after bulk load has completed, or an error has occurred. If omited, method returns Promise.\r\n   * @return {Request|Promise}\r\n   */\r\n\r\n  bulk (table, options, callback) {\r\n    if (typeof options === 'function') {\r\n      callback = options\r\n      options = {}\r\n    } else if (typeof options === 'undefined') {\r\n      options = {}\r\n    }\r\n\r\n    if (this.stream == null && this.connection) this.stream = this.connection.config.stream\r\n\r\n    if (this.stream || typeof callback === 'function') {\r\n      this._bulk(table, options, (err, rowsAffected) => {\r\n        if (this.stream) {\r\n          if (err) this.emit('error', err)\r\n          return this.emit('done', {\r\n            rowsAffected\r\n          })\r\n        }\r\n\r\n        if (err) return callback(err)\r\n        callback(null, {\r\n          rowsAffected\r\n        })\r\n      })\r\n      return this\r\n    }\r\n\r\n    return new shared.Promise((resolve, reject) => {\r\n      this._bulk(table, options, (err, rowsAffected) => {\r\n        if (err) return reject(err)\r\n        resolve({\r\n          rowsAffected\r\n        })\r\n      })\r\n    })\r\n  }\r\n\r\n  /**\r\n   * @private\r\n   * @param {Table} table\r\n   * @param {object} options\r\n   * @param {Request~bulkCallback} callback\r\n   */\r\n\r\n  _bulk (table, options, callback) {\r\n    if (!this.parent) {\r\n      return setImmediate(callback, new RequestError('No connection is specified for that request.', 'ENOCONN'))\r\n    }\r\n\r\n    if (!this.parent.connected) {\r\n      return setImmediate(callback, new ConnectionError('Connection is closed.', 'ECONNCLOSED'))\r\n    }\r\n\r\n    this.canceled = false\r\n    setImmediate(callback)\r\n  }\r\n\r\n  /**\r\n   * Sets request to `stream` mode and pulls all rows from all recordsets to a given stream.\r\n   *\r\n   * @param {Stream} stream Stream to pipe data into.\r\n   * @return {Stream}\r\n   */\r\n\r\n  pipe (stream) {\r\n    this.stream = true\r\n    this.on('row', stream.write.bind(stream))\r\n    this.on('error', stream.emit.bind(stream, 'error'))\r\n    this.on('done', () => {\r\n      setImmediate(() => stream.end())\r\n    })\r\n    stream.emit('pipe', this)\r\n    return stream\r\n  }\r\n\r\n  /**\r\n   * Execute the SQL command.\r\n   *\r\n   * @param {String} command T-SQL command to be executed.\r\n   * @param {Request~requestCallback} [callback] A callback which is called after execution has completed, or an error has occurred. If omited, method returns Promise.\r\n   * @return {Request|Promise}\r\n   */\r\n\r\n  query (command, callback) {\r\n    if (this.stream == null && this.connection) this.stream = this.connection.config.stream\r\n    this.rowsAffected = 0\r\n\r\n    if (typeof callback === 'function') {\r\n      this._query(command, (err, recordsets, output, rowsAffected) => {\r\n        if (this.stream) {\r\n          if (err) this.emit('error', err)\r\n          err = null\r\n\r\n          this.emit('done', {\r\n            output,\r\n            rowsAffected\r\n          })\r\n        }\r\n\r\n        if (err) return callback(err)\r\n        callback(null, {\r\n          recordsets,\r\n          recordset: recordsets && recordsets[0],\r\n          output,\r\n          rowsAffected\r\n        })\r\n      })\r\n      return this\r\n    }\r\n\r\n    // Check is method was called as tagged template\r\n    if (typeof command === 'object') {\r\n      const values = Array.prototype.slice.call(arguments)\r\n      const strings = values.shift()\r\n      command = this._template(strings, values)\r\n    }\r\n\r\n    return new shared.Promise((resolve, reject) => {\r\n      this._query(command, (err, recordsets, output, rowsAffected) => {\r\n        if (this.stream) {\r\n          if (err) this.emit('error', err)\r\n          err = null\r\n\r\n          this.emit('done', {\r\n            output,\r\n            rowsAffected\r\n          })\r\n        }\r\n\r\n        if (err) return reject(err)\r\n        resolve({\r\n          recordsets,\r\n          recordset: recordsets && recordsets[0],\r\n          output,\r\n          rowsAffected\r\n        })\r\n      })\r\n    })\r\n  }\r\n\r\n  /**\r\n   * @private\r\n   * @param {String} command\r\n   * @param {Request~bulkCallback} callback\r\n   */\r\n\r\n  _query (command, callback) {\r\n    if (!this.parent) {\r\n      return setImmediate(callback, new RequestError('No connection is specified for that request.', 'ENOCONN'))\r\n    }\r\n\r\n    if (!this.parent.connected) {\r\n      return setImmediate(callback, new ConnectionError('Connection is closed.', 'ECONNCLOSED'))\r\n    }\r\n\r\n    this.canceled = false\r\n    setImmediate(callback)\r\n  }\r\n\r\n  /**\r\n   * Call a stored procedure.\r\n   *\r\n   * @param {String} procedure Name of the stored procedure to be executed.\r\n   * @param {Request~requestCallback} [callback] A callback which is called after execution has completed, or an error has occurred. If omited, method returns Promise.\r\n   * @return {Request|Promise}\r\n   */\r\n\r\n  execute (command, callback) {\r\n    if (this.stream == null && this.connection) this.stream = this.connection.config.stream\r\n    this.rowsAffected = 0\r\n\r\n    if (typeof callback === 'function') {\r\n      this._execute(command, (err, recordsets, output, returnValue, rowsAffected) => {\r\n        if (this.stream) {\r\n          if (err) this.emit('error', err)\r\n          err = null\r\n\r\n          this.emit('done', {\r\n            output,\r\n            rowsAffected,\r\n            returnValue\r\n          })\r\n        }\r\n\r\n        if (err) return callback(err)\r\n        callback(null, {\r\n          recordsets,\r\n          recordset: recordsets && recordsets[0],\r\n          output,\r\n          rowsAffected,\r\n          returnValue\r\n        })\r\n      })\r\n      return this\r\n    }\r\n\r\n    return new shared.Promise((resolve, reject) => {\r\n      this._execute(command, (err, recordsets, output, returnValue, rowsAffected) => {\r\n        if (this.stream) {\r\n          if (err) this.emit('error', err)\r\n          err = null\r\n\r\n          this.emit('done', {\r\n            output,\r\n            rowsAffected,\r\n            returnValue\r\n          })\r\n        }\r\n\r\n        if (err) return reject(err)\r\n        resolve({\r\n          recordsets,\r\n          recordset: recordsets && recordsets[0],\r\n          output,\r\n          rowsAffected,\r\n          returnValue\r\n        })\r\n      })\r\n    })\r\n  }\r\n\r\n  /**\r\n   * @private\r\n   * @param {String} procedure\r\n   * @param {Request~bulkCallback} callback\r\n   */\r\n\r\n  _execute (procedure, callback) {\r\n    if (!this.parent) {\r\n      return setImmediate(callback, new RequestError('No connection is specified for that request.', 'ENOCONN'))\r\n    }\r\n\r\n    if (!this.parent.connected) {\r\n      return setImmediate(callback, new ConnectionError('Connection is closed.', 'ECONNCLOSED'))\r\n    }\r\n\r\n    this.canceled = false\r\n    setImmediate(callback)\r\n  }\r\n\r\n  /**\r\n   * Cancel currently executed request.\r\n   *\r\n   * @return {Boolean}\r\n   */\r\n\r\n  cancel () {\r\n    this._cancel()\r\n    return true\r\n  }\r\n\r\n  /**\r\n   * @private\r\n   */\r\n\r\n  _cancel () {\r\n    this.canceled = true\r\n  }\r\n\r\n  pause () {\r\n    if (this.stream) {\r\n      this._pause()\r\n      return true\r\n    }\r\n    return false\r\n  }\r\n\r\n  _pause () {\r\n    this._paused = true\r\n  }\r\n\r\n  resume () {\r\n    if (this.stream) {\r\n      this._resume()\r\n      return true\r\n    }\r\n    return false\r\n  }\r\n\r\n  _resume () {\r\n    this._paused = false\r\n  }\r\n\r\n  _setCurrentRequest (request) {\r\n    this._currentRequest = request\r\n    if (this._paused) {\r\n      this.pause()\r\n    }\r\n    return this\r\n  }\r\n}\r\n\r\nmodule.exports = Request\r\n"]},"metadata":{},"sourceType":"script"}